#!/bin/bash

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Fonction pour afficher l'ASCII art
show_ascii_art() {
    printf "%bâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—%b\n" "$BLUE" "$NC"
    printf "%bâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•%b\n" "$BLUE" "$NC"
    printf "%bâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• %b\n" "$BLUE" "$NC"
    printf "%bâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— %b\n" "$BLUE" "$NC"
    printf "%bâ–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—%b\n" "$BLUE" "$NC"
    printf "%bâ•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•    â•šâ•â•â•â•šâ•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•%b\n" "$BLUE" "$NC"
    printf "%b â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”â”Œ   â”¬â”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”Œâ”€â”â”¬ â”¬%b\n" "$CYAN" "$NC"
    printf "%b â””â”€â”â”‚  â”œâ”€â”¤â”‚â”‚â”‚   â”œâ”¬â”˜â”œâ”¤ â””â”€â”â”œâ”¤ â”œâ”€â”¤â”‚ â”‚%b\n" "$CYAN" "$NC"
    printf "%b â””â”€â”˜â””â”€â”˜â”´ â”´â”˜â””â”˜   â”´â””â”€â””â”€â”˜â””â”€â”˜â””â”€â”˜â”´ â”´â””â”€â”˜%b\n" "$CYAN" "$NC"
    printf "%b=======================================================================%b\n" "$PURPLE" "$NC"
    printf "%b               DÃ©tection d'Ã©quipements sur le rÃ©seau                  %b\n" "$GREEN" "$NC"
    printf "%b                           par DeusH4ss                               %b\n" "$BLUE" "$NC"
    printf "%b=======================================================================%b\n" "$PURPLE" "$NC"
}

# Afficher l'ASCII art au dÃ©but
show_ascii_art

# Fonction pour convertir un masque en notation CIDR (ex: 255.255.255.0 â†’ /24)
mask_to_prefix() {
    local mask=$1
    local IFS=.
    local -a octets=($mask)
    local binary=""
    for octet in "${octets[@]}"; do
        binary+=$(printf "%08d" "$(bc <<< "obase=2; $octet")")
    done
    echo "${binary//0/}" | wc -c
}

# Fonction pour calculer l'adresse rÃ©seau
ipcalc() {
    IFS=. read -r i1 i2 i3 i4 <<< "$1"
    IFS=. read -r m1 m2 m3 m4 <<< "$2"
    echo "$((i1 & m1)).$((i2 & m2)).$((i3 & m3)).$((i4 & m4))"
}

# Demande Ã  l'utilisateur s'il veut un scan automatique ou manuel
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo " ğŸ” Scan du rÃ©seau "
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1ï¸âƒ£  Scan automatique (dÃ©tection de l'IP et du masque)"
echo "2ï¸âƒ£  Scan manuel (saisie de l'IP et du masque)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
read -p "â¡ï¸  Choisissez une option (1 ou 2) : " choice

# Scan automatique
if [ "$choice" == "1" ]; then
    echo "ğŸ› ï¸  DÃ©tection automatique du rÃ©seau..."
    
    # RÃ©cupÃ©rer l'interface principale
    interface=$(route get default 2>/dev/null | grep 'interface:' | awk '{print $2}')
    if [ -z "$interface" ]; then
        echo "âŒ Impossible de dÃ©tecter l'interface rÃ©seau."
        exit 1
    fi

    # RÃ©cupÃ©rer l'adresse IP de l'interface
    input_ip=$(ipconfig getifaddr "$interface" 2>/dev/null)
    if [ -z "$input_ip" ]; then
        echo "âŒ Impossible de dÃ©tecter l'adresse IP."
        exit 1
    fi

    # RÃ©cupÃ©rer le masque de sous-rÃ©seau
    input_mask=$(ifconfig "$interface" | grep -w "netmask" | awk '{print $4}')
    if [ -z "$input_mask" ]; then
        echo "âŒ Impossible de dÃ©tecter le masque de sous-rÃ©seau."
        exit 1
    fi

    # Convertir le masque hexadÃ©cimal en format standard
    input_mask=$(printf "%d.%d.%d.%d\n" \
        $(( (0x${input_mask:2:2}) )) \
        $(( (0x${input_mask:4:2}) )) \
        $(( (0x${input_mask:6:2}) )) \
        $(( (0x${input_mask:8:2}) )))

# Scan manuel
elif [ "$choice" == "2" ]; then
    echo "ğŸ“ Mode manuel sÃ©lectionnÃ©."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Œ Exemple :"
    echo "  - IP de base : 192.168.42.0"
    echo "  - Masque : 255.255.255.0"
    echo "  - Autre exemple : 169.254.136.208 255.255.0.0"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    read -p "â¡ï¸  Entrez l'IP de base : " input_ip
    read -p "â¡ï¸  Entrez le masque de sous-rÃ©seau : " input_mask
else
    echo "âŒ Option invalide. Veuillez relancer le script."
    exit 1
fi

# VÃ©rifie que les entrÃ©es sont valides (IPV4 et masque corrects)
if [[ ! "$input_ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "âŒ Format IP invalide. Exemple : 192.168.1.0"
    exit 1
fi
if [[ ! "$input_mask" =~ ^(255\.(255|254|252|248|240|224|192|128|0)\.0\.0|255\.255\.(255|254|252|248|240|224|192|128|0)\.0|255\.255\.255\.(255|254|252|248|240|224|192|128|0))$ ]]; then
    echo "âŒ Format de masque invalide. Exemple : 255.255.255.0"
    exit 1
fi

# Convertir le masque en prÃ©fixe (ex: 255.255.255.0 â†’ /24)
prefix=$(mask_to_prefix "$input_mask")

# Calcul de l'adresse rÃ©seau
network_ip=$(ipcalc "$input_ip" "$input_mask")

# DÃ©termine la plage d'adresses
IFS=. read -r n1 n2 n3 n4 <<< "$network_ip"
IFS=. read -r m1 m2 m3 m4 <<< "$input_mask"
host_min=$(( (256 + n4 + 1) % 256 ))  # PremiÃ¨re IP utilisable
host_max=$(( (n4 | (255 - m4)) - 1 )) # DerniÃ¨re IP utilisable

echo -e "${BLUE}ğŸ“¡ Scan en cours sur $network_ip/$prefix...${NC}"
for i in $(seq "$host_min" "$host_max"); do
    ip="$n1.$n2.$n3.$i"
    if ping -c 1 -t 1 "$ip" &>/dev/null; then
        echo -e "${GREEN}âœ… RÃ©pond : $ip${NC}"
    fi &
done

wait
echo -e "${GREEN}âœ… Scan terminÃ©.${NC}"
