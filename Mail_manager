#!/bin/bash
# Iron4Software Mail Manager - Version minimale corrigée

echo "=== Iron4Software Mail Manager Minimal ==="

while true; do
  clear
  echo ""
  echo "╔════════════════════════════════════╗"
  echo "║  Iron4Software Mail Manager       ║"
  echo "╚════════════════════════════════════╝"
  echo ""
  echo "1) Créer un utilisateur"
  echo "2) Lister les utilisateurs"  
  echo "3) Créer les 26 utilisateurs Iron4Software"
  echo "4) Réparer les permissions"
  echo "5) Quitter"
  echo ""
  read -p "Choix: " c
  
  case $c in
    1) 
      echo ""
      read -p "Username: " u
      read -sp "Password: " p
      echo ""
      read -p "Nom: " nom
      read -p "Prénom: " prenom
      
      useradd -m -c "$prenom $nom" "$u"
      echo "$u:$p" | chpasswd
      usermod -aG mail "$u"
      touch "/var/mail/$u"
      chown "$u:mail" "/var/mail/$u"
      chmod 660 "/var/mail/$u"
      
      echo ""
      echo "✓ Utilisateur $u créé avec boîte mail"
      echo ""
      read -p "Appuyer sur Entrée pour continuer..."
      ;;
      
    2)
      echo ""
      echo "═══ Utilisateurs avec boîte mail ═══"
      echo ""
      for mailfile in /var/mail/*; do
        if [ -f "$mailfile" ]; then
          username=$(basename "$mailfile")
          if [ "$username" != "root" ]; then
            fullname=$(getent passwd "$username" | cut -d: -f5 | cut -d, -f1)
            if [ -n "$fullname" ]; then
              echo "✓ $username ($fullname)"
            else
              echo "✓ $username"
            fi
          fi
        fi
      done
      echo ""
      read -p "Appuyer sur Entrée pour continuer..."
      ;;
      
    3)
      echo ""
      echo "═══ Création des 26 utilisateurs Iron4Software ═══"
      echo ""
      
      # Direction
      useradd -m -c "Elise Moreau" emoreau 2>/dev/null
      echo 'emoreau:password123' | chpasswd
      usermod -aG mail emoreau
      touch /var/mail/emoreau
      chown emoreau:mail /var/mail/emoreau
      chmod 660 /var/mail/emoreau
      echo "✓ emoreau (Elise Moreau)"
      
      useradd -m -c "Thomas Roussel" troussel 2>/dev/null
      echo 'troussel:password123' | chpasswd
      usermod -aG mail troussel
      touch /var/mail/troussel
      chown troussel:mail /var/mail/troussel
      chmod 660 /var/mail/troussel
      echo "✓ troussel (Thomas Roussel)"
      
      useradd -m -c "Marion Chevreau" mchevreau 2>/dev/null
      echo 'mchevreau:password123' | chpasswd
      usermod -aG mail mchevreau
      touch /var/mail/mchevreau
      chown mchevreau:mail /var/mail/mchevreau
      chmod 660 /var/mail/mchevreau
      echo "✓ mchevreau (Marion Chevreau)"
      
      # Secrétariat
      useradd -m -c "Sophie Beranger" sberanger 2>/dev/null
      echo 'sberanger:Sosol982' | chpasswd
      usermod -aG mail sberanger
      touch /var/mail/sberanger
      chown sberanger:mail /var/mail/sberanger
      chmod 660 /var/mail/sberanger
      echo "✓ sberanger (Sophie Beranger)"
      
      useradd -m -c "Benjamin Colin" bcolin 2>/dev/null
      echo 'bcolin:password123' | chpasswd
      usermod -aG mail bcolin
      touch /var/mail/bcolin
      chown bcolin:mail /var/mail/bcolin
      chmod 660 /var/mail/bcolin
      echo "✓ bcolin (Benjamin Colin)"
      
      # Comptabilité
      useradd -m -c "Nina Lefevre" nlefevre 2>/dev/null
      echo 'nlefevre:password123' | chpasswd
      usermod -aG mail nlefevre
      touch /var/mail/nlefevre
      chown nlefevre:mail /var/mail/nlefevre
      chmod 660 /var/mail/nlefevre
      echo "✓ nlefevre (Nina Lefevre)"
      
      useradd -m -c "Julien Morel" jmorel 2>/dev/null
      echo 'jmorel:password123' | chpasswd
      usermod -aG mail jmorel
      touch /var/mail/jmorel
      chown jmorel:mail /var/mail/jmorel
      chmod 660 /var/mail/jmorel
      echo "✓ jmorel (Julien Morel)"
      
      useradd -m -c "Camille Roche" croche 2>/dev/null
      echo 'croche:password123' | chpasswd
      usermod -aG mail croche
      touch /var/mail/croche
      chown croche:mail /var/mail/croche
      chmod 660 /var/mail/croche
      echo "✓ croche (Camille Roche)"
      
      # Vente
      useradd -m -c "Yanis Langlois" ylanglois 2>/dev/null
      echo 'ylanglois:password123' | chpasswd
      usermod -aG mail ylanglois
      touch /var/mail/ylanglois
      chown ylanglois:mail /var/mail/ylanglois
      chmod 660 /var/mail/ylanglois
      echo "✓ ylanglois (Yanis Langlois)"
      
      useradd -m -c "Sarah Villedieu" svilledieu 2>/dev/null
      echo 'svilledieu:password123' | chpasswd
      usermod -aG mail svilledieu
      touch /var/mail/svilledieu
      chown svilledieu:mail /var/mail/svilledieu
      chmod 660 /var/mail/svilledieu
      echo "✓ svilledieu (Sarah Villedieu)"
      
      useradd -m -c "Loic Bernard" lbernard 2>/dev/null
      echo 'lbernard:password123' | chpasswd
      usermod -aG mail lbernard
      touch /var/mail/lbernard
      chown lbernard:mail /var/mail/lbernard
      chmod 660 /var/mail/lbernard
      echo "✓ lbernard (Loic Bernard)"
      
      # IT
      useradd -m -c "Karim Delaunay" kdelaunay 2>/dev/null
      echo 'kdelaunay:password123' | chpasswd
      usermod -aG mail kdelaunay
      touch /var/mail/kdelaunay
      chown kdelaunay:mail /var/mail/kdelaunay
      chmod 660 /var/mail/kdelaunay
      echo "✓ kdelaunay (Karim Delaunay)"
      
      useradd -m -c "Jules Caron" jcaron 2>/dev/null
      echo 'jcaron:password123' | chpasswd
      usermod -aG mail jcaron
      touch /var/mail/jcaron
      chown jcaron:mail /var/mail/jcaron
      chmod 660 /var/mail/jcaron
      echo "✓ jcaron (Jules Caron)"
      
      useradd -m -c "Guillaume Porte" gporte 2>/dev/null
      echo 'gporte:guillaume123' | chpasswd
      usermod -aG mail gporte
      touch /var/mail/gporte
      chown gporte:mail /var/mail/gporte
      chmod 660 /var/mail/gporte
      echo "✓ gporte (Guillaume Porte)"
      
      useradd -m -c "Anais Duval" aduval 2>/dev/null
      echo 'aduval:password123' | chpasswd
      usermod -aG mail aduval
      touch /var/mail/aduval
      chown aduval:mail /var/mail/aduval
      chmod 660 /var/mail/aduval
      echo "✓ aduval (Anais Duval)"
      
      useradd -m -c "Lucas Benelli" lbenelli 2>/dev/null
      echo 'lbenelli:password123' | chpasswd
      usermod -aG mail lbenelli
      touch /var/mail/lbenelli
      chown lbenelli:mail /var/mail/lbenelli
      chmod 660 /var/mail/lbenelli
      echo "✓ lbenelli (Lucas Benelli)"
      
      useradd -m -c "Bruno Hernandez" bhernandez 2>/dev/null
      echo 'bhernandez:21031988' | chpasswd
      usermod -aG mail bhernandez
      touch /var/mail/bhernandez
      chown bhernandez:mail /var/mail/bhernandez
      chmod 660 /var/mail/bhernandez
      echo "✓ bhernandez (Bruno Hernandez)"
      
      useradd -m -c "Pierre Lejuste" plejuste 2>/dev/null
      echo 'plejuste:password123' | chpasswd
      usermod -aG mail plejuste
      touch /var/mail/plejuste
      chown plejuste:mail /var/mail/plejuste
      chmod 660 /var/mail/plejuste
      echo "✓ plejuste (Pierre Lejuste)"
      
      useradd -m -c "Noe Charlier" ncharlier 2>/dev/null
      echo 'ncharlier:password123' | chpasswd
      usermod -aG mail ncharlier
      touch /var/mail/ncharlier
      chown ncharlier:mail /var/mail/ncharlier
      chmod 660 /var/mail/ncharlier
      echo "✓ ncharlier (Noe Charlier)"
      
      useradd -m -c "Ines Gauthier" igauthier 2>/dev/null
      echo 'igauthier:password123' | chpasswd
      usermod -aG mail igauthier
      touch /var/mail/igauthier
      chown igauthier:mail /var/mail/igauthier
      chmod 660 /var/mail/igauthier
      echo "✓ igauthier (Ines Gauthier)"
      
      useradd -m -c "Victor Renard" vrenard 2>/dev/null
      echo 'vrenard:password123' | chpasswd
      usermod -aG mail vrenard
      touch /var/mail/vrenard
      chown vrenard:mail /var/mail/vrenard
      chmod 660 /var/mail/vrenard
      echo "✓ vrenard (Victor Renard)"
      
      useradd -m -c "Adrien Lemoine" alemoine 2>/dev/null
      echo 'alemoine:password123' | chpasswd
      usermod -aG mail alemoine
      touch /var/mail/alemoine
      chown alemoine:mail /var/mail/alemoine
      chmod 660 /var/mail/alemoine
      echo "✓ alemoine (Adrien Lemoine)"
      
      useradd -m -c "Rayan Lefort" rlefort 2>/dev/null
      echo 'rlefort:password123' | chpasswd
      usermod -aG mail rlefort
      touch /var/mail/rlefort
      chown rlefort:mail /var/mail/rlefort
      chmod 660 /var/mail/rlefort
      echo "✓ rlefort (Rayan Lefort)"
      
      useradd -m -c "Emile Baron" ebaron 2>/dev/null
      echo 'ebaron:password123' | chpasswd
      usermod -aG mail ebaron
      touch /var/mail/ebaron
      chown ebaron:mail /var/mail/ebaron
      chmod 660 /var/mail/ebaron
      echo "✓ ebaron (Emile Baron)"
      
      useradd -m -c "Maya Bourdon" mbourdon 2>/dev/null
      echo 'mbourdon:password123' | chpasswd
      usermod -aG mail mbourdon
      touch /var/mail/mbourdon
      chown mbourdon:mail /var/mail/mbourdon
      chmod 660 /var/mail/mbourdon
      echo "✓ mbourdon (Maya Bourdon)"
      
      echo ""
      echo "✓ 26 utilisateurs Iron4Software créés !"
      echo ""
      read -p "Appuyer sur Entrée pour continuer..."
      ;;
      
    4)
      echo ""
      echo "═══ Réparation des permissions ═══"
      echo ""
      
      # Réparer /var/mail
      chmod 775 /var/mail
      chown root:mail /var/mail
      echo "✓ Permissions /var/mail corrigées"
      
      # Réparer les boîtes mail individuelles
      for mailfile in /var/mail/*; do
        if [ -f "$mailfile" ]; then
          username=$(basename "$mailfile")
          if [ "$username" != "root" ] && id "$username" &>/dev/null; then
            chown "$username:mail" "$mailfile"
            chmod 660 "$mailfile"
            echo "✓ $mailfile"
          fi
        fi
      done
      
      # Vérifier dovecot dans groupe mail
      if ! groups dovecot 2>/dev/null | grep -q mail; then
        usermod -aG mail dovecot
        echo "✓ dovecot ajouté au groupe mail"
      fi
      
      systemctl restart dovecot 2>/dev/null
      echo "✓ Dovecot redémarré"
      
      echo ""
      read -p "Appuyer sur Entrée pour continuer..."
      ;;
      
    5) 
      echo ""
      echo "Au revoir !"
      exit 0
      ;;
      
    *)
      echo ""
      echo "Choix invalide"
      sleep 1
      ;;
  esac
done
