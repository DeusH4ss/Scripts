#!/bin/bash

#############################################
# Script de gestion du serveur mail
# Iron4Software Lab - Cybersecurity Training
#############################################

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

DOMAIN="iron4software.local"
MAIL_SERVER="mail.iron4software.local"

# Configuration Active Directory
AD_ENABLED=false
AD_SERVER="ws-g4.ironsoft.local"
AD_DOMAIN="ironsoft.local"
AD_ADMIN="administrateur"
AD_BASE_OU="OU=Users,DC=ironsoft,DC=local"
AD_DEFAULT_PASSWORD_POLICY=true

# Banner
echo -e "${BLUE}"
echo "================================================"
echo "   Iron4Software - Mail Server Manager"
echo "================================================"
echo -e "${NC}"

#############################################
# Fonction : V√©rifier si root
#############################################
check_root() {
    if [ "$EUID" -ne 0 ]; then 
        echo -e "${RED}[‚úó] Ce script doit √™tre ex√©cut√© en tant que root${NC}"
        echo "Utilise: sudo $0"
        exit 1
    fi
}

#############################################
# Fonction : V√©rifier les services
#############################################
check_services() {
    echo -e "\n${BLUE}[INFO] V√©rification des services...${NC}"
    
    services=("postfix" "dovecot" "apache2")
    all_ok=true
    
    for service in "${services[@]}"; do
        if systemctl is-active --quiet "$service"; then
            echo -e "${GREEN}[‚úì] $service : actif${NC}"
        else
            echo -e "${RED}[‚úó] $service : inactif${NC}"
            all_ok=false
        fi
    done
    
    if [ "$all_ok" = false ]; then
        echo -e "${YELLOW}[!] Certains services ne sont pas actifs${NC}"
        read -p "D√©marrer les services manquants ? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            for service in "${services[@]}"; do
                if ! systemctl is-active --quiet "$service"; then
                    systemctl start "$service"
                    echo -e "${GREEN}[‚úì] $service d√©marr√©${NC}"
                fi
            done
        fi
    fi
}

#############################################
# Fonction : V√©rifier la configuration
#############################################
check_config() {
    echo -e "\n${BLUE}[INFO] V√©rification de la configuration...${NC}"
    
    # V√©rifier Postfix
    echo -e "\n${YELLOW}=== Postfix Configuration ===${NC}"
    postconf -n | grep -E "myhostname|mydomain|mynetworks|inet_interfaces" || echo -e "${RED}[‚úó] Config Postfix incompl√®te${NC}"
    
    # V√©rifier Dovecot
    echo -e "\n${YELLOW}=== Dovecot Configuration ===${NC}"
    doveconf mail_location ssl protocols
    
    # V√©rifier les ports
    echo -e "\n${YELLOW}=== Ports en √©coute ===${NC}"
    netstat -tlnp | grep -E "(:25|:143|:993|:587|:80)" | grep -E "(postfix|dovecot|apache)" || echo -e "${RED}[‚úó] Ports mail non configur√©s${NC}"
    
    # V√©rifier les certificats SSL
    echo -e "\n${YELLOW}=== Certificats SSL ===${NC}"
    if [ -f "/etc/ssl/certs/mail.iron4software.crt" ]; then
        echo -e "${GREEN}[‚úì] Certificat trouv√©${NC}"
        openssl x509 -in /etc/ssl/certs/mail.iron4software.crt -noout -subject -dates
    else
        echo -e "${RED}[‚úó] Certificat non trouv√©${NC}"
    fi
    
    # V√©rifier le groupe mail
    echo -e "\n${YELLOW}=== Groupe mail ===${NC}"
    if groups dovecot | grep -q mail; then
        echo -e "${GREEN}[‚úì] dovecot est dans le groupe mail${NC}"
    else
        echo -e "${RED}[‚úó] dovecot n'est PAS dans le groupe mail${NC}"
        read -p "Ajouter dovecot au groupe mail ? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            usermod -aG mail dovecot
            systemctl restart dovecot
            echo -e "${GREEN}[‚úì] dovecot ajout√© au groupe mail et service red√©marr√©${NC}"
        fi
    fi
}

#############################################
# Fonction : Cr√©er un utilisateur
#############################################
create_user() {
    echo -e "\n${BLUE}[INFO] Cr√©ation d'un nouvel utilisateur mail${NC}"
    
    read -p "Nom d'utilisateur : " username
    
    # V√©rifier si l'utilisateur existe d√©j√†
    if id "$username" &>/dev/null; then
        echo -e "${YELLOW}[!] L'utilisateur $username existe d√©j√†${NC}"
        read -p "R√©initialiser le mot de passe ? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            return
        fi
    else
        # Cr√©er l'utilisateur
        useradd -m -s /bin/bash "$username"
        echo -e "${GREEN}[‚úì] Utilisateur $username cr√©√©${NC}"
    fi
    
    # D√©finir le mot de passe
    echo -e "\n${YELLOW}Options de mot de passe :${NC}"
    echo "1) Mot de passe simple (password)"
    echo "2) Mot de passe faible personnalis√© (pour bruteforce)"
    echo "3) Mot de passe fort personnalis√©"
    read -p "Choix (1-3) : " pass_choice
    
    case $pass_choice in
        1)
            password="password"
            echo -e "${YELLOW}[!] Mot de passe d√©fini : password${NC}"
            ;;
        2)
            read -p "Mot de passe faible (ex: user123) : " password
            ;;
        3)
            read -sp "Mot de passe fort : " password
            echo
            ;;
        *)
            password="password"
            echo -e "${YELLOW}[!] Choix invalide, utilisation de 'password'${NC}"
            ;;
    esac
    
    # D√©finir le mot de passe (utiliser printf pour √©viter les probl√®mes d'√©chappement)
    printf "%s:%s\n" "$username" "$password" | chpasswd
    
    # Cr√©er la bo√Æte mail
    touch "/var/mail/$username"
    chown "$username:mail" "/var/mail/$username"
    chmod 660 "/var/mail/$username"
    
    echo -e "${GREEN}[‚úì] Bo√Æte mail cr√©√©e pour $username${NC}"
    echo -e "${GREEN}[‚úì] Email : $username@$DOMAIN${NC}"
    echo -e "${GREEN}[‚úì] Mot de passe : $password${NC}"
    
    # Test de connexion
    echo -e "\n${YELLOW}[TEST] Test de connexion IMAP...${NC}"
    test_imap_login "$username" "$password"
}

#############################################
# Fonction : Lister les utilisateurs mail
#############################################
list_users() {
    echo -e "\n${BLUE}[INFO] Utilisateurs mail configur√©s :${NC}"
    echo -e "${YELLOW}----------------------------------------${NC}"
    
    for mailfile in /var/mail/*; do
        if [ -f "$mailfile" ]; then
            username=$(basename "$mailfile")
            if [ "$username" != "root" ] && id "$username" &>/dev/null; then
                size=$(du -h "$mailfile" | cut -f1)
                perms=$(ls -lh "$mailfile" | awk '{print $1, $3":"$4}')
                local full_name=$(getent passwd "$username" | cut -d: -f5 | cut -d, -f1)
                
                echo -e "${GREEN}$username@$DOMAIN${NC}"
                if [ -n "$full_name" ]; then
                    echo "  Nom     : $full_name"
                    
                    # Afficher l'alias s'il existe
                    local prenom=$(echo "$full_name" | cut -d' ' -f1)
                    local nom=$(echo "$full_name" | cut -d' ' -f2-)
                    if [ -n "$prenom" ] && [ -n "$nom" ] && [ "$prenom" != "$nom" ]; then
                        local prenom_clean=$(echo "$prenom" | tr '[:upper:]' '[:lower:]' | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || echo "$prenom" | tr '[:upper:]' '[:lower:]')
                        local nom_clean=$(echo "$nom" | tr '[:upper:]' '[:lower:]' | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || echo "$nom" | tr '[:upper:]' '[:lower:]')
                        echo "  Alias   : ${prenom_clean}.${nom_clean}@$DOMAIN"
                    fi
                fi
                echo "  Fichier : $mailfile"
                echo "  Taille  : $size"
                echo "  Perms   : $perms"
                echo ""
            fi
        fi
    done
    
    echo ""
    echo -e "${BLUE}[INFO] Alias mail configur√©s :${NC}"
    echo -e "${YELLOW}----------------------------------------${NC}"
    
    if [ -f /etc/postfix/virtual ]; then
        local alias_count=$(grep -c "@${DOMAIN}" /etc/postfix/virtual 2>/dev/null || echo "0")
        if [ "$alias_count" -gt 0 ]; then
            grep "@${DOMAIN}" /etc/postfix/virtual | while IFS= read -r line; do
                echo "  ‚Üí $line"
            done
        else
            echo "  (Aucun alias configur√©)"
        fi
    else
        echo "  (Fichier virtual non trouv√©)"
    fi
    
    echo ""
}

#############################################
# Fonction : Tester l'authentification IMAP
#############################################
test_imap_login() {
    local user=$1
    local pass=$2
    
    # Test via telnet avec expect-like behavior
    result=$(timeout 5 bash -c "
        exec 3<>/dev/tcp/localhost/143
        cat <&3 &
        echo 'a1 LOGIN $user $pass' >&3
        sleep 1
        echo 'a2 LOGOUT' >&3
        sleep 1
    " 2>&1 | grep -i "OK")
    
    if echo "$result" | grep -q "OK"; then
        echo -e "${GREEN}[‚úì] Authentification IMAP r√©ussie pour $user${NC}"
    else
        echo -e "${RED}[‚úó] √âchec d'authentification IMAP pour $user${NC}"
        echo "V√©rifier les logs : sudo tail /var/log/mail.log"
    fi
}

#############################################
# Fonction : R√©parer les permissions
#############################################
fix_permissions() {
    echo -e "\n${BLUE}[INFO] R√©paration des permissions...${NC}"
    
    # R√©parer /var/mail
    chmod 775 /var/mail
    chown root:mail /var/mail
    echo -e "${GREEN}[‚úì] Permissions /var/mail corrig√©es${NC}"
    
    # R√©parer les bo√Ætes mail individuelles
    for mailfile in /var/mail/*; do
        if [ -f "$mailfile" ]; then
            username=$(basename "$mailfile")
            if [ "$username" != "root" ] && id "$username" &>/dev/null; then
                chown "$username:mail" "$mailfile"
                chmod 660 "$mailfile"
                echo -e "${GREEN}[‚úì] Permissions corrig√©es : $mailfile${NC}"
            fi
        fi
    done
    
    # V√©rifier dovecot dans groupe mail
    if ! groups dovecot | grep -q mail; then
        usermod -aG mail dovecot
        echo -e "${GREEN}[‚úì] dovecot ajout√© au groupe mail${NC}"
    fi
    
    systemctl restart dovecot
    echo -e "${GREEN}[‚úì] Dovecot red√©marr√©${NC}"
}

#############################################
# Fonction : R√©g√©n√©rer tous les alias mail
#############################################
regenerate_all_aliases() {
    echo -e "\n${BLUE}[INFO] R√©g√©n√©ration des alias mail${NC}\n"
    
    local alias_file="/etc/postfix/virtual"
    
    # Sauvegarder l'ancien fichier
    if [ -f "$alias_file" ]; then
        cp "$alias_file" "${alias_file}.backup.$(date +%Y%m%d_%H%M%S)"
        echo -e "${YELLOW}[!] Sauvegarde cr√©√©e${NC}"
    fi
    
    # Cr√©er un nouveau fichier vide
    echo "# Alias virtuels pour Iron4Software" > "$alias_file"
    echo "# Format: prenom.nom@domain    username" >> "$alias_file"
    echo "# G√©n√©r√© automatiquement le $(date)" >> "$alias_file"
    echo "" >> "$alias_file"
    
    # Configurer Postfix
    configure_virtual_aliases
    
    local count=0
    
    # Parcourir tous les utilisateurs avec bo√Æte mail
    for username in $(ls /var/mail/ 2>/dev/null | grep -v "^root$"); do
        if id "$username" &>/dev/null; then
            # R√©cup√©rer le GECOS (nom complet)
            local full_name=$(getent passwd "$username" | cut -d: -f5 | cut -d, -f1)
            
            if [ -n "$full_name" ]; then
                # Extraire pr√©nom et nom
                local prenom=$(echo "$full_name" | cut -d' ' -f1)
                local nom=$(echo "$full_name" | cut -d' ' -f2-)
                
                if [ -n "$prenom" ] && [ -n "$nom" ] && [ "$prenom" != "$nom" ]; then
                    # Normaliser
                    local prenom_clean=$(echo "$prenom" | tr '[:upper:]' '[:lower:]' | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || echo "$prenom" | tr '[:upper:]' '[:lower:]')
                    local nom_clean=$(echo "$nom" | tr '[:upper:]' '[:lower:]' | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || echo "$nom" | tr '[:upper:]' '[:lower:]')
                    
                    # Ajouter directement au fichier
                    echo "${prenom_clean}.${nom_clean}@${DOMAIN}    ${username}" >> "$alias_file"
                    echo -e "${GREEN}[‚úì] ${prenom_clean}.${nom_clean}@${DOMAIN} ‚Üí ${username}${NC}"
                    count=$((count + 1))
                fi
            fi
        fi
    done
    
    # Mettre √† jour la base de donn√©es Postfix
    postmap "$alias_file" 2>/dev/null
    systemctl reload postfix 2>/dev/null
    
    echo ""
    echo -e "${GREEN}[‚úì] $count alias r√©g√©n√©r√©s${NC}"
    echo ""
    echo "Fichier : $alias_file"
    echo ""
    echo "Commandes utiles :"
    echo "  - Voir les alias : cat /etc/postfix/virtual"
    echo "  - Tester un alias : postmap -q prenom.nom@${DOMAIN} /etc/postfix/virtual"
}

#############################################
# Fonction : Configurer Active Directory
#############################################
configure_ad() {
    echo -e "\n${BLUE}[INFO] Configuration Active Directory${NC}"
    
    read -p "Activer la synchronisation AD ? (y/n) : " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        AD_ENABLED=false
        echo -e "${YELLOW}[!] Synchronisation AD d√©sactiv√©e${NC}"
        return
    fi
    
    read -p "Serveur AD (ex: ws-g4.ironsoft.local) : " AD_SERVER
    read -p "Domaine AD (ex: ironsoft.local) : " AD_DOMAIN
    read -p "Utilisateur admin AD (ex: administrateur) : " AD_ADMIN
    read -p "OU de base (ex: OU=Users,DC=ironsoft,DC=local) : " AD_BASE_OU
    
    # Tester la connexion
    echo -e "\n${YELLOW}[INFO] Test de connexion AD...${NC}"
    if check_ad_connection; then
        AD_ENABLED=true
        echo -e "${GREEN}[‚úì] Configuration AD enregistr√©e${NC}"
        
        # Sauvegarder la config
        save_ad_config
    else
        echo -e "${RED}[‚úó] Impossible de se connecter √† AD${NC}"
        AD_ENABLED=false
    fi
}

#############################################
# Fonction : Sauvegarder config AD
#############################################
save_ad_config() {
    local config_file="/etc/mail_manager_ad.conf"
    
    cat > "$config_file" << EOF
AD_ENABLED=$AD_ENABLED
AD_SERVER=$AD_SERVER
AD_DOMAIN=$AD_DOMAIN
AD_ADMIN=$AD_ADMIN
AD_BASE_OU=$AD_BASE_OU
EOF
    
    chmod 600 "$config_file"
    echo -e "${GREEN}[‚úì] Configuration sauvegard√©e dans $config_file${NC}"
}

#############################################
# Fonction : Charger config AD
#############################################
load_ad_config() {
    local config_file="/etc/mail_manager_ad.conf"
    
    if [ -f "$config_file" ]; then
        source "$config_file"
        echo -e "${GREEN}[‚úì] Configuration AD charg√©e${NC}"
    fi
}

#############################################
# Fonction : V√©rifier connexion AD
#############################################
check_ad_connection() {
    echo -e "${YELLOW}[INFO] Test de connexion au contr√¥leur de domaine Windows...${NC}"
    
    # M√©thode 1 : Via LDAP direct (le plus simple et fiable)
    if command -v ldapsearch &> /dev/null; then
        read -sp "Mot de passe AD pour $AD_ADMIN : " ad_pass
        echo
        
        AD_BIND_DN="CN=$AD_ADMIN,CN=Users,DC=${AD_DOMAIN//./,DC=}"
        
        if ldapsearch -x -H "ldap://$AD_SERVER" -D "$AD_BIND_DN" -w "$ad_pass" -b "$AD_BASE_OU" "(objectClass=user)" dn &>/dev/null; then
            echo -e "${GREEN}[‚úì] Connexion AD r√©ussie (LDAP)${NC}"
            AD_PASSWORD="$ad_pass"
            return 0
        else
            echo -e "${YELLOW}[!] √âchec LDAP, test PowerShell...${NC}"
        fi
    else
        echo -e "${YELLOW}[!] ldapsearch non disponible, installer avec: sudo apt-get install ldap-utils${NC}"
    fi
    
    # M√©thode 2 : Via PowerShell remote (universel mais n√©cessite WinRM sur Windows)
    if command -v pwsh &> /dev/null || command -v powershell &> /dev/null; then
        local ps_cmd="pwsh"
        command -v pwsh &> /dev/null || ps_cmd="powershell"
        
        read -sp "Mot de passe AD pour $AD_ADMIN : " ad_pass
        echo
        
        # Test simple de connexion
        if $ps_cmd -Command "
            try {
                \$secpass = ConvertTo-SecureString '$ad_pass' -AsPlainText -Force
                \$cred = New-Object System.Management.Automation.PSCredential('$AD_DOMAIN\\$AD_ADMIN', \$secpass)
                
                Invoke-Command -ComputerName $AD_SERVER -Credential \$cred -ScriptBlock {
                    Get-ADDomain | Out-Null
                } -ErrorAction Stop
                exit 0
            } catch {
                exit 1
            }
        " &>/dev/null; then
            echo -e "${GREEN}[‚úì] Connexion AD r√©ussie (PowerShell)${NC}"
            AD_PASSWORD="$ad_pass"
            return 0
        else
            echo -e "${RED}[‚úó] √âchec PowerShell - v√©rifier WinRM sur $AD_SERVER${NC}"
        fi
    else
        echo -e "${YELLOW}[!] PowerShell non disponible${NC}"
        echo "Installer PowerShell Core : https://docs.microsoft.com/powershell/scripting/install/install-ubuntu"
    fi
    
    echo -e "${RED}[‚úó] Impossible de se connecter √† AD${NC}"
    echo ""
    echo "Solutions :"
    echo "  1. Installer LDAP : sudo apt-get install ldap-utils"
    echo "  2. Installer PowerShell Core sur Linux"
    echo "  3. Activer WinRM sur Windows AD : Enable-PSRemoting -Force"
    return 1
}

#############################################
# Fonction : Cr√©er un groupe Linux
#############################################
create_linux_group() {
    local groupname=$1
    
    if getent group "$groupname" &>/dev/null; then
        echo -e "${YELLOW}[!] Groupe $groupname existe d√©j√†${NC}"
        return 0
    fi
    
    groupadd "$groupname"
    echo -e "${GREEN}[‚úì] Groupe Linux cr√©√© : $groupname${NC}"
}

#############################################
# Fonction : Cr√©er un utilisateur dans AD
#############################################
create_ad_user() {
    local username=$1
    local nom=$2
    local prenom=$3
    local password=$4
    local groupes=$5
    
    if [ "$AD_ENABLED" = false ]; then
        return 0
    fi
    
    local displayname="$prenom $nom"
    local upn="$username@$AD_DOMAIN"
    
    echo -e "${YELLOW}[AD] Cr√©ation de $username dans Active Directory...${NC}"
    
    # M√©thode 1 : PowerShell remote (RECOMMAND√â)
    if command -v pwsh &> /dev/null || command -v powershell &> /dev/null; then
        local ps_cmd="pwsh"
        command -v pwsh &> /dev/null || ps_cmd="powershell"
        
        # Cr√©er l'utilisateur via PowerShell remote
        if $ps_cmd -Command "
            try {
                \$secpass = ConvertTo-SecureString '$password' -AsPlainText -Force
                \$cred = New-Object System.Management.Automation.PSCredential('$AD_DOMAIN\\$AD_ADMIN', (ConvertTo-SecureString '$AD_PASSWORD' -AsPlainText -Force))
                
                Invoke-Command -ComputerName $AD_SERVER -Credential \$cred -ScriptBlock {
                    param(\$uname, \$fname, \$lname, \$dname, \$upn, \$mail, \$pass, \$ou)
                    
                    # V√©rifier si l'utilisateur existe d√©j√†
                    if (Get-ADUser -Filter \"SamAccountName -eq '\$uname'\" -ErrorAction SilentlyContinue) {
                        Write-Host \"Utilisateur existe d√©j√†\"
                        exit 1
                    }
                    
                    # Cr√©er l'utilisateur
                    New-ADUser -Name \$dname \`
                        -GivenName \$fname \`
                        -Surname \$lname \`
                        -SamAccountName \$uname \`
                        -UserPrincipalName \$upn \`
                        -EmailAddress \$mail \`
                        -AccountPassword \$pass \`
                        -Enabled \\\$true \`
                        -Path \$ou \`
                        -ErrorAction Stop
                    
                    exit 0
                } -ArgumentList '$username', '$prenom', '$nom', '$displayname', '$upn', '$username@$DOMAIN', \$secpass, '$AD_BASE_OU' -ErrorAction Stop
                
                exit \$LASTEXITCODE
            } catch {
                Write-Error \$_.Exception.Message
                exit 1
            }
        " &>/dev/null; then
            echo -e "${GREEN}[‚úì] Utilisateur cr√©√© dans AD (PowerShell)${NC}"
            
            # Ajouter aux groupes AD si sp√©cifi√©
            if [ -n "$groupes" ]; then
                IFS=',' read -ra GROUPS <<< "$groupes"
                for group in "${GROUPS[@]}"; do
                    group=$(echo "$group" | xargs)
                    
                    $ps_cmd -Command "
                        \$cred = New-Object System.Management.Automation.PSCredential('$AD_DOMAIN\\$AD_ADMIN', (ConvertTo-SecureString '$AD_PASSWORD' -AsPlainText -Force))
                        Invoke-Command -ComputerName $AD_SERVER -Credential \$cred -ScriptBlock {
                            param(\$uname, \$grp)
                            try {
                                Add-ADGroupMember -Identity \$grp -Members \$uname -ErrorAction Stop
                            } catch {
                                Write-Host \"Groupe \$grp n'existe pas ou erreur\"
                            }
                        } -ArgumentList '$username', '$group'
                    " &>/dev/null
                    
                    if [ $? -eq 0 ]; then
                        echo -e "${GREEN}[‚úì] Ajout√© au groupe AD : $group${NC}"
                    else
                        echo -e "${YELLOW}[!] Groupe AD $group non trouv√© (cr√©er manuellement)${NC}"
                    fi
                done
            fi
            return 0
        else
            echo -e "${YELLOW}[!] √âchec PowerShell, tentative LDAP...${NC}"
        fi
    fi
    
    # M√©thode 2 : LDAP direct
    if command -v ldapadd &> /dev/null; then
        local ldif_file="/tmp/ad_user_$username.ldif"
        local user_dn="CN=$displayname,$AD_BASE_OU"
        
        # Cr√©er le fichier LDIF
        cat > "$ldif_file" << EOF
dn: $user_dn
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: $displayname
sn: $nom
givenName: $prenom
sAMAccountName: $username
userPrincipalName: $upn
mail: $username@$DOMAIN
userAccountControl: 512
EOF
        
        AD_BIND_DN="CN=$AD_ADMIN,CN=Users,DC=${AD_DOMAIN//./,DC=}"
        
        # Ajouter l'utilisateur
        if ldapadd -x -H "ldap://$AD_SERVER" -D "$AD_BIND_DN" -w "$AD_PASSWORD" -f "$ldif_file" &>/dev/null; then
            echo -e "${GREEN}[‚úì] Utilisateur cr√©√© dans AD (LDAP)${NC}"
            
            # D√©finir le mot de passe
            # Note: N√©cessite normalement LDAPS (port 636) en production
            echo -e "${YELLOW}[!] Mot de passe AD : d√©finir manuellement ou via LDAPS${NC}"
            
            rm -f "$ldif_file"
            return 0
        else
            echo -e "${RED}[‚úó] √âchec cr√©ation LDAP${NC}"
        fi
        
        rm -f "$ldif_file"
    fi
    
    echo -e "${RED}[‚úó] √âchec de cr√©ation dans AD${NC}"
    echo "V√©rifier :"
    echo "  - WinRM activ√© sur $AD_SERVER (PowerShell)"
    echo "  - Port LDAP 389 accessible (LDAP)"
    echo "  - Permissions du compte $AD_ADMIN"
    return 1
}

#############################################
# Fonction : Cr√©er plusieurs utilisateurs depuis une liste
#############################################
create_users_from_list() {
    echo -e "\n${BLUE}[INFO] Cr√©ation d'utilisateurs depuis une liste${NC}"
    echo ""
    echo "Format attendu : username,nom,prenom,password,groupes,sync_ad"
    echo "Exemple : jdupont,Dupont,Jean,password123,\"dev,users\",yes"
    echo ""
    echo "Options :"
    echo "1) Importer depuis un fichier CSV"
    echo "2) Saisir interactivement plusieurs utilisateurs"
    echo "3) Retour"
    echo ""
    read -p "Choix : " import_choice
    
    case $import_choice in
        1)
            read -p "Chemin du fichier CSV : " csv_file
            if [ ! -f "$csv_file" ]; then
                echo -e "${RED}[‚úó] Fichier non trouv√© : $csv_file${NC}"
                return
            fi
            
            echo -e "\n${YELLOW}[INFO] Lecture du fichier...${NC}"
            line_count=0
            success_count=0
            
            while IFS=',' read -r username nom prenom password groupes sync_ad || [ -n "$username" ]; do
                # Ignorer les lignes vides et les commentaires
                [[ -z "$username" || "$username" =~ ^#.* ]] && continue
                
                line_count=$((line_count + 1))
                
                # Nettoyer les espaces et guillemets
                username=$(echo "$username" | xargs)
                nom=$(echo "$nom" | xargs)
                prenom=$(echo "$prenom" | xargs)
                password=$(echo "$password" | xargs)
                groupes=$(echo "$groupes" | xargs | tr -d '"')
                sync_ad=$(echo "$sync_ad" | xargs)
                
                if create_single_user "$username" "$nom" "$prenom" "$password" "$groupes" "$sync_ad"; then
                    success_count=$((success_count + 1))
                fi
            done < "$csv_file"
            
            echo -e "\n${GREEN}[‚úì] $success_count/$line_count utilisateurs cr√©√©s avec succ√®s${NC}"
            ;;
            
        2)
            echo -e "\n${YELLOW}[INFO] Saisie interactive (tapez 'fin' pour terminer)${NC}"
            count=0
            
            while true; do
                echo -e "\n${BLUE}--- Utilisateur $((count + 1)) ---${NC}"
                read -p "Username (ou 'fin' pour terminer) : " username
                
                [[ "$username" == "fin" ]] && break
                
                read -p "Nom : " nom
                read -p "Pr√©nom : " prenom
                read -sp "Mot de passe : " password
                echo
                read -p "Groupes (s√©par√©s par virgules, ex: dev,users) : " groupes
                read -p "Synchroniser avec AD ? (y/n) : " -n 1 -r sync_ad
                echo
                
                [[ $sync_ad =~ ^[Yy]$ ]] && sync_ad="yes" || sync_ad="no"
                
                if create_single_user "$username" "$nom" "$prenom" "$password" "$groupes" "$sync_ad"; then
                    count=$((count + 1))
                fi
            done
            
            echo -e "\n${GREEN}[‚úì] $count utilisateurs cr√©√©s${NC}"
            ;;
            
        3)
            return
            ;;
    esac
}

#############################################
# Fonction : Cr√©er un alias mail
#############################################
create_mail_alias() {
    local username=$1
    local prenom=$2
    local nom=$3
    
    # V√©rifier que pr√©nom et nom sont fournis
    if [ -z "$prenom" ] || [ -z "$nom" ]; then
        return 0
    fi
    
    # Normaliser pr√©nom et nom (minuscules, sans accents)
    prenom=$(echo "$prenom" | tr '[:upper:]' '[:lower:]' | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || echo "$prenom" | tr '[:upper:]' '[:lower:]')
    nom=$(echo "$nom" | tr '[:upper:]' '[:lower:]' | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || echo "$nom" | tr '[:upper:]' '[:lower:]')
    
    # Cr√©er l'alias prenom.nom
    local alias_email="${prenom}.${nom}@${DOMAIN}"
    local alias_file="/etc/postfix/virtual"
    
    # Cr√©er le fichier virtual s'il n'existe pas
    if [ ! -f "$alias_file" ]; then
        touch "$alias_file"
    fi
    
    # V√©rifier si l'alias existe d√©j√†
    if grep -q "^${prenom}.${nom}@${DOMAIN}" "$alias_file" 2>/dev/null; then
        return 0
    fi
    
    # Ajouter l'alias
    echo "${prenom}.${nom}@${DOMAIN}    ${username}" >> "$alias_file"
    
    # Mettre √† jour la base de donn√©es Postfix
    postmap "$alias_file" 2>/dev/null
    
    echo -e "${GREEN}[‚úì] Alias cr√©√© : ${prenom}.${nom}@${DOMAIN} ‚Üí ${username}${NC}"
}

#############################################
# Fonction : Configurer les alias virtuels Postfix
#############################################
configure_virtual_aliases() {
    local alias_file="/etc/postfix/virtual"
    local main_cf="/etc/postfix/main.cf"
    
    # V√©rifier si virtual_alias_maps est d√©j√† configur√©
    if ! grep -q "^virtual_alias_maps" "$main_cf" 2>/dev/null; then
        echo ""
        echo "virtual_alias_maps = hash:${alias_file}" >> "$main_cf"
        echo -e "${GREEN}[‚úì] Configuration virtual_alias_maps ajout√©e${NC}"
    fi
    
    # V√©rifier si virtual_alias_domains est configur√©
    if ! grep -q "^virtual_alias_domains" "$main_cf" 2>/dev/null; then
        echo "virtual_alias_domains = ${DOMAIN}" >> "$main_cf"
        echo -e "${GREEN}[‚úì] Configuration virtual_alias_domains ajout√©e${NC}"
    fi
    
    # Recharger Postfix
    systemctl reload postfix 2>/dev/null
}

#############################################
# Fonction : Cr√©er un utilisateur unique (helper)
#############################################
create_single_user() {
    local username=$1
    local nom=$2
    local prenom=$3
    local password=$4
    local groupes=$5
    local sync_ad=$6
    
    # Validation
    if [ -z "$username" ] || [ -z "$password" ]; then
        echo -e "${RED}[‚úó] Username et password requis${NC}"
        return 1
    fi
    
    echo -e "\n${BLUE}=== Cr√©ation de $username ===${NC}"
    
    # Cr√©er les groupes Linux si n√©cessaire
    if [ -n "$groupes" ]; then
        IFS=',' read -ra GROUPS <<< "$groupes"
        for group in "${GROUPS[@]}"; do
            group=$(echo "$group" | xargs)
            create_linux_group "$group"
        done
    fi
    
    # V√©rifier si l'utilisateur existe d√©j√†
    if id "$username" &>/dev/null; then
        echo -e "${YELLOW}[!] L'utilisateur $username existe d√©j√† - mis √† jour${NC}"
    else
        # Cr√©er l'utilisateur avec les infos GECOS
        if [ -n "$nom" ] && [ -n "$prenom" ]; then
            useradd -m -s /bin/bash -c "$prenom $nom" "$username"
        else
            useradd -m -s /bin/bash "$username"
        fi
        echo -e "${GREEN}[‚úì] Utilisateur Linux cr√©√© : $username${NC}"
    fi
    
    # D√©finir le mot de passe (utiliser printf pour √©viter les probl√®mes d'√©chappement)
    printf "%s:%s\n" "$username" "$password" | chpasswd
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}[‚úó] Erreur lors de la d√©finition du mot de passe pour $username${NC}"
        return 1
    fi
    echo -e "${GREEN}[‚úì] Mot de passe d√©fini${NC}"
    
    # Ajouter aux groupes Linux
    if [ -n "$groupes" ]; then
        IFS=',' read -ra GROUPS <<< "$groupes"
        for group in "${GROUPS[@]}"; do
            group=$(echo "$group" | xargs)
            usermod -aG "$group" "$username"
            echo -e "${GREEN}[‚úì] Ajout√© au groupe Linux : $group${NC}"
        done
    fi
    
    # Toujours ajouter au groupe mail
    usermod -aG mail "$username"
    
    # Cr√©er la bo√Æte mail
    touch "/var/mail/$username"
    chown "$username:mail" "/var/mail/$username"
    chmod 660 "/var/mail/$username"
    echo -e "${GREEN}[‚úì] Bo√Æte mail cr√©√©e${NC}"
    
    # Cr√©er l'alias mail prenom.nom@domain
    if [ -n "$nom" ] && [ -n "$prenom" ]; then
        # Configurer virtual aliases si premi√®re fois
        configure_virtual_aliases
        # Cr√©er l'alias
        create_mail_alias "$username" "$prenom" "$nom"
    fi
    
    # Synchroniser avec AD si demand√©
    if [[ "$sync_ad" =~ ^[Yy]|yes$ ]]; then
        create_ad_user "$username" "$nom" "$prenom" "$password" "$groupes"
    fi
    
    # Afficher r√©sum√©
    if [ -n "$nom" ] && [ -n "$prenom" ]; then
        local prenom_clean=$(echo "$prenom" | tr '[:upper:]' '[:lower:]' | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || echo "$prenom" | tr '[:upper:]' '[:lower:]')
        local nom_clean=$(echo "$nom" | tr '[:upper:]' '[:lower:]' | iconv -f UTF-8 -t ASCII//TRANSLIT 2>/dev/null || echo "$nom" | tr '[:upper:]' '[:lower:]')
        echo -e "${GREEN}[‚úì] $username@$DOMAIN ‚Üê ${prenom_clean}.${nom_clean}@$DOMAIN (${prenom} ${nom})${NC}"
    else
        echo -e "${GREEN}[‚úì] $username@$DOMAIN${NC}"
    fi
    
    return 0
}


#############################################
# Fonction : Cr√©er les utilisateurs Iron4Software (pr√©charg√©)
#############################################
create_iron4software_users() {
    echo -e "\n${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë  UTILISATEURS IRON4SOFTWARE (PR√âCHARG√â)   ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    # Cr√©er le fichier temporaire avec les utilisateurs
    local temp_csv="/tmp/iron4software_users.csv"
    
    cat > "$temp_csv" << 'EOF'
# Fichier d'utilisateurs Iron4Software
# Format: username,nom,prenom,password,groupes,sync_ad

# Direction (3 utilisateurs)
emoreau,Moreau,Elise,password123,"direction,users",yes
troussel,Roussel,Thomas,password123,"direction,users",yes
mchevreau,Chevreau,Marion,password123,"direction,users",yes

# Secr√©tariat (2 utilisateurs)
sberanger,Beranger,Sophie,Sosol982,"secretariat,users",yes
bcolin,Colin,Benjamin,password123,"secretariat,users",yes

# Comptabilit√© (3 utilisateurs)
nlefevre,Lef√®vre,Nina,password123,"comptabilite,users",yes
jmorel,Morel,Julien,password123,"comptabilite,users",yes
croche,Roche,Camille,password123,"comptabilite,users",yes

# Vente (3 utilisateurs)
ylanglois,Langlois,Yanis,password123,"vente,users",yes
svilledieu,Villedieu,Sarah,password123,"vente,users",yes
lbernard,Bernard,Loic,password123,"vente,users",yes

# IT (15 utilisateurs)
kdelaunay,Delaunay,Karim,password123,"it,users",yes
jcaron,Caron,Jules,password123,"it,users",yes
gporte,Porte,Guillaume,guillaume123,"it,users",yes
aduval,Duval,Anais,password123,"it,users",yes
lbenelli,Benelli,Lucas,password123,"it,users",yes
bhernandez,Hernandez,Bruno,21031988,"it,users",yes
plejuste,Lejuste,Pierre,password123,"it,users",yes
ncharlier,Charlier,No√©,password123,"it,users",yes
igauthier,Gauthier,In√®s,password123,"it,users",yes
vrenard,Renard,Victor,password123,"it,users",yes
alemoine,Lemoine,Adrien,password123,"it,users",yes
rlefort,Lefort,Rayan,password123,"it,users",yes
ebaron,Baron,Emile,password123,"it,users",yes
mbourdon,Bourdon,Maya,password123,"it,users",yes
EOF

    echo -e "${YELLOW}[INFO] Fichier pr√©charg√© d√©tect√© :${NC}"
    echo "  ‚úì 26 utilisateurs Iron4Software"
    echo "  ‚úì 5 d√©partements"
    echo ""
    echo "D√©partements :"
    echo "  - Direction (3)"
    echo "  - Secr√©tariat (2)"
    echo "  - Comptabilit√© (3)"
    echo "  - Vente (3)"
    echo "  - IT (15)"
    echo ""
    
    read -p "Cr√©er ces 26 utilisateurs maintenant ? (y/n) : " -n 1 -r
    echo
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        rm -f "$temp_csv"
        echo -e "${YELLOW}[!] Annul√©${NC}"
        return
    fi
    
    echo -e "\n${BLUE}[INFO] Import en cours...${NC}\n"
    
    line_count=0
    success_count=0
    
    while IFS=',' read -r username nom prenom password groupes sync_ad || [ -n "$username" ]; do
        # Ignorer les lignes vides et les commentaires
        [[ -z "$username" || "$username" =~ ^#.* ]] && continue
        
        line_count=$((line_count + 1))
        
        # Nettoyer les espaces et guillemets
        username=$(echo "$username" | xargs)
        nom=$(echo "$nom" | xargs)
        prenom=$(echo "$prenom" | xargs)
        password=$(echo "$password" | xargs)
        groupes=$(echo "$groupes" | xargs | tr -d '"')
        sync_ad=$(echo "$sync_ad" | xargs)
        
        if create_single_user "$username" "$nom" "$prenom" "$password" "$groupes" "$sync_ad"; then
            success_count=$((success_count + 1))
        fi
    done < "$temp_csv"
    
    rm -f "$temp_csv"
    
    echo -e "\n${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë       IMPORT TERMIN√â !                    ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${GREEN}‚úì $success_count/$line_count utilisateurs cr√©√©s${NC}"
    echo ""
    echo "Groupes cr√©√©s :"
    echo "  - direction (3 users)"
    echo "  - secretariat (2 users)" 
    echo "  - comptabilite (3 users)"
    echo "  - vente (3 users)"
    echo "  - it (15 users)"
    echo "  - users (tous)"
    echo ""
    
    if [ "$AD_ENABLED" = true ]; then
        echo -e "${GREEN}‚úì Utilisateurs synchronis√©s avec Active Directory${NC}"
    fi
}

#############################################
# Fonction : Cr√©er des utilisateurs pour lab
#############################################
create_lab_users() {
    echo -e "\n${BLUE}[INFO] Cr√©ation d'utilisateurs pour lab de pentest...${NC}"
    
    declare -A users=(
        ["guillaume"]="guillaume123"
        ["sophie"]="azerty"
        ["admin"]="Admin2024!"
        ["service"]="service"
        ["webmail"]="webmail123"
    )
    
    for user in "${!users[@]}"; do
        pass="${users[$user]}"
        create_single_user "$user" "" "" "$pass" "" "no"
    done
    
    echo -e "\n${YELLOW}[INFO] Utilisateurs cr√©√©s pour bruteforce/pentest${NC}"
}

#############################################
# Fonction : G√©n√©rer un fichier exemple CSV
#############################################
generate_csv_example() {
    local csv_file="/tmp/users_example.csv"
    
    cat > "$csv_file" << 'EOF'
# Fichier exemple pour l'import d'utilisateurs
# Format: username,nom,prenom,password,groupes,sync_ad
# Les lignes commen√ßant par # sont ignor√©es
# groupes : s√©par√©s par virgules entre guillemets si plusieurs
# sync_ad : yes/no pour synchroniser avec Active Directory

# Exemples d'utilisateurs avec groupes
jdupont,Dupont,Jean,password123,"dev,users",yes
mmartin,Martin,Marie,azerty,"marketing,users",yes
pdurand,Durand,Pierre,pierre123,"dev,admin",yes
lbernard,Bernard,Luc,luc2024,"users",yes
sthomas,Thomas,Sophie,sophie456,"rh,users",yes

# Exemples avec mots de passe faibles (pour bruteforce)
agarcia,Garcia,Antoine,123456,"users",no
cleroy,Leroy,Claire,password,"users",no
nroux,Roux,Nicolas,azerty123,"users",no
erobert,Robert,Emma,123soleil,"users",no

# Exemples d'utilisateurs admin
adminit,Admin,IT,Admin2024!,"admin,users",yes
support,Support,Technique,Support@123,"support,users",yes
direction,Direction,Generale,Direct2024!,"admin,direction",yes

# Exemples de comptes de service (sans sync AD)
webmaster,Webmaster,Service,webmaster99,"www-data",no
contact,Contact,Public,contact2024,"mail",no
info,Information,Generale,info123,"mail",no
EOF

    echo -e "${GREEN}[‚úì] Fichier exemple cr√©√© : $csv_file${NC}"
    echo -e "${YELLOW}[INFO] Contenu :${NC}"
    cat "$csv_file"
    echo ""
    
    echo -e "${YELLOW}[INFO] Groupes d√©tect√©s dans le fichier :${NC}"
    grep -v "^#" "$csv_file" | grep -v "^$" | cut -d',' -f5 | tr -d '"' | tr ',' '\n' | sort -u | grep -v "^$" | while read group; do
        echo "  - $group"
    done
    
    echo ""
    read -p "Utiliser ce fichier pour cr√©er les utilisateurs ? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        create_users_from_list_file "$csv_file"
    fi
}

#############################################
# Fonction : Cr√©er utilisateurs depuis CSV (direct)
#############################################
create_users_from_list_file() {
    local csv_file=$1
    
    echo -e "\n${YELLOW}[INFO] Lecture du fichier...${NC}"
    line_count=0
    success_count=0
    
    while IFS=',' read -r username nom prenom password || [ -n "$username" ]; do
        # Ignorer les lignes vides et les commentaires
        [[ -z "$username" || "$username" =~ ^#.* ]] && continue
        
        line_count=$((line_count + 1))
        
        # Nettoyer les espaces
        username=$(echo "$username" | xargs)
        nom=$(echo "$nom" | xargs)
        prenom=$(echo "$prenom" | xargs)
        password=$(echo "$password" | xargs)
        
        if create_single_user "$username" "$nom" "$prenom" "$password"; then
            success_count=$((success_count + 1))
        fi
    done < "$csv_file"
    
    echo -e "\n${GREEN}[‚úì] $success_count/$line_count utilisateurs cr√©√©s avec succ√®s${NC}"
}

#############################################
# Fonction : Afficher les logs
#############################################
show_logs() {
    echo -e "\n${BLUE}[INFO] Derniers logs mail...${NC}"
    echo -e "${YELLOW}=== Postfix ===${NC}"
    tail -20 /var/log/mail.log | grep postfix
    
    echo -e "\n${YELLOW}=== Dovecot ===${NC}"
    tail -20 /var/log/mail.log | grep dovecot
    
    echo -e "\n${YELLOW}=== Authentification ===${NC}"
    tail -20 /var/log/mail.log | grep -i "auth\|login"
}

#############################################
# Fonction : Menu principal
#############################################
show_menu() {
    echo -e "\n${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë        MENU PRINCIPAL              ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    
    # Afficher statut AD
    if [ "$AD_ENABLED" = true ]; then
        echo -e "${GREEN}[AD ACTIV√â] $AD_SERVER${NC}"
    else
        echo -e "${YELLOW}[AD D√âSACTIV√â]${NC}"
    fi
    
    echo ""
    echo "1) V√©rifier les services"
    echo "2) V√©rifier la configuration compl√®te"
    echo "3) Cr√©er un utilisateur"
    echo "4) Cr√©er plusieurs utilisateurs (liste/CSV)"
    echo "5) Lister les utilisateurs mail"
    echo "6) R√©parer les permissions"
    echo "7) Cr√©er des utilisateurs de lab (pentest)"
    echo "8) Cr√©er les utilisateurs Iron4Software (26 users pr√©charg√©s) üÜï"
    echo "9) G√©n√©rer un fichier CSV exemple"
    echo "10) Configurer Active Directory"
    echo "11) R√©g√©n√©rer tous les alias mail (prenom.nom) üÜï"
    echo "12) Afficher les logs"
    echo "13) Red√©marrer tous les services"
    echo "14) Quitter"
    echo ""
    read -p "Choix : " choice
    
    case $choice in
        1) check_services ;;
        2) check_config ;;
        3) create_user ;;
        4) create_users_from_list ;;
        5) list_users ;;
        6) fix_permissions ;;
        7) create_lab_users ;;
        8) create_iron4software_users ;;
        9) generate_csv_example ;;
        10) configure_ad ;;
        11) regenerate_all_aliases ;;
        12) show_logs ;;
        13) 
            systemctl restart postfix dovecot apache2
            echo -e "${GREEN}[‚úì] Services red√©marr√©s${NC}"
            ;;
        14) 
            echo -e "${GREEN}Au revoir !${NC}"
            exit 0
            ;;
        *) 
            echo -e "${RED}Choix invalide${NC}"
            ;;
    esac
    
    read -p "Appuyer sur Entr√©e pour continuer..."
}

#############################################
# MAIN
#############################################
check_root
load_ad_config

# Boucle du menu
while true; do
    clear
    echo -e "${BLUE}"
    echo "================================================"
    echo "   Iron4Software - Mail Server Manager"
    echo "   Domaine : $DOMAIN"
    echo "================================================"
    echo -e "${NC}"
    show_menu
done
