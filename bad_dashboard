#!/bin/bash

##############################################
# Dashboard INCOMPLET - Exercice de D√©tection
# Auteur: Philippe - Iron4Software
# Date: 2024
# ATTENTION: Ce dashboard semble fonctionnel mais
# manque d'informations CRITIQUES de s√©curit√©
##############################################

# Configuration
SPLUNK_HOST="192.168.1.253"
SPLUNK_PORT="8000"
SPLUNK_USER="admin"
SPLUNK_PASSWORD="Admin123G4"
DASHBOARD_ID="incomplete_security_dashboard"
DASHBOARD_TITLE="üîç Dashboard de S√©curit√© - Exercice : Qu'est-ce qui manque ?"

# Couleurs pour l'affichage
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}============================================${NC}"
echo -e "${YELLOW}Dashboard INCOMPLET - Exercice${NC}"
echo -e "${YELLOW}============================================${NC}\n"

# V√©rification de la connectivit√©
echo -e "${YELLOW}[1/4] V√©rification de la connectivit√© vers Splunk...${NC}"
if ! curl -s --connect-timeout 5 "http://${SPLUNK_HOST}:${SPLUNK_PORT}" > /dev/null; then
    echo -e "${RED}‚ùå Erreur : Impossible de se connecter √† Splunk sur ${SPLUNK_HOST}:${SPLUNK_PORT}${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ Connexion √† Splunk OK${NC}\n"

# Cr√©ation du contenu XML du dashboard
echo -e "${YELLOW}[2/4] G√©n√©ration du dashboard incomplet...${NC}"

DASHBOARD_XML='<form version="1.1">
  <label>'"${DASHBOARD_TITLE}"'</label>
  <description>‚ö†Ô∏è Ce dashboard semble fonctionnel mais manque d'\''informations CRITIQUES - Exercice : Identifiez ce qui est absent</description>
  
  <fieldset submitButton="false">
    <input type="time" token="time_token">
      <label>P√©riode</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <row>
    <panel>
      <html>
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px;">
          <h2>üîç Exercice : Identification des Manques</h2>
          <p><strong>Ce dashboard pr√©sente les activit√©s du r√©seau, mais il manque des informations CRITIQUES pour la s√©curit√©.</strong></p>
          <br/>
          <p><strong>Votre mission :</strong></p>
          <ol>
            <li>Examiner chaque panel du dashboard</li>
            <li>Identifier ce qui manque (√©v√©nements, filtres, alertes, corr√©lations)</li>
            <li>Expliquer pourquoi c'\''est critique</li>
            <li>Proposer des ajouts pour compl√©ter le dashboard</li>
          </ol>
          <br/>
          <p><strong>Indices :</strong> Pensez aux 5W : Who, What, When, Where, Why</p>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>üìä Nombre total d'\''√©v√©nements de s√©curit√©</title>
      <single>
        <search>
          <query>index=windows source="WinEventLog:Security" earliest=$time_token.earliest$ latest=$time_token.latest$
| stats count as total</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="underLabel">√âv√©nements Windows Security</option>
      </single>
    </panel>
    
    <panel>
      <title>‚úÖ Connexions r√©ussies</title>
      <single>
        <search>
          <query>index=windows source="WinEventLog:Security" EventCode=4624 earliest=$time_token.earliest$ latest=$time_token.latest$
| stats count as logins</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="underLabel">Authentifications Windows</option>
      </single>
    </panel>
  </row>

  <row>
    <panel>
      <title>üë• Top 5 utilisateurs actifs</title>
      <table>
        <search>
          <query>index=windows source="WinEventLog:Security" EventCode=4624 earliest=$time_token.earliest$ latest=$time_token.latest$
| rex field=_raw "Account Name:\s+(?&lt;user&gt;\S+)"
| stats count by user
| sort -count
| head 5</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    
    <panel>
      <title>üíª Serveurs actifs</title>
      <table>
        <search>
          <query>index=linux OR index=windows earliest=$time_token.earliest$ latest=$time_token.latest$
| stats count by host
| sort -count</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>üìà Timeline des authentifications</title>
      <chart>
        <search>
          <query>index=windows source="WinEventLog:Security" EventCode=4624 earliest=$time_token.earliest$ latest=$time_token.latest$
| timechart span=1h count</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.axisTitleY.text">Connexions</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>üîê Activit√© SSH Linux</title>
      <table>
        <search>
          <query>index=linux source="/var/log/auth.log" "Accepted password" earliest=$time_token.earliest$ latest=$time_token.latest$
| rex field=_raw "for (?&lt;user&gt;\S+) from (?&lt;src_ip&gt;[\d\.]+)"
| stats count by user, src_ip
| sort -count
| head 10</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>üåê Trafic r√©seau par port</title>
      <chart>
        <search>
          <query>index=* sourcetype=pf:filterlog earliest=$time_token.earliest$ latest=$time_token.latest$
| rex field=_raw ",(?&lt;dst_port&gt;\d+),[^,]*$"
| stats count by dst_port
| sort -count
| head 10</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.axisTitleX.text">Nombre de connexions</option>
      </chart>
    </panel>
    
    <panel>
      <title>üìß Activit√© du serveur mail</title>
      <single>
        <search>
          <query>index=linux source="/var/log/mail.log" earliest=$time_token.earliest$ latest=$time_token.latest$
| stats count as emails</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="underLabel">Emails trait√©s</option>
      </single>
    </panel>
  </row>

  <row>
    <panel>
      <title>üñ•Ô∏è √âv√©nements syst√®me Windows</title>
      <table>
        <search>
          <query>index=windows source="WinEventLog:System" earliest=$time_token.earliest$ latest=$time_token.latest$
| stats count by EventCode
| sort -count
| head 10</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <html>
        <div style="background-color: #d4edda; padding: 15px; border-radius: 5px; margin: 10px;">
          <h3>‚úÖ Dashboard op√©rationnel</h3>
          <p>Toutes les requ√™tes fonctionnent correctement et affichent des donn√©es.</p>
          <p><strong>Mais √™tes-vous vraiment en s√©curit√© ?</strong></p>
          <br/>
          <p>R√©fl√©chissez aux questions suivantes :</p>
          <ul>
            <li>Que se passe-t-il si quelqu'\''un essaie de se connecter sans succ√®s ?</li>
            <li>Comment d√©tectez-vous une compromission ?</li>
            <li>O√π sont les alertes pour les activit√©s anormales ?</li>
            <li>Surveillez-vous les changements de configuration ?</li>
            <li>Pouvez-vous identifier une escalade de privil√®ges ?</li>
            <li>Que se passe-t-il apr√®s les heures de bureau ?</li>
          </ul>
        </div>
      </html>
    </panel>
  </row>
</form>'

echo -e "${GREEN}‚úÖ Dashboard incomplet g√©n√©r√©${NC}\n"

# Suppression de l'ancien dashboard s'il existe
echo -e "${YELLOW}[3/4] Suppression de l'ancien dashboard (si existant)...${NC}"
curl -k -s -u "${SPLUNK_USER}:${SPLUNK_PASSWORD}" \
  -X DELETE \
  "https://${SPLUNK_HOST}:8089/servicesNS/admin/search/data/ui/views/${DASHBOARD_ID}" \
  2>/dev/null

echo -e "${GREEN}‚úÖ Nettoyage effectu√©${NC}\n"

# Cr√©ation du nouveau dashboard
echo -e "${YELLOW}[4/4] D√©ploiement du dashboard...${NC}"

RESPONSE=$(curl -k -s -u "${SPLUNK_USER}:${SPLUNK_PASSWORD}" \
  -X POST \
  "https://${SPLUNK_HOST}:8089/servicesNS/admin/search/data/ui/views" \
  --data-urlencode "name=${DASHBOARD_ID}" \
  --data-urlencode "eai:data=${DASHBOARD_XML}" \
  -w "\nHTTP_CODE:%{http_code}")

HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d':' -f2)

if [[ "$HTTP_CODE" == "201" ]] || [[ "$HTTP_CODE" == "200" ]]; then
    echo -e "${GREEN}‚úÖ Dashboard d√©ploy√© avec succ√®s !${NC}\n"
    echo -e "${YELLOW}======================================${NC}"
    echo -e "${YELLOW}Dashboard accessible √† :${NC}"
    echo -e "${YELLOW}http://${SPLUNK_HOST}:${SPLUNK_PORT}/app/search/${DASHBOARD_ID}${NC}"
    echo -e "${YELLOW}======================================${NC}\n"
    
    # D√©finir les permissions
    curl -k -s -u "${SPLUNK_USER}:${SPLUNK_PASSWORD}" \
      -X POST \
      "https://${SPLUNK_HOST}:8089/servicesNS/admin/search/data/ui/views/${DASHBOARD_ID}/acl" \
      -d "sharing=app" \
      -d "owner=admin" \
      -d "perms.read=*" \
      > /dev/null
    
    echo -e "${GREEN}‚úÖ Permissions configur√©es${NC}\n"
    
else
    echo -e "${RED}‚ùå Erreur lors du d√©ploiement du dashboard${NC}"
    echo -e "${RED}Code HTTP: ${HTTP_CODE}${NC}"
    echo "$RESPONSE" | grep -v "HTTP_CODE:"
    exit 1
fi

echo -e "${RED}======================================${NC}"
echo -e "${RED}‚ö†Ô∏è INFORMATIONS MANQUANTES${NC}"
echo -e "${RED}======================================${NC}"
echo -e "‚ùå √âchecs d'authentification (EventCode 4625)"
echo -e "‚ùå Escalade de privil√®ges (EventCode 4672, 4728, 4732)"
echo -e "‚ùå Changements de comptes (cr√©ation, suppression, modification)"
echo -e "‚ùå Trafic bloqu√© par le firewall (action=block)"
echo -e "‚ùå D√©tection de port scanning"
echo -e "‚ùå Connexions depuis des IPs inhabituelles"
echo -e "‚ùå Activit√© en dehors des heures de bureau"
echo -e "‚ùå √âv√©nements critiques Linux (erreurs, panics)"
echo -e "‚ùå Modifications de fichiers sensibles"
echo -e "‚ùå Utilisation de commandes privil√©gi√©es (sudo)"
echo -e "‚ùå Alertes et seuils de s√©curit√©"
echo -e "‚ùå Corr√©lation entre √©v√©nements suspects"
echo -e ""
echo -e "${YELLOW}Votre mission : Identifier TOUS les manques !${NC}\n"
