#!/bin/bash

##############################################
# DIAGNOSTIC ULTRA-DÃ‰TAILLÃ‰ SSH
# VÃ©rifie TOUT ce qui peut bloquer SSH
##############################################

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  DIAGNOSTIC ULTRA-DÃ‰TAILLÃ‰ SSH${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}âŒ ExÃ©cuter en root: sudo bash $0${NC}"
    exit 1
fi

IP=$(hostname -I | awk '{print $1}')

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. PROCESSUS SSH
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${YELLOW}[1] PROCESSUS SSH${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if pgrep -x sshd > /dev/null; then
    echo -e "${GREEN}âœ“ sshd est en cours d'exÃ©cution${NC}"
    ps aux | grep "[s]shd" | head -3
else
    echo -e "${RED}âœ— sshd N'EST PAS en cours d'exÃ©cution${NC}"
    echo "  Solution: systemctl start ssh"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. PORTS ET RÃ‰SEAU
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${YELLOW}[2] PORTS ET RÃ‰SEAU${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

echo "Ã‰coute sur le port 22:"
if ss -tln 2>/dev/null | grep -q ":22"; then
    ss -tln | grep ":22"
    echo -e "${GREEN}âœ“ SSH Ã©coute sur le port 22${NC}"
elif netstat -tln 2>/dev/null | grep -q ":22"; then
    netstat -tln | grep ":22"
    echo -e "${GREEN}âœ“ SSH Ã©coute sur le port 22${NC}"
else
    echo -e "${RED}âœ— Port 22 PAS en Ã©coute${NC}"
fi
echo ""

echo "IP du serveur:"
echo "  $IP"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. FIREWALL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${YELLOW}[3] FIREWALL${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# UFW
if command -v ufw &> /dev/null; then
    ufw_status=$(ufw status 2>/dev/null | head -1)
    echo "UFW: $ufw_status"
    if echo "$ufw_status" | grep -q "active"; then
        if ufw status | grep -q "22.*ALLOW"; then
            echo -e "${GREEN}âœ“ UFW autorise SSH${NC}"
        else
            echo -e "${RED}âœ— UFW BLOQUE SSH${NC}"
            echo "  Solution: ufw allow 22/tcp"
        fi
    else
        echo -e "${GREEN}âœ“ UFW inactif${NC}"
    fi
else
    echo "UFW: non installÃ©"
fi

# iptables
if command -v iptables &> /dev/null; then
    iptables_rules=$(iptables -L -n 2>/dev/null | wc -l)
    if [ "$iptables_rules" -gt 8 ]; then
        echo "iptables: $iptables_rules rÃ¨gles actives"
        if iptables -L INPUT -n | grep -q "22.*ACCEPT"; then
            echo -e "${GREEN}âœ“ iptables autorise SSH${NC}"
        else
            echo -e "${YELLOW}âš  VÃ©rifier les rÃ¨gles iptables${NC}"
            iptables -L INPUT -n | grep -E "tcp.*22|dpt:22"
        fi
    else
        echo -e "${GREEN}âœ“ iptables minimal${NC}"
    fi
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. CONFIGURATION SSHD DÃ‰TAILLÃ‰E
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${YELLOW}[4] CONFIGURATION SSHD DÃ‰TAILLÃ‰E${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

echo "Fichier: /etc/ssh/sshd_config"
echo ""

# Port
port=$(grep "^Port" /etc/ssh/sshd_config 2>/dev/null)
if [ -z "$port" ]; then
    echo -e "${GREEN}âœ“ Port: 22 (dÃ©faut)${NC}"
else
    echo "  $port"
fi

# PasswordAuthentication
pass_auth=$(grep "^PasswordAuthentication" /etc/ssh/sshd_config 2>/dev/null)
if echo "$pass_auth" | grep -q "yes"; then
    echo -e "${GREEN}âœ“ PasswordAuthentication yes${NC}"
else
    echo -e "${RED}âœ— PasswordAuthentication: $pass_auth${NC}"
    echo -e "${RED}  PROBLÃˆME: Auth par mot de passe dÃ©sactivÃ©e${NC}"
fi

# PermitRootLogin
root_login=$(grep "^PermitRootLogin" /etc/ssh/sshd_config 2>/dev/null)
if echo "$root_login" | grep -q "yes"; then
    echo -e "${GREEN}âœ“ PermitRootLogin yes${NC}"
else
    echo -e "${YELLOW}âš  PermitRootLogin: $root_login${NC}"
fi

# UsePAM
use_pam=$(grep "^UsePAM" /etc/ssh/sshd_config 2>/dev/null)
if echo "$use_pam" | grep -q "yes"; then
    echo -e "${GREEN}âœ“ UsePAM yes${NC}"
else
    echo -e "${RED}âœ— UsePAM: $use_pam${NC}"
fi

# ChallengeResponseAuthentication
challenge=$(grep "^ChallengeResponseAuthentication" /etc/ssh/sshd_config 2>/dev/null)
if echo "$challenge" | grep -q "no"; then
    echo -e "${GREEN}âœ“ ChallengeResponseAuthentication no${NC}"
elif [ -z "$challenge" ]; then
    echo -e "${GREEN}âœ“ ChallengeResponseAuthentication (dÃ©faut: no)${NC}"
else
    echo "  ChallengeResponseAuthentication: $challenge"
fi

echo ""

# Test de syntaxe sshd_config
echo "Test syntaxe configuration:"
if sshd -t 2>&1; then
    echo -e "${GREEN}âœ“ Configuration SSH valide${NC}"
else
    echo -e "${RED}âœ— ERREUR dans la configuration${NC}"
    sshd -t 2>&1
fi

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. UTILISATEURS ET MOTS DE PASSE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${YELLOW}[5] UTILISATEURS ET MOTS DE PASSE${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

declare -A USERS
USERS[root]="toor"
USERS[pierre]="pierre123"
USERS[guillaume]="123"
USERS[admin]="admin"

for user in "${!USERS[@]}"; do
    echo "[$user]"
    
    # Existe?
    if id "$user" &>/dev/null 2>&1; then
        echo -e "  ${GREEN}âœ“ Existe${NC}"
    else
        echo -e "  ${RED}âœ— N'existe PAS${NC}"
        continue
    fi
    
    # Mot de passe?
    if [ "$user" = "root" ]; then
        # Pour root, vÃ©rifier dans shadow
        if grep "^root:" /etc/shadow | grep -q ':\$'; then
            echo -e "  ${GREEN}âœ“ Mot de passe configurÃ©${NC}"
        else
            echo -e "  ${RED}âœ— Pas de mot de passe${NC}"
        fi
    else
        passwd_status=$(passwd -S "$user" 2>/dev/null | awk '{print $2}')
        case "$passwd_status" in
            "P")
                echo -e "  ${GREEN}âœ“ Mot de passe configurÃ©${NC}"
                ;;
            "L")
                echo -e "  ${RED}âœ— Compte VERROUILLÃ‰${NC}"
                echo "    Solution: passwd -u $user"
                ;;
            "NP")
                echo -e "  ${RED}âœ— PAS de mot de passe${NC}"
                echo "    Solution: echo '$user:${USERS[$user]}' | chpasswd"
                ;;
            *)
                echo -e "  ${YELLOW}âš  Statut: $passwd_status${NC}"
                ;;
        esac
    fi
    
    # Shell
    user_shell=$(grep "^$user:" /etc/passwd | cut -d: -f7)
    if [ "$user_shell" = "/bin/bash" ] || [ "$user_shell" = "/bin/sh" ]; then
        echo -e "  ${GREEN}âœ“ Shell: $user_shell${NC}"
    else
        echo -e "  ${YELLOW}âš  Shell: $user_shell${NC}"
    fi
    
    # Home
    if [ "$user" != "root" ]; then
        user_home=$(grep "^$user:" /etc/passwd | cut -d: -f6)
        if [ -d "$user_home" ]; then
            echo -e "  ${GREEN}âœ“ Home: $user_home${NC}"
        else
            echo -e "  ${RED}âœ— Home manquant: $user_home${NC}"
        fi
    fi
    
    echo ""
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. PAM DÃ‰TAILLÃ‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${YELLOW}[6] PAM (Pluggable Authentication Modules)${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

echo "/etc/pam.d/sshd:"
if [ -f /etc/pam.d/sshd ]; then
    echo -e "${GREEN}âœ“ Existe${NC}"
    echo ""
    echo "Contenu (sans commentaires):"
    grep -v "^#" /etc/pam.d/sshd | grep -v "^$" | head -10
else
    echo -e "${RED}âœ— MANQUANT${NC}"
fi
echo ""

echo "/etc/pam.d/common-auth:"
if [ -f /etc/pam.d/common-auth ]; then
    echo -e "${GREEN}âœ“ Existe${NC}"
    echo ""
    echo "Contenu (actif):"
    grep -v "^#" /etc/pam.d/common-auth | grep -v "^$"
    echo ""
    
    # VÃ©rifier pam_sss
    if grep -q "^auth.*pam_sss.so" /etc/pam.d/common-auth; then
        echo -e "${RED}âš âš âš  pam_sss.so EST ACTIF (PROBLÃˆME!)${NC}"
        echo "  SSSD intercepte l'authentification"
        echo "  Solution: sed -i 's/^auth.*pam_sss.so/#&/' /etc/pam.d/common-auth"
    else
        echo -e "${GREEN}âœ“ pam_sss.so non actif${NC}"
    fi
    
    # VÃ©rifier pam_unix
    if grep -q "pam_unix.so" /etc/pam.d/common-auth; then
        echo -e "${GREEN}âœ“ pam_unix.so prÃ©sent${NC}"
    else
        echo -e "${RED}âœ— pam_unix.so MANQUANT${NC}"
    fi
else
    echo -e "${RED}âœ— MANQUANT${NC}"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 7. SSSD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${YELLOW}[7] SSSD (System Security Services Daemon)${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if systemctl is-active --quiet sssd 2>/dev/null; then
    echo -e "${RED}âœ—âœ—âœ— SSSD EST ACTIF (PROBLÃˆME MAJEUR!)${NC}"
    echo "  SSSD intercepte toutes les authentifications"
    echo "  Solution:"
    echo "    systemctl stop sssd"
    echo "    systemctl disable sssd"
elif systemctl is-enabled --quiet sssd 2>/dev/null; then
    echo -e "${YELLOW}âš  SSSD configurÃ© mais inactif${NC}"
    echo "  Solution: systemctl disable sssd"
else
    echo -e "${GREEN}âœ“ SSSD inactif${NC}"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 8. LOGS RÃ‰CENTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${YELLOW}[8] LOGS RÃ‰CENTS (10 derniÃ¨res lignes)${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
tail -10 /var/log/auth.log | grep -E "sshd|pam"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 9. TEST DE CONNEXION LOCAL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo -e "${YELLOW}[9] TEST CONNEXION LOCAL${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Installer sshpass si nÃ©cessaire
if ! command -v sshpass &> /dev/null; then
    echo "Installation sshpass..."
    apt install -y sshpass -qq 2>/dev/null
fi

if command -v sshpass &> /dev/null; then
    echo "Test: pierre@localhost..."
    
    # Nettoyer known_hosts
    ssh-keygen -R localhost 2>/dev/null > /dev/null
    
    # Test avec timeout
    if timeout 5 sshpass -p "pierre123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null pierre@localhost "echo 'SSH OK'" 2>&1 | grep -q "SSH OK"; then
        echo -e "${GREEN}âœ“âœ“âœ“ CONNEXION SSH FONCTIONNE!${NC}"
        echo "  Le problÃ¨me vient peut-Ãªtre du rÃ©seau ou du client"
    else
        echo -e "${RED}âœ—âœ—âœ— CONNEXION SSH Ã‰CHOUE${NC}"
        echo ""
        echo "DÃ©tail de l'erreur:"
        timeout 5 sshpass -p "pierre123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null pierre@localhost "echo OK" 2>&1 | head -5
    fi
else
    echo "sshpass non disponible - test manuel"
    echo "  Commande: ssh pierre@localhost"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰SUMÃ‰ ET SOLUTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  RÃ‰SUMÃ‰ ET SOLUTIONS${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo -e "${YELLOW}ğŸ“‹ CHECKLIST RAPIDE:${NC}"
echo ""
echo "1. VÃ©rifier que SSSD est ARRÃŠTÃ‰:"
echo "   systemctl stop sssd && systemctl disable sssd"
echo ""
echo "2. VÃ©rifier pam_sss est DÃ‰SACTIVÃ‰:"
echo "   sed -i 's/^auth.*pam_sss.so/#&/' /etc/pam.d/common-auth"
echo ""
echo "3. Reconfigurer les mots de passe:"
echo "   echo 'pierre:pierre123' | chpasswd"
echo "   echo 'guillaume:123' | chpasswd"
echo ""
echo "4. Forcer PasswordAuthentication:"
echo "   sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config"
echo ""
echo "5. RedÃ©marrer SSH:"
echo "   systemctl restart ssh"
echo ""
echo -e "${YELLOW}ğŸ”§ TEST DEPUIS KALI:${NC}"
echo "   ssh pierre@$IP"
echo "   Password: pierre123"
echo ""
echo -e "${YELLOW}ğŸ“Š MONITORING EN TEMPS RÃ‰EL:${NC}"
echo "   tail -f /var/log/auth.log | grep sshd"
echo ""
