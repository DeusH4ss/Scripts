#!/bin/bash

# Script SIMPLE de réinstallation MariaDB + Roundcube
# Iron4Software Lab - Philippe
# SANS SAUVEGARDE - DIRECT ET EFFICACE

set +e  # Continue même en cas d'erreur

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}"
echo "=============================================="
echo "  MariaDB Fix - AVEC SAUVEGARDE"
echo "  Iron4Software Lab"
echo "=============================================="
echo -e "${NC}"

# SAUVEGARDE
BACKUP_DIR="/tmp/mariadb_backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo -e "\n${BLUE}[0/5] Sauvegarde des données...${NC}"
echo -e "${YELLOW}Dossier: $BACKUP_DIR${NC}"

# Méthode 1 : Si MySQL tourne, utiliser mysqldump
if systemctl is-active --quiet mysql || pgrep -x mysqld > /dev/null; then
    echo -e "${YELLOW}MySQL actif, sauvegarde via mysqldump...${NC}"
    
    # Sauvegarder toutes les bases
    DATABASES=$(mysql -N -e "SHOW DATABASES;" 2>/dev/null | grep -vE "^(information_schema|performance_schema|mysql|sys)$" || echo "")
    
    if [ -n "$DATABASES" ]; then
        for DB in $DATABASES; do
            echo -e "${YELLOW}  Sauvegarde: $DB${NC}"
            mysqldump --single-transaction "$DB" > "$BACKUP_DIR/${DB}.sql" 2>/dev/null || echo "    (échec)"
        done
        echo -e "${GREEN}✓ Sauvegarde SQL terminée${NC}"
    else
        echo -e "${YELLOW}Aucune base utilisateur trouvée${NC}"
    fi
else
    echo -e "${YELLOW}MySQL inactif, copie des fichiers bruts...${NC}"
    
    # Copier directement le datadir
    if [ -d /var/lib/mysql ]; then
        cp -a /var/lib/mysql "$BACKUP_DIR/mysql_datadir_backup" 2>/dev/null && \
            echo -e "${GREEN}✓ Copie datadir terminée${NC}" || \
            echo -e "${YELLOW}Impossible de copier datadir${NC}"
    fi
fi

# Sauvegarder la config
if [ -f /etc/mysql/my.cnf ]; then
    cp /etc/mysql/my.cnf "$BACKUP_DIR/my.cnf.bak" 2>/dev/null
fi

echo -e "${GREEN}✓ Sauvegarde dans: $BACKUP_DIR${NC}"
ls -lh "$BACKUP_DIR/" 2>/dev/null | tail -10

# ÉTAPE 1 : NETTOYAGE COMPLET
echo -e "\n${BLUE}[1/5] Nettoyage complet MySQL/MariaDB...${NC}"

# Arrêter tous les services
systemctl stop mysql 2>/dev/null
systemctl stop mariadb 2>/dev/null

# Tuer TOUS les processus
killall -9 mysqld 2>/dev/null
killall -9 mysqld_safe 2>/dev/null
killall -9 mariadbd 2>/dev/null
sleep 2

# Désinstaller
echo -e "${YELLOW}Désinstallation...${NC}"
apt-get remove --purge -y mysql-server mysql-client mysql-common mysql-server-core-* mysql-client-core-* mariadb-server mariadb-client 2>/dev/null
apt-get autoremove -y 2>/dev/null
apt-get autoclean 2>/dev/null

# Supprimer les fichiers
rm -rf /etc/mysql /var/lib/mysql /var/log/mysql /var/run/mysqld

echo -e "${GREEN}✓ Nettoyage terminé${NC}"

# ÉTAPE 2 : INSTALLATION MARIADB
echo -e "\n${BLUE}[2/5] Installation MariaDB...${NC}"

apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y mariadb-server mariadb-client

echo -e "${GREEN}✓ MariaDB installé${NC}"

# ÉTAPE 3 : DÉMARRAGE ET CONFIGURATION
echo -e "\n${BLUE}[3/5] Configuration MariaDB...${NC}"

systemctl start mysql
sleep 3

if ! systemctl is-active --quiet mysql; then
    echo -e "${RED}✗ Échec démarrage MariaDB${NC}"
    journalctl -u mysql -n 20 --no-pager
    exit 1
fi

echo -e "${GREEN}✓ MariaDB démarré${NC}"

# Configuration root sans mot de passe
mysql <<'EOF'
ALTER USER 'root'@'localhost' IDENTIFIED BY '';
FLUSH PRIVILEGES;
EOF

echo -e "${GREEN}✓ Configuration root OK${NC}"

# RESTAURATION DES DONNÉES SAUVEGARDÉES
echo -e "\n${BLUE}[3.5/5] Restauration des bases sauvegardées...${NC}"

if [ -d "$BACKUP_DIR" ]; then
    SQL_FILES=$(find "$BACKUP_DIR" -name "*.sql" -type f 2>/dev/null)
    
    if [ -n "$SQL_FILES" ]; then
        echo -e "${YELLOW}Restauration des bases...${NC}"
        
        for SQL_FILE in $SQL_FILES; do
            DB_NAME=$(basename "$SQL_FILE" .sql)
            
            # Ne pas restaurer roundcubemail (sera recréé proprement après)
            if [ "$DB_NAME" = "roundcubemail" ]; then
                continue
            fi
            
            echo -e "${YELLOW}  Restauration: $DB_NAME${NC}"
            mysql -e "CREATE DATABASE IF NOT EXISTS \`$DB_NAME\`;" 2>/dev/null
            mysql "$DB_NAME" < "$SQL_FILE" 2>/dev/null && \
                echo -e "${GREEN}    ✓ OK${NC}" || \
                echo -e "${YELLOW}    (échec)${NC}"
        done
        
        echo -e "${GREEN}✓ Restauration terminée${NC}"
    else
        echo -e "${YELLOW}Aucune sauvegarde SQL à restaurer${NC}"
    fi
else
    echo -e "${YELLOW}Pas de sauvegarde à restaurer${NC}"
fi

# ÉTAPE 4 : CONFIGURATION ROUNDCUBE
echo -e "\n${BLUE}[4/5] Configuration Roundcube...${NC}"

# Créer la base
mysql <<'EOF'
DROP DATABASE IF EXISTS roundcubemail;
CREATE DATABASE roundcubemail CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
GRANT ALL PRIVILEGES ON roundcubemail.* TO 'roundcube'@'localhost' IDENTIFIED BY 'roundcube_pass';
FLUSH PRIVILEGES;
EOF

echo -e "${GREEN}✓ Base de données créée${NC}"

# Importer le schéma
if [ -f /var/www/html/webmail/SQL/mysql.initial.sql ]; then
    mysql roundcubemail < /var/www/html/webmail/SQL/mysql.initial.sql 2>/dev/null
    echo -e "${GREEN}✓ Schéma Roundcube importé${NC}"
else
    echo -e "${RED}✗ Fichier SQL non trouvé${NC}"
fi

# Configurer config.inc.php
if [ -f /var/www/html/webmail/config/config.inc.php ]; then
    cp /var/www/html/webmail/config/config.inc.php /var/www/html/webmail/config/config.inc.php.bak
    
    # Mettre à jour la ligne db_dsnw
    if grep -q "db_dsnw" /var/www/html/webmail/config/config.inc.php; then
        sed -i "s|\$config\['db_dsnw'\].*|\$config['db_dsnw'] = 'mysql://roundcube:roundcube_pass@localhost/roundcubemail';|" /var/www/html/webmail/config/config.inc.php
    else
        echo "\$config['db_dsnw'] = 'mysql://roundcube:roundcube_pass@localhost/roundcubemail';" >> /var/www/html/webmail/config/config.inc.php
    fi
    
    echo -e "${GREEN}✓ Configuration Roundcube mise à jour${NC}"
fi

# Activer MariaDB au démarrage
systemctl enable mysql

# ÉTAPE 5 : TESTS
echo -e "\n${BLUE}[5/5] Tests finaux...${NC}"

systemctl restart apache2

# Test MySQL
if mysql -e "SELECT VERSION();" &>/dev/null; then
    echo -e "${GREEN}✓ MariaDB fonctionne${NC}"
    mysql -e "SELECT VERSION();"
else
    echo -e "${RED}✗ Problème MariaDB${NC}"
fi

# Test webmail
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/webmail/ 2>/dev/null)
if [ "$HTTP_CODE" = "200" ]; then
    echo -e "${GREEN}✓ Webmail accessible (HTTP 200)${NC}"
else
    echo -e "${RED}✗ Webmail erreur (HTTP $HTTP_CODE)${NC}"
fi

# RAPPORT FINAL
echo -e "\n${BLUE}=============================================="
echo "              RAPPORT FINAL"
echo "=============================================="
echo -e "${NC}"

echo -e "${BLUE}Sauvegarde:${NC}"
echo "  Dossier: $BACKUP_DIR"
if [ -d "$BACKUP_DIR" ]; then
    echo "  Fichiers: $(ls -1 "$BACKUP_DIR" | wc -l)"
fi

echo ""
systemctl is-active mysql && echo -e "${GREEN}✓ MariaDB: ACTIF${NC}" || echo -e "${RED}✗ MariaDB: INACTIF${NC}"
systemctl is-active apache2 && echo -e "${GREEN}✓ Apache2: ACTIF${NC}" || echo -e "${RED}✗ Apache2: INACTIF${NC}"

echo ""
echo -e "${BLUE}Bases de données:${NC}"
mysql -e "SHOW DATABASES;" 2>/dev/null | grep -v "Database\|information_schema\|performance_schema\|mysql\|sys"

echo ""
echo -e "${GREEN}✓ INSTALLATION TERMINÉE !${NC}"
echo ""
echo "Sauvegarde conservée dans: $BACKUP_DIR"
echo ""
echo "Accès webmail:"
echo "  • URL: http://192.168.1.250/webmail/"
echo "  • Test: curl -I http://localhost/webmail/"
echo ""
echo "Prochaine étape:"
echo "  • Tester connexion avec un utilisateur (ex: gporte / guillaume123)"
echo "  • Lancer l'attaque phpMyAdmin depuis Kali"
echo ""
