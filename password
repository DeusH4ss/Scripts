#!/bin/bash

##############################################
# RECONFIGURATION TOTALE DES MOTS DE PASSE
# Force la rÃ©initialisation complÃ¨te
##############################################

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  RECONFIGURATION TOTALE MOTS DE PASSE${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# VÃ©rifier root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}âŒ ExÃ©cuter en root: sudo bash $0${NC}"
    exit 1
fi

IP=$(hostname -I | awk '{print $1}')

# Utilisateurs Ã  configurer
declare -A USERS
USERS[root]="toor"
USERS[pierre]="pierre123"
USERS[guillaume]="123"
USERS[admin]="admin"

echo -e "${YELLOW}[Ã‰TAPE 1] SUPPRESSION TOTALE DES MOTS DE PASSE${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

for user in "${!USERS[@]}"; do
    if [ "$user" = "root" ]; then
        echo "  â†’ root (on garde le hash existant)"
    else
        # Supprimer complÃ¨tement le mot de passe
        passwd -d "$user" 2>/dev/null
        echo "  âœ“ $user â†’ mot de passe supprimÃ©"
    fi
done
echo ""

echo -e "${YELLOW}[Ã‰TAPE 2] DÃ‰VERROUILLAGE DE TOUS LES COMPTES${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

for user in "${!USERS[@]}"; do
    if [ "$user" != "root" ]; then
        # DÃ©verrouiller
        passwd -u "$user" 2>/dev/null
        usermod -U "$user" 2>/dev/null
        echo "  âœ“ $user dÃ©verrouillÃ©"
    fi
done
echo ""

echo -e "${YELLOW}[Ã‰TAPE 3] CRÃ‰ATION FORCÃ‰E DES NOUVEAUX MOTS DE PASSE${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

for user in "${!USERS[@]}"; do
    password="${USERS[$user]}"
    
    # MÃ©thode 1: chpasswd (PAM)
    echo "$user:$password" | chpasswd 2>/dev/null
    
    # MÃ©thode 2: Forcer avec passwd --stdin si disponible (RHEL/CentOS)
    if command -v passwd &> /dev/null; then
        echo "$password" | passwd --stdin "$user" 2>/dev/null
    fi
    
    echo "  âœ“ $user â†’ '$password' (forcÃ©)"
done
echo ""

echo -e "${YELLOW}[Ã‰TAPE 4] VÃ‰RIFICATION DES HASH DANS /etc/shadow${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

for user in "${!USERS[@]}"; do
    shadow_line=$(grep "^$user:" /etc/shadow 2>/dev/null)
    hash=$(echo "$shadow_line" | cut -d: -f2)
    
    if [ -n "$hash" ] && [ "$hash" != "!" ] && [ "$hash" != "!!" ] && [ "$hash" != "*" ]; then
        # VÃ©rifier que le hash commence par $ (hash valide)
        if [[ "$hash" == \$* ]]; then
            echo -e "  ${GREEN}âœ“${NC} $user â†’ Hash valide (${hash:0:10}...)"
        else
            echo -e "  ${RED}âœ—${NC} $user â†’ Hash INVALIDE: $hash"
        fi
    else
        echo -e "  ${RED}âœ—${NC} $user â†’ PAS DE HASH"
    fi
done
echo ""

echo -e "${YELLOW}[Ã‰TAPE 5] VÃ‰RIFICATION AVEC passwd -S${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

for user in "${!USERS[@]}"; do
    if [ "$user" != "root" ]; then
        status=$(passwd -S "$user" 2>/dev/null)
        echo "  $user: $status"
    fi
done
echo ""

echo -e "${YELLOW}[Ã‰TAPE 6] CONFIGURATION SSH (si pas dÃ©jÃ  fait)${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Backup
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.pwd.$(date +%s) 2>/dev/null

# Forcer les paramÃ¨tres
sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^#*UsePAM.*/UsePAM yes/' /etc/ssh/sshd_config

echo "  âœ“ PasswordAuthentication yes"
echo "  âœ“ PermitRootLogin yes"
echo "  âœ“ UsePAM yes"
echo ""

echo -e "${YELLOW}[Ã‰TAPE 7] REDÃ‰MARRAGE SSH${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

systemctl restart ssh 2>/dev/null || systemctl restart sshd 2>/dev/null

sleep 2

if systemctl is-active --quiet ssh 2>/dev/null || systemctl is-active --quiet sshd 2>/dev/null; then
    echo -e "${GREEN}âœ“ SSH redÃ©marrÃ© avec succÃ¨s${NC}"
else
    echo -e "${RED}âœ— Ã‰chec redÃ©marrage SSH${NC}"
    exit 1
fi
echo ""

echo -e "${YELLOW}[Ã‰TAPE 8] TEST LOCAL PIERRE${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Installer sshpass si nÃ©cessaire
if ! command -v sshpass &> /dev/null; then
    apt install -y sshpass -qq 2>/dev/null || yum install -y sshpass -q 2>/dev/null
fi

if command -v sshpass &> /dev/null; then
    # Nettoyer known_hosts
    ssh-keygen -R localhost 2>/dev/null > /dev/null
    ssh-keygen -R 127.0.0.1 2>/dev/null > /dev/null
    
    echo "Test connexion pierre@localhost..."
    if timeout 5 sshpass -p "pierre123" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null pierre@localhost "echo TEST_OK" 2>/dev/null | grep -q "TEST_OK"; then
        echo -e "${GREEN}âœ“âœ“âœ“ CONNEXION pierre@localhost â†’ SUCCÃˆS !${NC}"
        echo ""
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${GREEN}  ğŸ‰ LES MOTS DE PASSE FONCTIONNENT !${NC}"
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    else
        echo -e "${RED}âœ—âœ—âœ— CONNEXION pierre@localhost â†’ Ã‰CHEC${NC}"
        echo ""
        echo "DÃ©tails de l'erreur:"
        timeout 5 sshpass -p "pierre123" ssh -vv -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null pierre@localhost "echo TEST" 2>&1 | tail -20
    fi
else
    echo "sshpass non disponible - test manuel requis"
fi
echo ""

echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}  RÃ‰CAPITULATIF${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo "IP Serveur: $IP"
echo ""
echo "Comptes configurÃ©s:"
for user in "${!USERS[@]}"; do
    printf "  %-12s : %s\n" "$user" "${USERS[$user]}"
done
echo ""
echo "TEST DEPUIS KALI:"
echo "  ssh pierre@$IP"
echo "  Password: pierre123"
echo ""
echo "  ssh guillaume@$IP"
echo "  Password: 123"
echo ""
echo "Si Ã§a ne marche toujours pas:"
echo "  1. VÃ©rifier l'IP de Kali (ip a)"
echo "  2. VÃ©rifier le routage rÃ©seau"
echo "  3. VÃ©rifier le firewall (ufw status)"
echo "  4. Regarder les logs: tail -f /var/log/auth.log"
echo ""
