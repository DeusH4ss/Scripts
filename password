#!/bin/bash

##############################################
# CRÉATION FORCÉE DES MOTS DE PASSE
# Utilise passwd avec expect pour forcer
##############################################

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}════════════════════════════════════════${NC}"
echo -e "${BLUE}  CRÉATION FORCÉE MOTS DE PASSE${NC}"
echo -e "${BLUE}  Méthode alternative avec passwd${NC}"
echo -e "${BLUE}════════════════════════════════════════${NC}"
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}❌ Exécuter en root: sudo bash $0${NC}"
    exit 1
fi

# Utilisateurs à configurer
declare -A USERS
USERS[pierre]="pierre123"
USERS[guillaume]="123"
USERS[admin]="admin"
USERS[root]="toor"

echo -e "${YELLOW}[1] MÉTHODE 1: passwd avec --stdin (RHEL/CentOS)${NC}"
echo "────────────────────────────────────────"

for user in "${!USERS[@]}"; do
    password="${USERS[$user]}"
    
    # Tester si passwd supporte --stdin
    if echo "$password" | passwd --stdin "$user" 2>/dev/null; then
        echo -e "  ${GREEN}✓${NC} $user → '$password' (via --stdin)"
    else
        echo -e "  ${YELLOW}⚠${NC} $user → --stdin non supporté"
    fi
done
echo ""

echo -e "${YELLOW}[2] MÉTHODE 2: chpasswd avec options explicites${NC}"
echo "────────────────────────────────────────"

for user in "${!USERS[@]}"; do
    password="${USERS[$user]}"
    
    # Forcer avec chpasswd et méthode de cryptage explicite
    echo "$user:$password" | chpasswd -c SHA512 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "  ${GREEN}✓${NC} $user → chpasswd avec SHA512"
    else
        echo -e "  ${RED}✗${NC} $user → Échec"
    fi
done
echo ""

echo -e "${YELLOW}[3] MÉTHODE 3: Génération manuelle du hash et injection${NC}"
echo "────────────────────────────────────────"

for user in "${!USERS[@]}"; do
    password="${USERS[$user]}"
    
    # Générer le hash avec openssl
    if command -v openssl &> /dev/null; then
        # Générer un salt aléatoire
        salt=$(openssl rand -base64 6)
        # Générer le hash SHA-512
        hash=$(openssl passwd -6 -salt "$salt" "$password")
        
        # Injecter directement dans /etc/shadow
        if [ -n "$hash" ]; then
            # Sauvegarder /etc/shadow
            cp /etc/shadow /etc/shadow.backup.$(date +%s)
            
            # Remplacer le hash
            sed -i "s|^$user:[^:]*:|$user:$hash:|" /etc/shadow
            
            echo -e "  ${GREEN}✓${NC} $user → Hash SHA-512 généré et injecté"
        else
            echo -e "  ${RED}✗${NC} $user → Impossible de générer le hash"
        fi
    else
        echo -e "  ${YELLOW}⚠${NC} openssl non disponible"
    fi
done
echo ""

echo -e "${YELLOW}[4] VÉRIFICATION DES HASH DANS /etc/shadow${NC}"
echo "────────────────────────────────────────"

for user in "${!USERS[@]}"; do
    shadow_line=$(grep "^$user:" /etc/shadow 2>/dev/null)
    hash=$(echo "$shadow_line" | cut -d: -f2)
    
    if [ -n "$hash" ] && [ "$hash" != "!" ] && [ "$hash" != "!!" ] && [ "$hash" != "*" ] && [ "$hash" != "NP" ]; then
        # Vérifier que le hash commence par $ (hash valide)
        if [[ "$hash" == \$* ]]; then
            hash_type=$(echo "$hash" | cut -d'$' -f2)
            case "$hash_type" in
                1) algo="MD5" ;;
                5) algo="SHA-256" ;;
                6) algo="SHA-512" ;;
                *) algo="Unknown" ;;
            esac
            echo -e "  ${GREEN}✓${NC} $user → Hash $algo (${hash:0:20}...)"
        else
            echo -e "  ${RED}✗${NC} $user → Hash INVALIDE: $hash"
        fi
    else
        echo -e "  ${RED}✗${NC} $user → PAS DE HASH (valeur: $hash)"
    fi
done
echo ""

echo -e "${YELLOW}[5] VÉRIFICATION AVEC passwd -S${NC}"
echo "────────────────────────────────────────"

for user in "${!USERS[@]}"; do
    status=$(passwd -S "$user" 2>/dev/null)
    status_code=$(echo "$status" | awk '{print $2}')
    
    case "$status_code" in
        "P"|"PS")
            echo -e "  ${GREEN}✓${NC} $user: $status"
            ;;
        "NP")
            echo -e "  ${RED}✗${NC} $user: $status ${RED}(PAS DE MOT DE PASSE)${NC}"
            ;;
        "L"|"LK")
            echo -e "  ${YELLOW}⚠${NC} $user: $status (VERROUILLÉ)"
            ;;
        *)
            echo -e "  ${YELLOW}?${NC} $user: $status"
            ;;
    esac
done
echo ""

echo -e "${YELLOW}[6] TEST PRATIQUE: Authentification avec su${NC}"
echo "────────────────────────────────────────"

for user in pierre guillaume admin; do
    password="${USERS[$user]}"
    
    # Tester avec su
    echo "$password" | su - "$user" -c "echo 'AUTH_OK'" 2>/dev/null | grep -q "AUTH_OK"
    
    if [ $? -eq 0 ]; then
        echo -e "  ${GREEN}✓${NC} $user → Authentification réussie avec 'su'"
    else
        echo -e "  ${RED}✗${NC} $user → Authentification échouée avec 'su'"
    fi
done
echo ""

echo -e "${GREEN}════════════════════════════════════════${NC}"
echo -e "${GREEN}  RÉCAPITULATIF${NC}"
echo -e "${GREEN}════════════════════════════════════════${NC}"
echo ""
echo "Comptes configurés:"
for user in "${!USERS[@]}"; do
    printf "  %-12s : %s\n" "$user" "${USERS[$user]}"
done
echo ""
echo "Si les hash sont maintenant valides:"
echo "  → Redémarrer SSH: systemctl restart ssh"
echo "  → Tester: bash ssh-test-password.sh"
echo ""
echo "Si les hash sont toujours NP:"
echo "  → Problème avec PAM ou SSSD"
echo "  → Vérifier: systemctl status sssd"
echo "  → Vérifier: cat /etc/pam.d/common-password"
echo ""
