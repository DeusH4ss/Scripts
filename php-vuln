#!/bin/bash
#
# Script d'installation GLPI 9.4.5 (vulnérable CVE-2020-11060)
# Pour lab Iron4Software - Serveur mail 192.168.1.250
# Isolation complète de la BDD Roundcube
#

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}================================================${NC}"
echo -e "${GREEN}Installation GLPI 9.4.5 (Vulnérable CVE-2020-11060)${NC}"
echo -e "${GREEN}================================================${NC}"

# Configuration
GLPI_VERSION="9.4.5"
GLPI_URL="https://github.com/glpi-project/glpi/releases/download/${GLPI_VERSION}/glpi-${GLPI_VERSION}.tgz"
GLPI_DIR="/var/www/html/glpi"
GLPI_DB="glpi_db"
GLPI_USER="glpi_user"
GLPI_PASS="GlpiPass2024!"
MYSQL_ROOT_PASS=""

# Demander le mot de passe MySQL root
read -sp "Mot de passe MySQL root : " MYSQL_ROOT_PASS
echo

echo -e "\n${YELLOW}[1/8] Vérification des prérequis...${NC}"
# Vérifier si Apache et MySQL sont installés
if ! command -v apache2 &> /dev/null; then
    echo -e "${RED}Apache2 n'est pas installé${NC}"
    exit 1
fi

if ! command -v mysql &> /dev/null; then
    echo -e "${RED}MySQL n'est pas installé${NC}"
    exit 1
fi

echo -e "${YELLOW}[2/8] Installation des dépendances PHP...${NC}"
apt-get update
apt-get install -y \
    php php-mysql php-mbstring php-curl php-gd php-xml \
    php-ldap php-imap php-apcu php-xmlrpc php-cas \
    php-zip php-bz2 php-intl php-json

# Vérifier la version PHP
PHP_VERSION=$(php -r 'echo PHP_VERSION;' | cut -d'.' -f1,2)
echo -e "${GREEN}Version PHP détectée : ${PHP_VERSION}${NC}"

echo -e "\n${YELLOW}[3/8] Création de la base de données GLPI (isolée)...${NC}"
mysql -u root -p"${MYSQL_ROOT_PASS}" <<EOF
-- Créer la base de données GLPI
CREATE DATABASE IF NOT EXISTS ${GLPI_DB} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Créer l'utilisateur dédié
CREATE USER IF NOT EXISTS '${GLPI_USER}'@'localhost' IDENTIFIED BY '${GLPI_PASS}';

-- Donner tous les privilèges sur la BDD GLPI uniquement
GRANT ALL PRIVILEGES ON ${GLPI_DB}.* TO '${GLPI_USER}'@'localhost';
FLUSH PRIVILEGES;

-- Vérifier l'isolation
SELECT user, host FROM mysql.user WHERE user IN ('${GLPI_USER}', 'roundcube');
SHOW DATABASES;
EOF

echo -e "${GREEN}✓ Base de données ${GLPI_DB} créée et isolée${NC}"

echo -e "\n${YELLOW}[4/8] Téléchargement de GLPI ${GLPI_VERSION}...${NC}"
cd /tmp
wget -q --show-progress ${GLPI_URL}

echo -e "\n${YELLOW}[5/8] Extraction et installation...${NC}"
tar -xzf glpi-${GLPI_VERSION}.tgz
rm -rf ${GLPI_DIR}
mv glpi ${GLPI_DIR}

echo -e "\n${YELLOW}[6/8] Configuration des permissions...${NC}"
chown -R www-data:www-data ${GLPI_DIR}
chmod -R 755 ${GLPI_DIR}

# Permissions spécifiques pour les répertoires critiques
chmod -R 775 ${GLPI_DIR}/files
chmod -R 775 ${GLPI_DIR}/config

echo -e "\n${YELLOW}[7/8] Configuration Apache...${NC}"
cat > /etc/apache2/sites-available/glpi.conf <<EOF
# Configuration GLPI pour lab Iron4Software
Alias /glpi ${GLPI_DIR}

<Directory ${GLPI_DIR}>
    Options -Indexes +FollowSymLinks
    AllowOverride All
    Require all granted

    # PHP Settings pour GLPI
    php_value max_execution_time 600
    php_value memory_limit 256M
    php_value post_max_size 50M
    php_value upload_max_filesize 50M
</Directory>

# Répertoire des fichiers GLPI (vulnérable pour pentest)
<Directory ${GLPI_DIR}/files>
    Options +Indexes
    AllowOverride None
    Require all granted
</Directory>
EOF

# Activer le site et modules Apache
a2ensite glpi.conf
a2enmod rewrite
systemctl reload apache2

echo -e "${GREEN}✓ Configuration Apache créée : /glpi${NC}"

echo -e "\n${YELLOW}[8/8] Création du fichier de configuration BDD...${NC}"
# Créer le fichier de config pour automatiser l'installation
mkdir -p ${GLPI_DIR}/config
cat > ${GLPI_DIR}/config/config_db.php <<EOF
<?php
class DB extends DBmysql {
   public \$dbhost = 'localhost';
   public \$dbuser = '${GLPI_USER}';
   public \$dbpassword = '${GLPI_PASS}';
   public \$dbdefault = '${GLPI_DB}';
}
EOF

chown www-data:www-data ${GLPI_DIR}/config/config_db.php
chmod 640 ${GLPI_DIR}/config/config_db.php

# Récupérer l'IP du serveur
SERVER_IP=$(hostname -I | awk '{print $1}')

echo -e "\n${GREEN}================================================${NC}"
echo -e "${GREEN}Installation GLPI 9.4.5 terminée !${NC}"
echo -e "${GREEN}================================================${NC}"
echo -e "\n${YELLOW}Informations importantes :${NC}"
echo -e "URL d'accès      : http://${SERVER_IP}/glpi"
echo -e "Base de données  : ${GLPI_DB}"
echo -e "Utilisateur BDD  : ${GLPI_USER}"
echo -e "Mot de passe BDD : ${GLPI_PASS}"
echo -e "\n${YELLOW}Credentials GLPI par défaut :${NC}"
echo -e "Compte admin     : glpi / glpi"
echo -e "Compte tech      : tech / tech"
echo -e "Compte normal    : normal / normal"
echo -e "Compte post-only : post-only / postonly"
echo -e "\n${RED}⚠️  VULNÉRABILITÉ CVE-2020-11060${NC}"
echo -e "${RED}Cette version est volontairement vulnérable pour le pentest${NC}"
echo -e "${RED}Exploitation possible avec compte 'tech'${NC}"
echo -e "\n${YELLOW}Étapes suivantes :${NC}"
echo -e "1. Accéder à http://${SERVER_IP}/glpi"
echo -e "2. Suivre l'assistant d'installation (ou auto-configuré)"
echo -e "3. Se connecter avec tech/tech"
echo -e "4. Exploiter avec : ${GREEN}CVE-2020-11060${NC}"
echo -e "\n${YELLOW}Vérification isolation BDD :${NC}"
mysql -u root -p"${MYSQL_ROOT_PASS}" -e "SHOW DATABASES;" | grep -E "(glpi|roundcube)"

echo -e "\n${GREEN}Script terminé avec succès !${NC}"
