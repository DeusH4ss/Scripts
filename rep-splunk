#!/bin/bash

##############################################
# CONFIGURATION COMPLÃˆTE SPLUNK - VERSION CORRIGÃ‰E
# 4 Index + Dashboard + Forwarders + Fixes
##############################################

SPLUNK_HOME="/opt/splunk"
ADMIN_PASS="Admin123G4"
IP=$(hostname -I | awk '{print $1}')

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  CONFIGURATION COMPLÃˆTE SPLUNK - CORRIGÃ‰E"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 0 : INSTALLATION OUTILS MANQUANTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[0/6] Installation outils manquants..."

if ! command -v netstat &> /dev/null; then
    echo "  Installation net-tools..."
    apt update -qq
    apt install -y net-tools
    echo "  âœ“ net-tools installÃ©"
else
    echo "  âœ“ net-tools dÃ©jÃ  installÃ©"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 1 : CRÃ‰ATION FORCÃ‰E DES 4 INDEX
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[1/6] CrÃ©ation des 4 index..."

# Supprimer et recrÃ©er pour forcer
for idx in windows_server windows_client linux_server pfsense; do
    sudo -u splunk $SPLUNK_HOME/bin/splunk remove index $idx -auth admin:$ADMIN_PASS 2>/dev/null
    sudo -u splunk $SPLUNK_HOME/bin/splunk add index $idx -auth admin:$ADMIN_PASS 2>/dev/null && echo "  âœ“ $idx crÃ©Ã©"
done

echo ""
echo "Index crÃ©Ã©s - VÃ©rification:"
sudo -u splunk $SPLUNK_HOME/bin/splunk list index -auth admin:$ADMIN_PASS 2>/dev/null | grep -E "windows_server|windows_client|linux_server|pfsense" || echo "  âš  Index pas encore visibles"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 2 : CONFIGURATION PORT 9997 (FORCÃ‰E)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[2/6] Configuration port 9997..."

cat > $SPLUNK_HOME/etc/system/local/inputs.conf <<EOF
[splunktcp://9997]
disabled = false
connection_host = ip

[default]
host = splunk-indexer
EOF

chown splunk:splunk $SPLUNK_HOME/etc/system/local/inputs.conf
echo "  âœ“ inputs.conf crÃ©Ã©"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 3 : CRÃ‰ATION DASHBOARD (FORCÃ‰E)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[3/6] CrÃ©ation dashboard..."

# Supprimer ancien
rm -f $SPLUNK_HOME/etc/apps/search/local/data/ui/views/dashboard_iron4software.xml 2>/dev/null

# CrÃ©er rÃ©pertoire
mkdir -p $SPLUNK_HOME/etc/apps/search/local/data/ui/views

# CrÃ©er dashboard
cat > $SPLUNK_HOME/etc/apps/search/local/data/ui/views/dashboard_iron4software.xml <<'XMLEOF'
<form version="1.1">
  <label>ğŸ” Dashboard SÃ©curitÃ© Iron4Software - 4 Index</label>
  <description>âš ï¸ Dashboard incomplet - Exercice de dÃ©tection des manques critiques</description>
  
  <fieldset submitButton="false">
    <input type="time" token="time">
      <label>PÃ©riode</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <row>
    <panel>
      <html>
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px;">
          <h2>ğŸ” Exercice : Identification des Manques Critiques</h2>
          <p><strong>Mission : Identifier les informations CRITIQUES manquantes</strong></p>
          <ol>
            <li>Examiner chaque panel du dashboard</li>
            <li>Identifier ce qui manque (Ã©vÃ©nements, filtres, alertes)</li>
            <li>Expliquer pourquoi c est critique</li>
          </ol>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ“Š Windows Server</title>
      <single>
        <search>
          <query>index=windows_server source="WinEventLog:Security" | stats count</query>
        </search>
        <option name="underLabel">Ã‰vÃ©nements</option>
      </single>
    </panel>
    
    <panel>
      <title>ğŸ’» Windows Client</title>
      <single>
        <search>
          <query>index=windows_client source="WinEventLog:Security" | stats count</query>
        </search>
        <option name="underLabel">Ã‰vÃ©nements</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ§ Linux Server</title>
      <single>
        <search>
          <query>index=linux_server | stats count</query>
        </search>
        <option name="underLabel">Ã‰vÃ©nements</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ”¥ pfSense</title>
      <single>
        <search>
          <query>index=pfsense | stats count</query>
        </search>
        <option name="underLabel">Ã‰vÃ©nements</option>
      </single>
    </panel>
  </row>

  <row>
    <panel>
      <title>âœ… Connexions Windows RÃ©ussies (4624)</title>
      <table>
        <search>
          <query>index=windows_* EventCode=4624 | rex field=_raw "Account Name:\s+(?&lt;user&gt;\S+)" | stats count by index, user | sort -count | head 10</query>
        </search>
      </table>
    </panel>
    
    <panel>
      <title>ğŸ’» Hosts Actifs (Forwarders)</title>
      <table>
        <search>
          <query>index=* | stats count by host, index | sort -count</query>
        </search>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ“ˆ Timeline Authentifications</title>
      <chart>
        <search>
          <query>index=windows_* EventCode=4624 | timechart span=1h count by index</query>
        </search>
        <option name="charting.chart">line</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ” SSH Linux</title>
      <table>
        <search>
          <query>index=linux_server "Accepted password" | rex field=_raw "for (?&lt;user&gt;\S+) from (?&lt;src_ip&gt;[\d\.]+)" | stats count by user, src_ip | sort -count | head 10</query>
        </search>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <html>
        <div style="background-color: #f8d7da; padding: 15px; border-radius: 5px;">
          <h3>âš ï¸ MANQUES CRITIQUES</h3>
          <ul>
            <li>âŒ Ã‰checs authentification (EventCode 4625)</li>
            <li>âŒ Escalade privilÃ¨ges (EventCode 4672)</li>
            <li>âŒ Changements comptes</li>
            <li>âŒ Trafic firewall bloquÃ©</li>
            <li>âŒ Port scanning</li>
            <li>âŒ Connexions anormales</li>
            <li>âŒ ActivitÃ© hors heures</li>
            <li>âŒ Alertes et seuils</li>
          </ul>
        </div>
      </html>
    </panel>
  </row>
</form>
XMLEOF

chown -R splunk:splunk $SPLUNK_HOME/etc/apps/search/local
echo "  âœ“ Dashboard crÃ©Ã©: dashboard_iron4software.xml"

# VÃ©rifier crÃ©ation
if [ -f "$SPLUNK_HOME/etc/apps/search/local/data/ui/views/dashboard_iron4software.xml" ]; then
    echo "  âœ“ Fichier dashboard existe"
else
    echo "  âœ— ERREUR: Fichier dashboard non crÃ©Ã©"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 4 : REDÃ‰MARRAGE SPLUNK (FORCÃ‰)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[4/6] RedÃ©marrage Splunk..."

sudo -u splunk $SPLUNK_HOME/bin/splunk restart
echo ""
echo "  Attente 40 secondes..."
sleep 40
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 5 : RECHARGEMENT FORCÃ‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[5/6] Rechargement forcÃ© des configurations..."

# Recharger l'app search
curl -k -s -u admin:$ADMIN_PASS -X POST https://localhost:8089/services/apps/local/search/_reload 2>/dev/null && echo "  âœ“ App search rechargÃ©e"

# Recharger les dashboards
curl -k -s -u admin:$ADMIN_PASS -X POST https://localhost:8089/servicesNS/-/-/data/ui/views/_reload 2>/dev/null && echo "  âœ“ Dashboards rechargÃ©s"

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 6 : VÃ‰RIFICATIONS COMPLÃˆTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[6/6] VÃ©rifications..."
echo ""

# Port 9997
echo "â”â”â” PORT 9997 â”â”â”"
if netstat -tuln | grep ":9997" > /dev/null; then
    echo "âœ“ Port 9997 Ã‰COUTE"
    netstat -tuln | grep ":9997"
else
    echo "âœ— Port 9997 PAS OUVERT"
fi
echo ""

# Forwarders connectÃ©s
CONN=$(netstat -an 2>/dev/null | grep ":9997" | grep ESTABLISHED | wc -l)
echo "â”â”â” FORWARDERS â”â”â”"
echo "Forwarders connectÃ©s: $CONN"
if [ $CONN -gt 0 ]; then
    netstat -an | grep ":9997" | grep ESTABLISHED
fi
echo ""

# Index
echo "â”â”â” INDEX â”â”â”"
sudo -u splunk $SPLUNK_HOME/bin/splunk list index -auth admin:$ADMIN_PASS 2>/dev/null | grep -E "windows_server|windows_client|linux_server|pfsense" && echo "âœ“ Index visibles" || echo "âœ— Index pas visibles - RedÃ©marrer Splunk manuellement"
echo ""

# Dashboard
echo "â”â”â” DASHBOARD â”â”â”"
if [ -f "$SPLUNK_HOME/etc/apps/search/local/data/ui/views/dashboard_iron4software.xml" ]; then
    echo "âœ“ Fichier dashboard existe"
    ls -lh $SPLUNK_HOME/etc/apps/search/local/data/ui/views/dashboard_iron4software.xml
else
    echo "âœ— Fichier dashboard manquant"
fi
echo ""

# DonnÃ©es reÃ§ues
echo "â”â”â” DONNÃ‰ES PAR INDEX (24h) â”â”â”"
for idx in windows_server windows_client linux_server pfsense; do
    COUNT=$(sudo -u splunk $SPLUNK_HOME/bin/splunk search "index=$idx earliest=-24h | stats count" -auth admin:$ADMIN_PASS 2>/dev/null | grep -oP '\d+' | tail -1)
    if [ -n "$COUNT" ] && [ "$COUNT" -gt 0 ]; then
        echo "  âœ“ $idx: $COUNT Ã©vÃ©nements"
    else
        echo "  âœ— $idx: 0 Ã©vÃ©nements (forwarder pas configurÃ©)"
    fi
done
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰SUMÃ‰ FINAL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ACCÃˆS SPLUNK"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Interface Web: http://$IP:8000"
echo ""
echo "Dashboard: http://$IP:8000/app/search/dashboard_iron4software"
echo ""
echo "Login: admin"
echo "Pass: $ADMIN_PASS"
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  VÃ‰RIFICATIONS MANUELLES"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "1. VÃ©rifier index dans l'interface Web:"
echo "   Settings > Indexes"
echo "   Tu dois voir: windows_server, windows_client, linux_server, pfsense"
echo ""
echo "2. VÃ©rifier dashboard:"
echo "   Dashboards > Rechercher 'iron4software'"
echo "   Ou: http://$IP:8000/app/search/dashboard_iron4software"
echo ""
echo "3. Si dashboard pas visible, attendre 2 min puis:"
echo "   curl -k -u admin:$ADMIN_PASS -X POST https://localhost:8089/services/apps/local/search/_reload"
echo ""
echo "4. Relancer ce script pour vÃ©rifier:"
echo "   sudo bash $0"
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  CONFIGURATION FORWARDERS"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Indexer: $IP:9997"
echo ""
echo "Windows Server - outputs.conf:"
echo "[tcpout]"
echo "defaultGroup = indexer"
echo "[tcpout:indexer]"
echo "server = $IP:9997"
echo ""
echo "Windows Server - inputs.conf:"
echo "[default]"
echo "index = windows_server"
echo "[WinEventLog://Security]"
echo "disabled = false"
echo ""
echo "Puis: Restart-Service SplunkForwarder"
echo ""
echo "Linux/pfSense: MÃªmes instructions avec index appropriÃ©"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
