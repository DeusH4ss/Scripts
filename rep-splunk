#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCRIPT ULTIME - RESET COMPLET SPLUNK
# Efface TOUT et recommence Ã  zÃ©ro
# BasÃ© sur la documentation officielle Splunk
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SPLUNK_HOME="/opt/splunk"
SPLUNK_USER="splunk"
BACKUP_DIR="/root/splunk_final_backup_$(date +%Y%m%d_%H%M%S)"
LOG="/tmp/splunk_reset_$(date +%Y%m%d_%H%M%S).log"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

log() {
    echo -e "$1" | tee -a "$LOG"
}

clear
log "${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
log "${MAGENTA}â•‘  RESET COMPLET SPLUNK - EFFACE TOUT                   â•‘${NC}"
log "${MAGENTA}â•‘  Lab Iron4Software                                    â•‘${NC}"
log "${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

if [ "$EUID" -ne 0 ]; then 
   log "${RED}Lance avec: sudo bash $0${NC}"
   exit 1
fi

log "${YELLOW}Log: $LOG${NC}\n"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ã‰TAPE 1 : BACKUP RAPIDE (Optionnel)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "${CYAN}[1/6] BACKUP (configs seulement)...${NC}\n"

if [ -d "$SPLUNK_HOME" ]; then
    mkdir -p "$BACKUP_DIR"
    
    # Backup minimal (juste configs)
    [ -d "$SPLUNK_HOME/etc/system/local" ] && cp -rp $SPLUNK_HOME/etc/system/local "$BACKUP_DIR/" 2>/dev/null
    [ -d "$SPLUNK_HOME/etc/apps" ] && cp -rp $SPLUNK_HOME/etc/apps "$BACKUP_DIR/" 2>/dev/null
    
    log "${GREEN}âœ“ Backup minimal dans: $BACKUP_DIR${NC}"
    log "${YELLOW}(Tu peux restaurer manuellement si besoin)${NC}\n"
else
    log "${YELLOW}âš  Pas de Splunk existant${NC}\n"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ã‰TAPE 2 : ARRÃŠT TOTAL ET BRUTAL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "${CYAN}[2/6] ARRÃŠT BRUTAL DE TOUS LES PROCESSUS...${NC}\n"

# Tuer TOUT ce qui contient splunk
pkill -9 -f splunk 2>/dev/null
sleep 2

# VÃ©rifier
if pgrep -f splunk > /dev/null; then
    log "${YELLOW}Processus rÃ©sistent, force kill...${NC}"
    killall -9 splunkd mongod python 2>/dev/null
    sleep 2
fi

log "${GREEN}âœ“ Tous les processus tuÃ©s${NC}\n"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ã‰TAPE 3 : DÃ‰SINSTALLATION COMPLÃˆTE DU PAQUET
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "${CYAN}[3/6] DÃ‰SINSTALLATION PAQUET...${NC}\n"

# Debian/Ubuntu
if command -v dpkg &> /dev/null; then
    log "${YELLOW}SystÃ¨me Debian/Ubuntu dÃ©tectÃ©${NC}"
    
    # Purge complÃ¨te (supprime paquet + configs)
    dpkg --purge splunk 2>/dev/null
    apt-get purge -y splunk 2>/dev/null
    apt-get autoremove -y 2>/dev/null
    
    log "${GREEN}âœ“ Paquet Debian purgÃ©${NC}"

# RedHat/CentOS
elif command -v rpm &> /dev/null; then
    log "${YELLOW}SystÃ¨me RedHat/CentOS dÃ©tectÃ©${NC}"
    
    # DÃ©sinstallation RPM
    rpm -e splunk 2>/dev/null
    yum remove -y splunk 2>/dev/null
    
    log "${GREEN}âœ“ Paquet RPM dÃ©sinstallÃ©${NC}"
else
    log "${YELLOW}âš  Pas de gestionnaire de paquets dÃ©tectÃ©${NC}"
fi

log ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ã‰TAPE 4 : SUPPRESSION TOTALE DES FICHIERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "${CYAN}[4/6] SUPPRESSION TOTALE DE TOUS LES FICHIERS...${NC}\n"

# Supprimer COMPLÃˆTEMENT /opt/splunk
if [ -d "$SPLUNK_HOME" ]; then
    log "${YELLOW}Suppression de $SPLUNK_HOME...${NC}"
    rm -rf $SPLUNK_HOME
    log "${GREEN}âœ“ $SPLUNK_HOME supprimÃ©${NC}"
else
    log "${YELLOW}âš  $SPLUNK_HOME n'existe pas${NC}"
fi

# Supprimer autres emplacements possibles
rm -rf /var/log/splunk 2>/dev/null
rm -rf /var/run/splunk 2>/dev/null
rm -rf /etc/init.d/splunk 2>/dev/null
rm -rf /etc/systemd/system/splunk* 2>/dev/null

log "${GREEN}âœ“ Tous les fichiers Splunk supprimÃ©s${NC}\n"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ã‰TAPE 5 : TÃ‰LÃ‰CHARGEMENT ET INSTALLATION PROPRE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "${CYAN}[5/6] TÃ‰LÃ‰CHARGEMENT ET INSTALLATION...${NC}\n"

# Version Splunk (derniÃ¨re stable)
SPLUNK_VERSION="9.3.2"
SPLUNK_BUILD="d8bb32809498"

# DÃ©tecter OS et construire URL
if [ -f /etc/debian_version ]; then
    PKG="splunk-${SPLUNK_VERSION}-${SPLUNK_BUILD}-linux-2.6-amd64.deb"
    URL="https://download.splunk.com/products/splunk/releases/${SPLUNK_VERSION}/linux/${PKG}"
    PKG_TYPE="deb"
    log "${GREEN}âœ“ OS: Debian/Ubuntu${NC}"
elif [ -f /etc/redhat-release ]; then
    PKG="splunk-${SPLUNK_VERSION}-${SPLUNK_BUILD}.x86_64.rpm"
    URL="https://download.splunk.com/products/splunk/releases/${SPLUNK_VERSION}/linux/${PKG}"
    PKG_TYPE="rpm"
    log "${GREEN}âœ“ OS: RedHat/CentOS${NC}"
else
    log "${RED}âœ— OS non supportÃ©${NC}"
    exit 1
fi

PKG_PATH="/tmp/$PKG"

# TÃ©lÃ©charger si pas dÃ©jÃ  lÃ 
if [ ! -f "$PKG_PATH" ]; then
    log "${YELLOW}TÃ©lÃ©chargement Splunk ${SPLUNK_VERSION}...${NC}"
    log "${BLUE}URL: $URL${NC}\n"
    
    if command -v wget &> /dev/null; then
        wget -q --show-progress -O "$PKG_PATH" "$URL" 2>&1 | tee -a "$LOG"
    elif command -v curl &> /dev/null; then
        curl -# -o "$PKG_PATH" "$URL" 2>&1 | tee -a "$LOG"
    else
        log "${RED}âœ— wget ou curl manquant. Installe-le :${NC}"
        log "${BLUE}apt install wget -y${NC}"
        exit 1
    fi
    
    if [ ! -f "$PKG_PATH" ]; then
        log "${RED}âœ— Ã‰chec tÃ©lÃ©chargement${NC}"
        exit 1
    fi
fi

SIZE=$(du -h "$PKG_PATH" | cut -f1)
log "${GREEN}âœ“ Paquet prÃªt: $SIZE${NC}\n"

# Installation
log "${YELLOW}Installation...${NC}"

if [ "$PKG_TYPE" = "deb" ]; then
    dpkg -i "$PKG_PATH" 2>&1 | tee -a "$LOG"
    apt-get install -f -y 2>&1 | tee -a "$LOG"
else
    rpm -ivh "$PKG_PATH" 2>&1 | tee -a "$LOG"
fi

if [ ! -d "$SPLUNK_HOME" ]; then
    log "${RED}âœ— Installation Ã©chouÃ©e${NC}"
    exit 1
fi

log "${GREEN}âœ“ Splunk ${SPLUNK_VERSION} installÃ© proprement${NC}\n"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ã‰TAPE 6 : CONFIGURATION MINIMALE ET DÃ‰MARRAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "${CYAN}[6/6] CONFIGURATION ET DÃ‰MARRAGE...${NC}\n"

mkdir -p $SPLUNK_HOME/etc/system/local

# Password admin
cat > $SPLUNK_HOME/etc/system/local/user-seed.conf <<'EOF'
[user_info]
USERNAME = admin
PASSWORD = Admin123!
EOF

log "${GREEN}âœ“ Password: Admin123!${NC}"

# Port 9997
cat > $SPLUNK_HOME/etc/system/local/inputs.conf <<EOF
[splunktcp://9997]
disabled = false
EOF

log "${GREEN}âœ“ Port 9997${NC}"

# Port 8000
cat > $SPLUNK_HOME/etc/system/local/web.conf <<'EOF'
[settings]
httpport = 8000
enableSplunkWebSSL = false
startwebserver = 1
EOF

log "${GREEN}âœ“ Port 8000${NC}"

# Port 8089
cat > $SPLUNK_HOME/etc/system/local/server.conf <<EOF
[httpServer]
port = 8089
EOF

log "${GREEN}âœ“ Port 8089${NC}"

# Permissions
chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME
log "${GREEN}âœ“ Permissions${NC}\n"

# DÃ©marrage
log "${YELLOW}DÃ©marrage de Splunk...${NC}\n"
sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk start --accept-license --answer-yes --no-prompt 2>&1 | tee -a "$LOG"

log "\n${YELLOW}Attente 30 secondes...${NC}\n"
sleep 30

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VÃ‰RIFICATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "${CYAN}VÃ‰RIFICATIONS:${NC}\n"

# Processus
if pgrep -f "splunkd" > /dev/null; then
    log "${GREEN}âœ“ Splunkd actif (PID: $(pgrep splunkd | head -1))${NC}"
else
    log "${RED}âœ— Splunkd non actif${NC}"
fi

# Ports
P8000=$(netstat -tuln 2>/dev/null | grep ":8000")
P8089=$(netstat -tuln 2>/dev/null | grep ":8089")
P9997=$(netstat -tuln 2>/dev/null | grep ":9997")

OK=0
[ -n "$P8000" ] && log "${GREEN}âœ“ Port 8000 OUVERT${NC}" && OK=$((OK+1)) || log "${RED}âœ— Port 8000 FERMÃ‰${NC}"
[ -n "$P8089" ] && log "${GREEN}âœ“ Port 8089 OUVERT${NC}" && OK=$((OK+1)) || log "${RED}âœ— Port 8089 FERMÃ‰${NC}"
[ -n "$P9997" ] && log "${GREEN}âœ“ Port 9997 OUVERT${NC}" && OK=$((OK+1)) || log "${RED}âœ— Port 9997 FERMÃ‰${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰SULTAT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log ""
if [ $OK -eq 3 ]; then
    log "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    log "${GREEN}â•‘  âœ“âœ“âœ“ SUCCÃˆS TOTAL - Installation 100% propre        â•‘${NC}"
    log "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
else
    log "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    log "${YELLOW}â•‘  âš  Installation OK mais $OK/3 ports ouverts             â•‘${NC}"
    log "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    log "\n${YELLOW}DerniÃ¨res erreurs:${NC}"
    tail -50 $SPLUNK_HOME/var/log/splunk/splunkd.log 2>/dev/null | grep -i "ERROR" | tail -10
fi

# Infos
IP=$(hostname -I | awk '{print $1}')
log "\n${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
log "${GREEN}ğŸŒ URL: http://$IP:8000${NC}"
log "${GREEN}ğŸ‘¤ Username: admin${NC}"
log "${GREEN}ğŸ”‘ Password: Admin123!${NC}"
log "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

if [ $OK -eq 3 ]; then
    log "${YELLOW}Installation PROPRE terminÃ©e !${NC}"
    log "  â€¢ Version: Splunk ${SPLUNK_VERSION}"
    log "  â€¢ AUCUNE app problÃ©matique"
    log "  â€¢ Configuration minimale"
    log "  â€¢ PrÃªt pour les forwarders\n"
    
    log "${YELLOW}Prochaines Ã©tapes:${NC}"
    log "  1. Ouvre http://$IP:8000"
    log "  2. Login: admin / Admin123!"
    log "  3. Configure tes forwarders avec server=$IP:9997"
    log "  4. Installe apps si besoin depuis Splunkbase\n"
else
    log "${YELLOW}Diagnostic:${NC}"
    log "  â€¢ Logs: tail -100 /opt/splunk/var/log/splunk/splunkd.log"
    log "  â€¢ Status: sudo -u splunk /opt/splunk/bin/splunk status\n"
fi

log "${YELLOW}Fichiers:${NC}"
log "  â€¢ Backup: $BACKUP_DIR (supprimer si OK)"
log "  â€¢ Logs: $LOG\n"

log "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
