#!/bin/bash

##############################################
# SOLUTION DÃ‰FINITIVE - Index + Dashboard
# CrÃ©e indexes.conf + Dashboard via API REST
##############################################

SPLUNK_HOME="/opt/splunk"
ADMIN_PASS="Admin123G4"
IP=$(hostname -I | awk '{print $1}')

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  SOLUTION DÃ‰FINITIVE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 1 : CRÃ‰ER indexes.conf MANUELLEMENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[1/4] CrÃ©ation indexes.conf..."

cat > $SPLUNK_HOME/etc/system/local/indexes.conf <<'EOF'
[windows_server]
homePath = $SPLUNK_DB/windows_server/db
coldPath = $SPLUNK_DB/windows_server/colddb
thawedPath = $SPLUNK_DB/windows_server/thaweddb
maxTotalDataSizeMB = 512000
frozenTimePeriodInSecs = 188697600

[windows_client]
homePath = $SPLUNK_DB/windows_client/db
coldPath = $SPLUNK_DB/windows_client/colddb
thawedPath = $SPLUNK_DB/windows_client/thaweddb
maxTotalDataSizeMB = 512000
frozenTimePeriodInSecs = 188697600

[linux_server]
homePath = $SPLUNK_DB/linux_server/db
coldPath = $SPLUNK_DB/linux_server/colddb
thawedPath = $SPLUNK_DB/linux_server/thaweddb
maxTotalDataSizeMB = 512000
frozenTimePeriodInSecs = 188697600

[pfsense]
homePath = $SPLUNK_DB/pfsense/db
coldPath = $SPLUNK_DB/pfsense/colddb
thawedPath = $SPLUNK_DB/pfsense/thaweddb
maxTotalDataSizeMB = 512000
frozenTimePeriodInSecs = 188697600
EOF

chown splunk:splunk $SPLUNK_HOME/etc/system/local/indexes.conf
echo "âœ“ indexes.conf crÃ©Ã©"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 2 : REDÃ‰MARRER SPLUNK
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[2/4] RedÃ©marrage Splunk..."

sudo -u splunk $SPLUNK_HOME/bin/splunk restart
echo "Attente 40 secondes..."
sleep 40
echo "âœ“ OK"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 3 : CRÃ‰ER DASHBOARD VIA API REST
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[3/4] CrÃ©ation dashboard via API REST..."

# Supprimer ancien dashboard
curl -k -u "admin:$ADMIN_PASS" \
  -X DELETE \
  "https://localhost:8089/servicesNS/admin/search/data/ui/views/dashboard_iron4software" \
  2>/dev/null

sleep 2

# CrÃ©er nouveau dashboard via API
DASHBOARD_XML='<form version="1.1">
  <label>ğŸ” Dashboard SÃ©curitÃ© Iron4Software - 4 Index</label>
  <description>âš ï¸ Dashboard incomplet - Exercice de dÃ©tection des manques critiques</description>
  
  <fieldset submitButton="false">
    <input type="time" token="time">
      <label>PÃ©riode</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <row>
    <panel>
      <html>
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px;">
          <h2>ğŸ” Exercice : Identification des Manques Critiques</h2>
          <p><strong>Mission : Identifier les informations CRITIQUES manquantes</strong></p>
          <ol>
            <li>Examiner chaque panel du dashboard</li>
            <li>Identifier ce qui manque (Ã©vÃ©nements, filtres, alertes)</li>
            <li>Expliquer pourquoi c est critique</li>
          </ol>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ“Š Windows Server</title>
      <single>
        <search>
          <query>index=windows_server source="WinEventLog:Security" | stats count</query>
        </search>
        <option name="underLabel">Ã‰vÃ©nements</option>
      </single>
    </panel>
    
    <panel>
      <title>ğŸ’» Windows Client</title>
      <single>
        <search>
          <query>index=windows_client source="WinEventLog:Security" | stats count</query>
        </search>
        <option name="underLabel">Ã‰vÃ©nements</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ§ Linux Server</title>
      <single>
        <search>
          <query>index=linux_server | stats count</query>
        </search>
        <option name="underLabel">Ã‰vÃ©nements</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ”¥ pfSense</title>
      <single>
        <search>
          <query>index=pfsense | stats count</query>
        </search>
        <option name="underLabel">Ã‰vÃ©nements</option>
      </single>
    </panel>
  </row>

  <row>
    <panel>
      <title>âœ… Connexions Windows RÃ©ussies (4624)</title>
      <table>
        <search>
          <query>index=windows_* EventCode=4624 | rex field=_raw "Account Name:\s+(?&lt;user&gt;\S+)" | stats count by index, user | sort -count | head 10</query>
        </search>
      </table>
    </panel>
    
    <panel>
      <title>ğŸ’» Hosts Actifs (Forwarders)</title>
      <table>
        <search>
          <query>index=* | stats count by host, index | sort -count</query>
        </search>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ“ˆ Timeline Authentifications</title>
      <chart>
        <search>
          <query>index=windows_* EventCode=4624 | timechart span=1h count by index</query>
        </search>
        <option name="charting.chart">line</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ” SSH Linux</title>
      <table>
        <search>
          <query>index=linux_server "Accepted password" | rex field=_raw "for (?&lt;user&gt;\S+) from (?&lt;src_ip&gt;[\d\.]+)" | stats count by user, src_ip | sort -count | head 10</query>
        </search>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <html>
        <div style="background-color: #f8d7da; padding: 15px; border-radius: 5px;">
          <h3>âš ï¸ MANQUES CRITIQUES</h3>
          <ul>
            <li>âŒ Ã‰checs authentification (EventCode 4625)</li>
            <li>âŒ Escalade privilÃ¨ges (EventCode 4672)</li>
            <li>âŒ Changements comptes</li>
            <li>âŒ Trafic firewall bloquÃ©</li>
            <li>âŒ Port scanning</li>
            <li>âŒ Connexions anormales</li>
            <li>âŒ ActivitÃ© hors heures</li>
            <li>âŒ Alertes et seuils</li>
          </ul>
        </div>
      </html>
    </panel>
  </row>
</form>'

# CrÃ©er via API
RESPONSE=$(curl -k -s -u "admin:$ADMIN_PASS" \
  -X POST \
  "https://localhost:8089/servicesNS/admin/search/data/ui/views" \
  --data-urlencode "name=dashboard_iron4software" \
  --data-urlencode "eai:data=$DASHBOARD_XML" \
  -w "\nHTTP:%{http_code}")

HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP:" | cut -d':' -f2)

if [[ "$HTTP_CODE" == "201" ]] || [[ "$HTTP_CODE" == "200" ]]; then
    echo "âœ“ Dashboard crÃ©Ã© via API"
    
    # DÃ©finir permissions
    curl -k -s -u "admin:$ADMIN_PASS" \
      -X POST \
      "https://localhost:8089/servicesNS/admin/search/data/ui/views/dashboard_iron4software/acl" \
      -d "sharing=app" \
      -d "owner=admin" \
      -d "perms.read=*" \
      > /dev/null
    
    echo "âœ“ Permissions configurÃ©es"
else
    echo "âš  Code HTTP: $HTTP_CODE"
    echo "$RESPONSE" | grep -v "HTTP:"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 4 : VÃ‰RIFICATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[4/4] VÃ©rifications..."
echo ""

echo "â”â”â” INDEX â”â”â”"
if curl -k -s -u "admin:$ADMIN_PASS" \
  "https://localhost:8089/services/data/indexes" | grep -q "windows_server"; then
    echo "âœ“ windows_server visible"
else
    echo "âœ— windows_server pas visible"
fi

if curl -k -s -u "admin:$ADMIN_PASS" \
  "https://localhost:8089/services/data/indexes" | grep -q "windows_client"; then
    echo "âœ“ windows_client visible"
else
    echo "âœ— windows_client pas visible"
fi

if curl -k -s -u "admin:$ADMIN_PASS" \
  "https://localhost:8089/services/data/indexes" | grep -q "linux_server"; then
    echo "âœ“ linux_server visible"
else
    echo "âœ— linux_server pas visible"
fi

if curl -k -s -u "admin:$ADMIN_PASS" \
  "https://localhost:8089/services/data/indexes" | grep -q "pfsense"; then
    echo "âœ“ pfsense visible"
else
    echo "âœ— pfsense pas visible"
fi
echo ""

echo "â”â”â” DASHBOARD â”â”â”"
if curl -k -s -u "admin:$ADMIN_PASS" \
  "https://localhost:8089/servicesNS/admin/search/data/ui/views/dashboard_iron4software" | grep -q "dashboard_iron4software"; then
    echo "âœ“ Dashboard visible via API"
else
    echo "âœ— Dashboard pas visible"
fi
echo ""

echo "â”â”â” PORT 9997 â”â”â”"
if netstat -tuln 2>/dev/null | grep ":9997" > /dev/null; then
    echo "âœ“ Port 9997 Ã‰COUTE"
else
    echo "âœ— Port 9997 pas ouvert"
fi
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ACCÃˆS"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Interface: http://$IP:8000"
echo "Dashboard: http://$IP:8000/app/search/dashboard_iron4software"
echo ""
echo "Login: admin"
echo "Pass: $ADMIN_PASS"
echo ""
echo "Dans l'interface web :"
echo "  - Settings > Indexes â†’ Tu dois voir les 4 index"
echo "  - Dashboards â†’ Cherche 'iron4software'"
echo ""
echo "Si toujours pas visible, attendre 2 min"
echo "puis F5 (rafraÃ®chir) le navigateur"
echo ""
