#!/bin/bash
# Script minimal - Lance et c'est tout

echo "=== RESET SPLUNK ==="
echo ""

# Kill
echo "1. Kill processus..."
killall -9 splunkd mongod python 2>/dev/null || true
pkill -9 -f splunk 2>/dev/null || true
sleep 2

# Purge
echo "2. Purge paquet..."
dpkg --purge splunk 2>/dev/null || true
apt-get purge -y splunk 2>/dev/null || true

# Delete
echo "3. Suppression..."
rm -rf /opt/splunk
rm -rf /var/log/splunk

# Download
echo "4. Téléchargement..."
cd /tmp
if [ ! -f splunk-9.3.2-d8bb32809498-linux-2.6-amd64.deb ]; then
    wget -q --show-progress https://download.splunk.com/products/splunk/releases/9.3.2/linux/splunk-9.3.2-d8bb32809498-linux-2.6-amd64.deb
fi

# Install
echo "5. Installation..."
dpkg -i splunk-9.3.2-d8bb32809498-linux-2.6-amd64.deb
apt-get install -f -y

# Config
echo "6. Configuration..."
mkdir -p /opt/splunk/etc/system/local

cat > /opt/splunk/etc/system/local/user-seed.conf <<'EOF'
[user_info]
USERNAME = admin
PASSWORD = Admin123!
EOF

cat > /opt/splunk/etc/system/local/inputs.conf <<'EOF'
[splunktcp://9997]
disabled = false
EOF

cat > /opt/splunk/etc/system/local/web.conf <<'EOF'
[settings]
httpport = 8000
enableSplunkWebSSL = false
startwebserver = 1
EOF

chown -R splunk:splunk /opt/splunk

# Start
echo "7. Démarrage..."
sudo -u splunk /opt/splunk/bin/splunk start --accept-license --answer-yes --no-prompt

echo ""
echo "Attente 30 secondes..."
sleep 30

echo ""
echo "=== VÉRIFICATION ==="
netstat -tuln | grep -E "8000|8089|9997"

echo ""
echo "==========================="
echo "URL: http://$(hostname -I | awk '{print $1}'):8000"
echo "User: admin"
echo "Pass: Admin123!"
echo "==========================="
