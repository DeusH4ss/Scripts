#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCRIPT TOUT-EN-UN V2 - Diagnostic et RÃ©paration Splunk AGGRESSIF
# Lab Iron4Software - RÃ©sout TOUS les problÃ¨mes + Safe-Mode
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SPLUNK_HOME="/opt/splunk"
SPLUNK_USER="splunk"
LOG_FILE="/tmp/splunk_repair_$(date +%Y%m%d_%H%M%S).log"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

PROBLEMS_FOUND=0
PROBLEMS_FIXED=0

# Fonction de logging
log() {
    echo -e "$1" | tee -a "$LOG_FILE"
}

separator() {
    log "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

header() {
    log "\n${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    log "${CYAN}â•‘  $1${NC}"
    log "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

problem() {
    PROBLEMS_FOUND=$((PROBLEMS_FOUND+1))
    log "${RED}âœ— PROBLÃˆME #$PROBLEMS_FOUND: $1${NC}"
}

fix() {
    PROBLEMS_FIXED=$((PROBLEMS_FIXED+1))
    log "${GREEN}âœ“ RÃ‰PARÃ‰: $1${NC}"
}

info() {
    log "${YELLOW}â„¹ $1${NC}"
}

success() {
    log "${GREEN}âœ“ $1${NC}"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DÃ‰BUT DU SCRIPT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

clear
header "DIAGNOSTIC ET RÃ‰PARATION AUTOMATIQUE SPLUNK V2"

log "${MAGENTA}Analyse AGRESSIVE avec dÃ©tection splunk_assist...${NC}"
log "${MAGENTA}Logs dÃ©taillÃ©s: $LOG_FILE${NC}\n"

# VÃ©rification root
if [ "$EUID" -ne 0 ]; then 
   log "${RED}[ERREUR] Lance avec sudo: sudo bash $0${NC}"
   exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 1 : ARRÃŠT PROPRE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

header "PHASE 1/5 : ARRÃŠT PROPRE DE SPLUNK"

if pgrep -f "splunkd" > /dev/null; then
    info "Splunk dÃ©tectÃ© en cours d'exÃ©cution, arrÃªt..."
    sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk stop 2>&1 | tee -a "$LOG_FILE"
    sleep 3
fi

# ArrÃªt forcÃ© si nÃ©cessaire
if pgrep -f "splunkd" > /dev/null; then
    info "ArrÃªt forcÃ© des processus rÃ©calcitrants..."
    pkill -9 splunkd
    pkill -9 mongod
    pkill -9 -f splunk
    sleep 2
    success "Tous les processus Splunk arrÃªtÃ©s"
else
    success "Splunk arrÃªtÃ© proprement"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 2 : DIAGNOSTIC ET NETTOYAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

header "PHASE 2/5 : DIAGNOSTIC ET NETTOYAGE"

# VÃ©rification espace disque
DISK_USAGE=$(df -h $SPLUNK_HOME | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 85 ]; then
    problem "Espace disque critique: ${DISK_USAGE}%"
    info "Nettoyage des indexes internes..."
    rm -rf $SPLUNK_HOME/var/lib/splunk/_audit/db/* 2>/dev/null
    rm -rf $SPLUNK_HOME/var/lib/splunk/_internal/db/* 2>/dev/null
    fix "Espace libÃ©rÃ©"
else
    success "Espace disque OK: ${DISK_USAGE}%"
fi

# Nettoyage fichiers temporaires
info "Nettoyage des fichiers temporaires..."
rm -rf $SPLUNK_HOME/var/run/splunk/* 2>/dev/null
rm -rf $SPLUNK_HOME/var/lib/splunk/kvstore/*.lock 2>/dev/null
rm -rf $SPLUNK_HOME/var/lib/splunk/fishbucket/* 2>/dev/null
success "Fichiers temporaires nettoyÃ©s"

# Permissions
info "Correction des permissions..."
chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME
chmod +x $SPLUNK_HOME/bin/splunk
success "Permissions corrigÃ©es"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 3 : RESET DE LA LICENCE (CRITIQUE + AGGRESSIF)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

header "PHASE 3/5 : RESET LICENCE + DÃ‰SACTIVATION APPS PROBLÃ‰MATIQUES"

info "Analyse approfondie des logs..."
LICENSE_ISSUES=false
SPLUNK_ASSIST_ISSUES=false

if grep -q "LicenseRestriction\|HTTP 402" $SPLUNK_HOME/var/log/splunk/splunkd.log 2>/dev/null; then
    problem "Licence expirÃ©e ou restreinte dÃ©tectÃ©e (HTTP 402)"
    LICENSE_ISSUES=true
fi

if grep -q "splunk_assist.*ERROR\|splunk_assist.*LicenseRestriction" $SPLUNK_HOME/var/log/splunk/splunkd.log 2>/dev/null; then
    problem "App splunk_assist bloque Splunk avec erreurs de licence"
    SPLUNK_ASSIST_ISSUES=true
fi

# CRITIQUE : DÃ©sactiver splunk_assist EN PREMIER
if [ -d "$SPLUNK_HOME/etc/apps/splunk_assist" ]; then
    if [ "$SPLUNK_ASSIST_ISSUES" = true ]; then
        info "DÃ©sactivation IMMÃ‰DIATE de splunk_assist (BLOQUE TOUT)..."
        mv $SPLUNK_HOME/etc/apps/splunk_assist $SPLUNK_HOME/etc/apps/splunk_assist.DISABLED 2>/dev/null
        fix "App splunk_assist dÃ©sactivÃ©e (empÃªchait l'ouverture des ports)"
    else
        info "splunk_assist prÃ©sente - dÃ©sactivation prÃ©ventive..."
        mv $SPLUNK_HOME/etc/apps/splunk_assist $SPLUNK_HOME/etc/apps/splunk_assist.DISABLED 2>/dev/null
        fix "App splunk_assist dÃ©sactivÃ©e prÃ©ventivement"
    fi
fi

# Reset COMPLET et PROFOND de la licence
if [ "$LICENSE_ISSUES" = true ] || [ "$SPLUNK_ASSIST_ISSUES" = true ]; then
    info "Reset COMPLET de la licence (nettoyage PROFOND)..."
    
    # Supprimer TOUS les fichiers de licence
    rm -rf $SPLUNK_HOME/etc/licenses/enterprise/* 2>/dev/null
    rm -rf $SPLUNK_HOME/etc/licenses/download-trial/* 2>/dev/null
    rm -f $SPLUNK_HOME/etc/instance.cfg 2>/dev/null
    rm -rf $SPLUNK_HOME/var/lib/splunk/license* 2>/dev/null
    
    # Nettoyer KVStore COMPLÃˆTEMENT (contient des infos de licence)
    info "Nettoyage KVStore (contient Ã©tat licence)..."
    rm -rf $SPLUNK_HOME/var/lib/splunk/kvstore/* 2>/dev/null
    
    # Nettoyer fishbucket
    rm -rf $SPLUNK_HOME/var/lib/splunk/fishbucket/* 2>/dev/null
    
    fix "Licence COMPLÃˆTEMENT nettoyÃ©e - nouvelle pÃ©riode forcÃ©e"
else
    success "Pas de problÃ¨me de licence dÃ©tectÃ©"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 4 : CONFIGURATION FORWARDERS (PORT 9997)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

header "PHASE 4/5 : CONFIGURATION PORT RÃ‰CEPTION (9997)"

# VÃ©rifier si inputs.conf existe
if [ ! -f "$SPLUNK_HOME/etc/system/local/inputs.conf" ]; then
    problem "inputs.conf manquant - port 9997 ne peut pas s'ouvrir"
    
    info "CrÃ©ation de inputs.conf..."
    cat > $SPLUNK_HOME/etc/system/local/inputs.conf <<EOF
[default]
host = $(hostname)

[splunktcp://9997]
disabled = false
connection_host = ip

[splunktcp-ssl:9998]
disabled = true
EOF
    
    chown $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/system/local/inputs.conf
    fix "inputs.conf crÃ©Ã© avec port 9997"
else
    # VÃ©rifier si le port 9997 est configurÃ©
    if ! grep -q "splunktcp://9997" $SPLUNK_HOME/etc/system/local/inputs.conf; then
        problem "Port 9997 non configurÃ© dans inputs.conf"
        
        cat >> $SPLUNK_HOME/etc/system/local/inputs.conf <<EOF

[splunktcp://9997]
disabled = false
connection_host = ip
EOF
        fix "Port 9997 ajoutÃ© Ã  inputs.conf"
    else
        success "inputs.conf existe et port 9997 configurÃ©"
    fi
fi

# VÃ©rifier/crÃ©er web.conf
if [ ! -f "$SPLUNK_HOME/etc/system/local/web.conf" ]; then
    info "CrÃ©ation de web.conf pour port 8000..."
    cat > $SPLUNK_HOME/etc/system/local/web.conf <<EOF
[settings]
httpport = 8000
enableSplunkWebSSL = false
startwebserver = 1
EOF
    chown $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/etc/system/local/web.conf
    fix "web.conf crÃ©Ã©"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 5 : REDÃ‰MARRAGE ET VÃ‰RIFICATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

header "PHASE 5/5 : REDÃ‰MARRAGE ET VÃ‰RIFICATION"

info "DÃ©marrage de Splunk avec nouvelle configuration..."
sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk start --accept-license --answer-yes --no-prompt 2>&1 | tee -a "$LOG_FILE"

# Attendre le dÃ©marrage complet
info "Attente du dÃ©marrage complet (20 secondes)..."
sleep 20

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VÃ‰RIFICATIONS FINALES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

header "VÃ‰RIFICATIONS FINALES"

# Test 1 : Processus Splunk
if pgrep -f "splunkd" > /dev/null; then
    success "Splunkd actif (PID: $(pgrep -f splunkd | head -1))"
else
    problem "Splunkd n'est pas dÃ©marrÃ©"
fi

# Test 2 : Ports rÃ©seau
log "\n${CYAN}VÃ©rification des ports rÃ©seau:${NC}"
PORT_8000=$(netstat -tuln 2>/dev/null | grep ":8000" || echo "")
PORT_8089=$(netstat -tuln 2>/dev/null | grep ":8089" || echo "")
PORT_9997=$(netstat -tuln 2>/dev/null | grep ":9997" || echo "")

PORTS_OPEN=0

if [ -n "$PORT_8000" ]; then
    success "Port 8000 (Web UI) : OUVERT"
    PORTS_OPEN=$((PORTS_OPEN+1))
else
    problem "Port 8000 (Web UI) : FERMÃ‰"
fi

if [ -n "$PORT_8089" ]; then
    success "Port 8089 (Management) : OUVERT"
    PORTS_OPEN=$((PORTS_OPEN+1))
else
    problem "Port 8089 (Management) : FERMÃ‰"
fi

if [ -n "$PORT_9997" ]; then
    success "Port 9997 (Forwarders) : OUVERT âœ“âœ“âœ“"
    PORTS_OPEN=$((PORTS_OPEN+1))
    CONNECTED=$(netstat -an | grep ":9997" | grep ESTABLISHED | wc -l)
    if [ $CONNECTED -gt 0 ]; then
        success "  â†’ $CONNECTED forwarder(s) connectÃ©(s)"
    else
        info "  â†’ Aucun forwarder connectÃ© (normal si pas encore configurÃ©s)"
    fi
else
    problem "Port 9997 (Forwarders) : FERMÃ‰"
fi

# DÃ©tection critique : Aucun port ouvert
if [ $PORTS_OPEN -eq 0 ] && pgrep -f "splunkd" > /dev/null; then
    problem "CRITIQUE : Splunk tourne mais AUCUN port n'est ouvert !"
    info "Les apps restantes bloquent peut-Ãªtre le dÃ©marrage..."
    
    log "\n${YELLOW}DerniÃ¨res erreurs dans les logs:${NC}"
    tail -30 $SPLUNK_HOME/var/log/splunk/splunkd.log | grep -i "ERROR\|FATAL" | tail -10 | tee -a "$LOG_FILE"
    
    log "\n${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    log "${RED}â•‘  OPTION SAFE-MODE DISPONIBLE                       â•‘${NC}"
    log "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    read -p "RedÃ©marrer en Safe-Mode (sans apps)? (o/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[OoYy]$ ]]; then
        info "RedÃ©marrage en Safe-Mode..."
        sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk stop
        sleep 3
        sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk start --safe-mode --accept-license --answer-yes
        sleep 20
        
        log "\n${YELLOW}VÃ©rification ports aprÃ¨s Safe-Mode:${NC}"
        netstat -tuln | grep -E "8000|8089|9997"
    fi
fi

# Test 3 : Licence
log "\n${CYAN}VÃ©rification de la licence:${NC}"
LICENSE_MSG=$(sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk list licenser-messages 2>/dev/null)
echo "$LICENSE_MSG" | tee -a "$LOG_FILE"

if echo "$LICENSE_MSG" | grep -qi "expired\|violation\|invalid"; then
    problem "ProblÃ¨me de licence persistant"
    info "Solution: installer une licence Free permanente"
else
    success "Licence OK - nouvelle pÃ©riode d'Ã©valuation active"
fi

# Test 4 : Recherche de donnÃ©es
log "\n${CYAN}Test de recherche (derniÃ¨re heure):${NC}"
DATA_COUNT=$(sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk search "index=* earliest=-1h | stats count" -maxout 1 2>/dev/null | grep -oP '\d+' | tail -1)
if [ -n "$DATA_COUNT" ] && [ "$DATA_COUNT" -gt 0 ]; then
    success "DonnÃ©es indexÃ©es trouvÃ©es: $DATA_COUNT Ã©vÃ©nements"
else
    info "Aucune donnÃ©e rÃ©cente (normal si forwarders pas encore connectÃ©s)"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RAPPORT FINAL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

separator
log ""
header "RAPPORT FINAL"

if [ $PROBLEMS_FOUND -eq 0 ]; then
    log "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    log "${GREEN}â•‘  âœ“âœ“âœ“ AUCUN PROBLÃˆME DÃ‰TECTÃ‰ âœ“âœ“âœ“              â•‘${NC}"
    log "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
else
    log "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    log "${YELLOW}â•‘  ProblÃ¨mes trouvÃ©s: $PROBLEMS_FOUND                          â•‘${NC}"
    log "${YELLOW}â•‘  ProblÃ¨mes rÃ©parÃ©s: $PROBLEMS_FIXED                         â•‘${NC}"
    log "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
fi

# Informations de connexion
log "\n${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
log "${CYAN}INFORMATIONS DE CONNEXION${NC}"
log "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
SERVER_IP=$(hostname -I | awk '{print $1}')
log "${GREEN}ğŸŒ Interface Web: http://$SERVER_IP:8000${NC}"
log "${GREEN}ğŸ“Š Username: admin / Password: changeme (ou ton mot de passe)${NC}"
log ""

# Actions recommandÃ©es
log "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
log "${CYAN}ACTIONS RECOMMANDÃ‰ES${NC}"
log "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

if [ $PORTS_OPEN -eq 0 ]; then
    log "${RED}1. URGENT: Aucun port ouvert${NC}"
    log "${YELLOW}   â†’ Voir logs: tail -50 /opt/splunk/var/log/splunk/splunkd.log${NC}"
    log "${YELLOW}   â†’ Essayer Safe-Mode: sudo -u splunk /opt/splunk/bin/splunk start --safe-mode${NC}"
elif [ -z "$PORT_9997" ]; then
    log "${RED}1. Port 9997 pas ouvert${NC}"
    log "${YELLOW}   â†’ VÃ©rifie inputs.conf: cat /opt/splunk/etc/system/local/inputs.conf${NC}"
fi

if echo "$LICENSE_MSG" | grep -qi "expired\|violation"; then
    log "\n${YELLOW}2. Installer une licence Free permanente:${NC}"
    log "   a) TÃ©lÃ©charge: https://www.splunk.com/en_us/download.html"
    log "   b) Installe: sudo -u splunk /opt/splunk/bin/splunk add licenses /chemin/splunk.license"
    log "   c) Limite: 500 MB/jour (suffisant pour un lab)"
fi

log "\n${YELLOW}3. VÃ©rifier les forwarders:${NC}"
log "   â€¢ Settings > Forwarding and receiving > Configure receiving"
log "   â€¢ Recherche: ${BLUE}index=* earliest=-1h | stats count by host${NC}"

log "\n${YELLOW}4. Configuration forwarders Windows/Linux:${NC}"
log "   â€¢ Fichier: outputs.conf"
log "   â€¢ Contenu: server = $SERVER_IP:9997"

# Logs dÃ©taillÃ©s
separator
log "\n${MAGENTA}Logs complets sauvegardÃ©s dans: $LOG_FILE${NC}"
log "${YELLOW}Commandes utiles:${NC}"
log "  â€¢ Statut: ${BLUE}sudo -u splunk /opt/splunk/bin/splunk status${NC}"
log "  â€¢ Logs live: ${BLUE}tail -f /opt/splunk/var/log/splunk/splunkd.log${NC}"
log "  â€¢ Safe-Mode: ${BLUE}sudo -u splunk /opt/splunk/bin/splunk start --safe-mode${NC}"
log "  â€¢ Relancer ce script: ${BLUE}sudo bash $0${NC}"
log ""

# RÃ©sumÃ© visuel
if [ $PORTS_OPEN -eq 3 ]; then
    log "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    log "${GREEN}â•‘  âœ“âœ“âœ“ Splunk 100% opÃ©rationnel - Tous ports ouverts â•‘${NC}"
    log "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
elif [ $PORTS_OPEN -gt 0 ]; then
    log "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    log "${YELLOW}â•‘  âš  Splunk partiellement fonctionnel ($PORTS_OPEN/3 ports) â•‘${NC}"
    log "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
else
    log "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    log "${RED}â•‘  âœ— ProblÃ¨mes critiques - Utiliser Safe-Mode        â•‘${NC}"
    log "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
fi

log ""
