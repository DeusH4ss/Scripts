#!/bin/bash

##############################################
# CONFIGURATION COMPLÃˆTE SPLUNK
# 4 Index + Dashboard + VÃ©rification Forwarders
##############################################

SPLUNK_HOME="/opt/splunk"
ADMIN_PASS="Admin123G4"
IP=$(hostname -I | awk '{print $1}')

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  CONFIGURATION COMPLÃˆTE SPLUNK - Iron4Software"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 1 : CRÃ‰ATION DES 4 INDEX
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[1/5] CrÃ©ation des 4 index..."

sudo -u splunk $SPLUNK_HOME/bin/splunk add index windows_server -auth admin:$ADMIN_PASS 2>/dev/null || echo "  windows_server existe dÃ©jÃ "
sudo -u splunk $SPLUNK_HOME/bin/splunk add index windows_client -auth admin:$ADMIN_PASS 2>/dev/null || echo "  windows_client existe dÃ©jÃ "
sudo -u splunk $SPLUNK_HOME/bin/splunk add index linux_server -auth admin:$ADMIN_PASS 2>/dev/null || echo "  linux_server existe dÃ©jÃ "
sudo -u splunk $SPLUNK_HOME/bin/splunk add index pfsense -auth admin:$ADMIN_PASS 2>/dev/null || echo "  pfsense existe dÃ©jÃ "

echo ""
echo "âœ“ Index crÃ©Ã©s:"
sudo -u splunk $SPLUNK_HOME/bin/splunk list index -auth admin:$ADMIN_PASS | grep -E "windows_server|windows_client|linux_server|pfsense"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 2 : CONFIGURATION PORT 9997
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[2/5] Configuration port 9997..."

cat > $SPLUNK_HOME/etc/system/local/inputs.conf <<EOF
[splunktcp://9997]
disabled = false
connection_host = ip

[default]
host = splunk-indexer
EOF

chown splunk:splunk $SPLUNK_HOME/etc/system/local/inputs.conf

# RedÃ©marrer si port pas ouvert
if ! netstat -tuln | grep ":9997" > /dev/null; then
    echo "  RedÃ©marrage Splunk pour appliquer config port..."
    sudo -u splunk $SPLUNK_HOME/bin/splunk restart
    sleep 30
fi

if netstat -tuln | grep ":9997" > /dev/null; then
    echo "âœ“ Port 9997 Ã‰COUTE"
else
    echo "âœ— Port 9997 PAS OUVERT - VÃ©rifier manuellement"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 3 : CRÃ‰ATION DASHBOARD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[3/5] CrÃ©ation dashboard avec 4 index..."

mkdir -p $SPLUNK_HOME/etc/apps/search/local/data/ui/views

cat > $SPLUNK_HOME/etc/apps/search/local/data/ui/views/dashboard_iron4software.xml <<'XMLEOF'
<form version="1.1">
  <label>ğŸ” Dashboard SÃ©curitÃ© Iron4Software - 4 Index</label>
  <description>âš ï¸ Dashboard incomplet - Exercice de dÃ©tection des manques critiques</description>
  
  <fieldset submitButton="false">
    <input type="time" token="time">
      <label>PÃ©riode</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <row>
    <panel>
      <html>
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px;">
          <h2>ğŸ” Exercice : Identification des Manques Critiques</h2>
          <p><strong>Mission : Identifier les informations CRITIQUES manquantes dans ce dashboard</strong></p>
          <ol>
            <li>Examiner chaque panel du dashboard</li>
            <li>Identifier ce qui manque (Ã©vÃ©nements, filtres, alertes, corrÃ©lations)</li>
            <li>Expliquer pourquoi c'est critique pour la sÃ©curitÃ©</li>
            <li>Proposer des ajouts pour complÃ©ter le dashboard</li>
          </ol>
          <p><strong>Indices :</strong> Pensez aux 5W : Who, What, When, Where, Why</p>
        </div>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ“Š Windows Server - Ã‰vÃ©nements SÃ©curitÃ©</title>
      <single>
        <search>
          <query>index=windows_server source="WinEventLog:Security" earliest=$time.earliest$ latest=$time.latest$ | stats count</query>
        </search>
        <option name="underLabel">Total Ã©vÃ©nements</option>
      </single>
    </panel>
    
    <panel>
      <title>ğŸ’» Windows Client - Ã‰vÃ©nements SÃ©curitÃ©</title>
      <single>
        <search>
          <query>index=windows_client source="WinEventLog:Security" earliest=$time.earliest$ latest=$time.latest$ | stats count</query>
        </search>
        <option name="underLabel">Total Ã©vÃ©nements</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ§ Linux Server - Ã‰vÃ©nements</title>
      <single>
        <search>
          <query>index=linux_server earliest=$time.earliest$ latest=$time.latest$ | stats count</query>
        </search>
        <option name="underLabel">Total Ã©vÃ©nements</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ”¥ pfSense - Ã‰vÃ©nements Firewall</title>
      <single>
        <search>
          <query>index=pfsense earliest=$time.earliest$ latest=$time.latest$ | stats count</query>
        </search>
        <option name="underLabel">Total Ã©vÃ©nements</option>
      </single>
    </panel>
  </row>

  <row>
    <panel>
      <title>âœ… Connexions Windows RÃ©ussies (EventCode 4624)</title>
      <table>
        <search>
          <query>index=windows_* EventCode=4624 earliest=$time.earliest$ latest=$time.latest$ | rex field=_raw "Account Name:\s+(?&lt;user&gt;\S+)" | stats count by index, user, host | sort -count | head 10</query>
        </search>
      </table>
    </panel>
    
    <panel>
      <title>ğŸ’» Tous les Hosts Actifs (Forwarders)</title>
      <table>
        <search>
          <query>index=* earliest=$time.earliest$ latest=$time.latest$ | stats count by host, index | sort -count</query>
        </search>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ“ˆ Timeline - Authentifications Windows</title>
      <chart>
        <search>
          <query>index=windows_* EventCode=4624 earliest=$time.earliest$ latest=$time.latest$ | timechart span=1h count by index</query>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.axisTitleY.text">Nombre de connexions</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ” SSH Linux - Connexions RÃ©ussies</title>
      <table>
        <search>
          <query>index=linux_server "Accepted password" earliest=$time.earliest$ latest=$time.latest$ | rex field=_raw "for (?&lt;user&gt;\S+) from (?&lt;src_ip&gt;[\d\.]+)" | stats count by user, src_ip, host | sort -count | head 10</query>
        </search>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸŒ pfSense - Top 10 Ports Destination</title>
      <chart>
        <search>
          <query>index=pfsense earliest=$time.earliest$ latest=$time.latest$ | rex field=_raw ",(?&lt;dst_port&gt;\d+),[^,]*$" | stats count by dst_port | sort -count | head 10</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.axisTitleX.text">Nombre de connexions</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <html>
        <div style="background-color: #f8d7da; padding: 15px; border-radius: 5px;">
          <h3>âš ï¸ INFORMATIONS CRITIQUES MANQUANTES</h3>
          <p><strong>Ce dashboard prÃ©sente les activitÃ©s, mais il manque :</strong></p>
          <ul>
            <li>âŒ <strong>Ã‰checs d'authentification</strong> (EventCode 4625) - DÃ©tection tentatives brute-force</li>
            <li>âŒ <strong>Escalade de privilÃ¨ges</strong> (EventCode 4672, 4728, 4732) - DÃ©tection compromission</li>
            <li>âŒ <strong>Changements de comptes</strong> (crÃ©ation, suppression, modification) - DÃ©tection activitÃ©s suspectes</li>
            <li>âŒ <strong>Trafic firewall BLOQUÃ‰</strong> (action=block) - DÃ©tection scans et attaques</li>
            <li>âŒ <strong>Port scanning</strong> - DÃ©tection reconnaissance rÃ©seau</li>
            <li>âŒ <strong>Connexions depuis IPs inhabituelles</strong> - DÃ©tection compromission</li>
            <li>âŒ <strong>ActivitÃ© hors heures de bureau</strong> - DÃ©tection activitÃ©s anormales</li>
            <li>âŒ <strong>Ã‰vÃ©nements critiques Linux</strong> (erreurs, panics, failed) - DÃ©tection problÃ¨mes</li>
            <li>âŒ <strong>Modifications fichiers sensibles</strong> (/etc/passwd, /etc/shadow) - DÃ©tection compromission</li>
            <li>âŒ <strong>Commandes sudo</strong> - Surveillance privilÃ¨ges</li>
            <li>âŒ <strong>Alertes et seuils</strong> - Notifications automatiques</li>
            <li>âŒ <strong>CorrÃ©lations</strong> - DÃ©tection attaques multi-Ã©tapes</li>
          </ul>
          <br/>
          <p><strong>Votre mission :</strong> Identifier TOUS ces manques et proposer des solutions !</p>
        </div>
      </html>
    </panel>
  </row>
</form>
XMLEOF

chown -R splunk:splunk $SPLUNK_HOME/etc/apps/search/local

echo "âœ“ Dashboard crÃ©Ã©"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 4 : VÃ‰RIFICATION FORWARDERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[4/5] VÃ©rification des forwarders..."
echo ""

# Connexions actives
CONN=$(netstat -an | grep ":9997" | grep ESTABLISHED | wc -l)
echo "Forwarders connectÃ©s au port 9997: $CONN"
echo ""

if [ $CONN -gt 0 ]; then
    echo "Liste des connexions:"
    netstat -an | grep ":9997" | grep ESTABLISHED
    echo ""
fi

# VÃ©rifier donnÃ©es dans chaque index
echo "DonnÃ©es reÃ§ues dans les 24 derniÃ¨res heures:"
echo ""

for idx in windows_server windows_client linux_server pfsense; do
    COUNT=$(sudo -u splunk $SPLUNK_HOME/bin/splunk search "index=$idx earliest=-24h | stats count" -auth admin:$ADMIN_PASS 2>/dev/null | grep -oP '\d+' | tail -1)
    if [ -n "$COUNT" ] && [ "$COUNT" -gt 0 ]; then
        echo "  âœ“ $idx: $COUNT Ã©vÃ©nements"
    else
        echo "  âœ— $idx: AUCUN Ã©vÃ©nement"
    fi
done
echo ""

# Hosts uniques
echo "Hosts (forwarders) dÃ©tectÃ©s:"
sudo -u splunk $SPLUNK_HOME/bin/splunk search "index=* earliest=-24h | stats count by host" -auth admin:$ADMIN_PASS 2>/dev/null | grep -v "^$"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARTIE 5 : GUIDE CONFIGURATION FORWARDERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[5/5] Guide configuration forwarders..."
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ACCÃˆS SPLUNK"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Interface Web: http://$IP:8000"
echo "Dashboard: http://$IP:8000/app/search/dashboard_iron4software"
echo ""
echo "Login: admin"
echo "Pass: $ADMIN_PASS"
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  CONFIGURATION FORWARDERS"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Indexer (Splunk Server): $IP:9997"
echo ""

echo "â”€â”€â”€ WINDOWS SERVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Fichier: C:\\Program Files\\SplunkUniversalForwarder\\etc\\system\\local\\outputs.conf"
echo ""
cat <<'EOF'
[tcpout]
defaultGroup = indexer

[tcpout:indexer]
server = SPLUNK_IP:9997

[indexAndForward]
index = false
EOF
echo ""
echo "Fichier: C:\\Program Files\\SplunkUniversalForwarder\\etc\\system\\local\\inputs.conf"
echo ""
cat <<'EOF'
[default]
index = windows_server

[WinEventLog://Security]
disabled = false

[WinEventLog://System]
disabled = false

[WinEventLog://Application]
disabled = false
EOF
echo ""
echo "Puis: Restart-Service SplunkForwarder"
echo ""

echo "â”€â”€â”€ WINDOWS CLIENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "MÃªme chose mais avec: index = windows_client"
echo ""

echo "â”€â”€â”€ LINUX SERVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Fichier: /opt/splunkforwarder/etc/system/local/outputs.conf"
echo ""
cat <<EOF
[tcpout]
defaultGroup = indexer

[tcpout:indexer]
server = $IP:9997
EOF
echo ""
echo "Fichier: /opt/splunkforwarder/etc/system/local/inputs.conf"
echo ""
cat <<'EOF'
[default]
index = linux_server
host = linux-server

[monitor:///var/log/auth.log]
disabled = false
sourcetype = linux_secure

[monitor:///var/log/syslog]
disabled = false
sourcetype = syslog
EOF
echo ""
echo "Puis: sudo /opt/splunkforwarder/bin/splunk restart"
echo ""

echo "â”€â”€â”€ PFSENSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Dans pfSense Web GUI:"
echo "  Status > System Logs > Settings"
echo ""
echo "  âœ“ Enable Remote Logging"
echo "  Remote log servers: $IP:514"
echo "  Remote Syslog Contents: Everything"
echo ""
echo "Sur le serveur Splunk, ajouter dans inputs.conf:"
echo ""
cat <<EOF
[udp://514]
disabled = false
sourcetype = pf:filterlog
index = pfsense
EOF
echo ""
echo "Puis: sudo -u splunk $SPLUNK_HOME/bin/splunk restart"
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  TESTS DE VÃ‰RIFICATION"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "1. Test connexion depuis forwarder:"
echo "   Windows: Test-NetConnection -ComputerName $IP -Port 9997"
echo "   Linux: telnet $IP 9997"
echo ""
echo "2. VÃ©rifier logs forwarder:"
echo "   Windows: C:\\Program Files\\SplunkUniversalForwarder\\var\\log\\splunk\\splunkd.log"
echo "   Linux: /opt/splunkforwarder/var/log/splunk/splunkd.log"
echo "   Chercher: 'Connected to idx=$IP:9997'"
echo ""
echo "3. Dans Splunk Web, chercher:"
echo "   index=windows_server | stats count by host"
echo "   index=windows_client | stats count by host"
echo "   index=linux_server | stats count by host"
echo "   index=pfsense | stats count by host"
echo ""
echo "4. Relancer ce script pour vÃ©rifier:"
echo "   sudo bash $0"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
