#!/bin/bash

##############################################
# SCRIPT DE RÃ‰PARATION COMPLÃˆTE SPLUNK
# RÃ©pare + Dashboard + Forwarders
##############################################

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  RÃ‰PARATION COMPLÃˆTE SPLUNK"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

SPLUNK_HOME="/opt/splunk"
ADMIN_PASS="Admin123G4"

# 1. RÃ‰PARATION SPLUNK
echo "[1/5] RÃ©paration Splunk..."

# Stop proprement
sudo -u splunk $SPLUNK_HOME/bin/splunk stop 2>/dev/null || true
sleep 3
killall -9 splunkd mongod python3 2>/dev/null || true
sleep 2

# Nettoyer
rm -rf $SPLUNK_HOME/var/lib/splunk/kvstore/*
rm -rf $SPLUNK_HOME/var/run/splunk/*
rm -rf $SPLUNK_HOME/var/lib/splunk/fishbucket/*

# Reset password
cat > $SPLUNK_HOME/etc/system/local/user-seed.conf <<EOF
[user_info]
USERNAME = admin
PASSWORD = $ADMIN_PASS
EOF

# Config forwarders (port 9997)
cat > $SPLUNK_HOME/etc/system/local/inputs.conf <<EOF
[splunktcp://9997]
disabled = false
connection_host = ip

[default]
host = $(hostname)
EOF

# Config web
cat > $SPLUNK_HOME/etc/system/local/web.conf <<EOF
[settings]
httpport = 8000
enableSplunkWebSSL = false
startwebserver = 1
EOF

# Permissions
chown -R splunk:splunk $SPLUNK_HOME

echo "âœ“ RÃ©paration OK"
echo ""

# 2. DÃ‰MARRAGE
echo "[2/5] DÃ©marrage Splunk..."
sudo -u splunk $SPLUNK_HOME/bin/splunk start --accept-license --answer-yes --no-prompt

echo "Attente 40 secondes..."
sleep 40

echo "âœ“ Splunk dÃ©marrÃ©"
echo ""

# 3. VÃ‰RIFICATION
echo "[3/5] VÃ©rification..."
netstat -tuln | grep -E ":8000|:8089|:9997" || echo "âš  Ports pas encore ouverts"
echo ""

# 4. INSTALLATION DASHBOARD
echo "[4/5] Installation dashboard..."

DASHBOARD_XML='<form version="1.1">
  <label>ğŸ” Dashboard de SÃ©curitÃ© - Exercice : Qu'\''est-ce qui manque ?</label>
  <description>âš ï¸ Ce dashboard semble fonctionnel mais manque d'\''informations CRITIQUES</description>
  
  <fieldset submitButton="false">
    <input type="time" token="time_token">
      <label>PÃ©riode</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <row>
    <panel>
      <title>ğŸ“Š Ã‰vÃ©nements de sÃ©curitÃ©</title>
      <single>
        <search>
          <query>index=windows source="WinEventLog:Security" | stats count</query>
        </search>
      </single>
    </panel>
    
    <panel>
      <title>âœ… Connexions rÃ©ussies</title>
      <single>
        <search>
          <query>index=windows source="WinEventLog:Security" EventCode=4624 | stats count</query>
        </search>
      </single>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ‘¥ Top utilisateurs</title>
      <table>
        <search>
          <query>index=windows EventCode=4624 | rex field=_raw "Account Name:\s+(?&lt;user&gt;\S+)" | stats count by user | sort -count | head 5</query>
        </search>
      </table>
    </panel>
    
    <panel>
      <title>ğŸ’» Serveurs actifs</title>
      <table>
        <search>
          <query>index=* | stats count by host | sort -count</query>
        </search>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <html>
        <div style="background-color: #fff3cd; padding: 15px;">
          <h3>âš ï¸ DASHBOARD INCOMPLET</h3>
          <p><b>Mission :</b> Identifiez ce qui manque !</p>
          <ul>
            <li>âŒ Ã‰checs d'\''authentification (EventCode 4625)</li>
            <li>âŒ Escalade de privilÃ¨ges</li>
            <li>âŒ Trafic firewall bloquÃ©</li>
            <li>âŒ Port scanning</li>
            <li>âŒ Connexions anormales</li>
            <li>âŒ Alertes de sÃ©curitÃ©</li>
          </ul>
        </div>
      </html>
    </panel>
  </row>
</form>'

curl -k -u "admin:$ADMIN_PASS" \
  -X POST \
  "https://127.0.0.1:8089/servicesNS/admin/search/data/ui/views" \
  --data-urlencode "name=incomplete_security_dashboard" \
  --data-urlencode "eai:data=$DASHBOARD_XML" \
  2>/dev/null

curl -k -u "admin:$ADMIN_PASS" \
  -X POST \
  "https://127.0.0.1:8089/servicesNS/admin/search/data/ui/views/incomplete_security_dashboard/acl" \
  -d "sharing=app" \
  -d "perms.read=*" \
  2>/dev/null

echo "âœ“ Dashboard installÃ©"
echo ""

# 5. RÃ‰SUMÃ‰
echo "[5/5] Configuration forwarders..."

IP=$(hostname -I | awk '{print $1}')

echo "âœ“ Port 9997 configurÃ© pour recevoir les forwarders"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ“âœ“âœ“ RÃ‰PARATION TERMINÃ‰E"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Interface Web: http://$IP:8000"
echo "Username: admin"
echo "Password: $ADMIN_PASS"
echo ""
echo "Dashboard: http://$IP:8000/app/search/incomplete_security_dashboard"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "CONFIGURATION FORWARDERS"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Sur CHAQUE Windows/Linux forwarder, Ã©dite outputs.conf:"
echo ""
echo "[tcpout]"
echo "defaultGroup = indexer"
echo ""
echo "[tcpout:indexer]"
echo "server = $IP:9997"
echo ""
echo "Puis redÃ©marre le forwarder:"
echo "Windows: Restart-Service SplunkForwarder"
echo "Linux: sudo /opt/splunkforwarder/bin/splunk restart"
echo ""
echo "VÃ©rifier connexions:"
echo "sudo netstat -an | grep 9997"
echo ""
