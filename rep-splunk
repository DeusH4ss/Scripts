#!/bin/bash
# Solution FINALE basée sur recherches Splunk Community + Doc officielle
# Méthode TAR (plus fiable que DEB) + Désactivation firewall

echo "╔════════════════════════════════════════════╗"
echo "║  SOLUTION FINALE - Méthode TAR + Reboot    ║"
echo "╚════════════════════════════════════════════╝"
echo ""

# 1. KILL BRUTAL
echo "[1/5] Kill processus..."
killall -9 splunkd mongod python3 python 2>/dev/null || true
pkill -9 -f splunk 2>/dev/null || true
sleep 3

# 2. SUPPRESSION TOTALE
echo "[2/5] Suppression complète..."
rm -rf /opt/splunk
rm -rf /opt/splunkforwarder
rm -rf /var/log/splunk

# 3. DÉSACTIVER FIREWALL (cause principale)
echo "[3/5] Désactivation firewall..."
systemctl stop firewalld 2>/dev/null || true
systemctl stop iptables 2>/dev/null || true
systemctl stop ufw 2>/dev/null || true
ufw disable 2>/dev/null || true

# 4. INSTALLATION TAR (RECOMMANDÉE)
echo "[4/5] Installation via TAR..."
cd /tmp

TAR="splunk-9.3.2-d8bb32809498-Linux-x86_64.tgz"
URL="https://download.splunk.com/products/splunk/releases/9.3.2/linux/$TAR"

if [ ! -f "$TAR" ]; then
    echo "Téléchargement..."
    wget -q --show-progress "$URL" || exit 1
fi

echo "Extraction dans /opt..."
tar xzf "$TAR" -C /opt

# 5. CONFIG
echo "[5/5] Configuration..."

# Créer user splunk si nécessaire
id splunk 2>/dev/null || useradd -r -m -s /bin/bash splunk

# Password
cat > /opt/splunk/etc/system/local/user-seed.conf <<'EOF'
[user_info]
USERNAME = admin  
PASSWORD = Admin123!
EOF

# Ports
cat > /opt/splunk/etc/system/local/inputs.conf <<'EOF'
[splunktcp://9997]
disabled = false
EOF

cat > /opt/splunk/etc/system/local/web.conf <<'EOF'
[settings]
httpport = 8000
enableSplunkWebSSL = false
startwebserver = 1
EOF

# Permissions
chown -R splunk:splunk /opt/splunk

# START
echo ""
echo "Démarrage..."
sudo -u splunk /opt/splunk/bin/splunk start --accept-license --answer-yes --no-prompt

echo ""
echo "Attente 30 sec..."
sleep 30

# Vérification
echo ""
echo "═══ VÉRIFICATION ═══"
netstat -tuln | grep -E ":8000|:8089|:9997"

SUCCESS=$(netstat -tuln | grep -E ":8000|:8089|:9997" | wc -l)

if [ "$SUCCESS" -eq 3 ]; then
    echo ""
    echo "✓✓✓ SUCCÈS - Tous les ports ouverts"
else
    echo ""
    echo "⚠ Seuls $SUCCESS/3 ports ouverts"
    echo ""
    echo "SOLUTION D'APRÈS LES FORUMS SPLUNK:"
    echo "→ REBOOT du serveur résout 90% des problèmes"
    echo ""
    read -p "Faire un REBOOT maintenant? (o/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[OoYy]$ ]]; then
        echo "Splunk configuré pour démarrer automatiquement..."
        /opt/splunk/bin/splunk enable boot-start -user splunk --accept-license --answer-yes
        echo ""
        echo "REBOOT dans 5 secondes..."
        sleep 5
        reboot
    fi
fi

echo ""
IP=$(hostname -I | awk '{print $1}')
echo "═══════════════════════════"
echo "URL: http://$IP:8000"
echo "User: admin"
echo "Pass: Admin123!"
echo "═══════════════════════════"
echo ""
echo "NOTE: Si ports pas ouverts, fais un REBOOT:"
echo "  sudo reboot"
