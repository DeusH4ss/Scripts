#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰PARATION AGRESSIVE - Vire les apps bugguÃ©es et force les ports
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SPLUNK_HOME="/opt/splunk"
SPLUNK_USER="splunk"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

clear
echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${RED}â•‘  RÃ‰PARATION AGRESSIVE - Vire les apps bugguÃ©es       â•‘${NC}"
echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

if [ "$EUID" -ne 0 ]; then 
   echo -e "${RED}Lance avec: sudo bash $0${NC}"
   exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. ARRÃŠT BRUTAL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[1/7] ArrÃªt brutal...${NC}"
pkill -9 splunkd
pkill -9 mongod
pkill -9 python
sleep 3
echo -e "${GREEN}âœ“ ArrÃªtÃ©\n${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. DÃ‰SACTIVATION DES APPS PROBLÃ‰MATIQUES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[2/7] DÃ©sactivation des apps bugguÃ©es...${NC}"

cd $SPLUNK_HOME/etc/apps

# Apps dÃ©tectÃ©es comme problÃ©matiques dans les logs
PROBLEMATIC_APPS=(
    "splunk_monitoring_console"
    "splunk_assist"
    "splunk_secure_gateway"
    "search"
    "introspection_generator_addon"
    "alert_logevent"
    "alert_webhook"
)

for app in "${PROBLEMATIC_APPS[@]}"; do
    if [ -d "$app" ]; then
        mv "$app" "${app}.DISABLED" 2>/dev/null
        echo -e "${GREEN}âœ“ DÃ©sactivÃ©: $app${NC}"
    fi
done

echo -e "${GREEN}âœ“ Apps problÃ©matiques dÃ©sactivÃ©es\n${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. NETTOYAGE PROFOND
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[3/7] Nettoyage profond...${NC}"

# Supprimer caches et temporaires
rm -rf $SPLUNK_HOME/var/run/splunk/* 2>/dev/null
rm -rf $SPLUNK_HOME/var/lib/splunk/kvstore/* 2>/dev/null
rm -rf $SPLUNK_HOME/var/lib/splunk/fishbucket/* 2>/dev/null
rm -rf $SPLUNK_HOME/var/lib/splunk/persistentstorage/* 2>/dev/null

# Nettoyer scheduler (cause des erreurs)
rm -rf $SPLUNK_HOME/var/run/splunk/scheduler/* 2>/dev/null
rm -rf $SPLUNK_HOME/var/lib/splunk/dispatch/* 2>/dev/null

echo -e "${GREEN}âœ“ Nettoyage terminÃ©\n${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. RESET MOT DE PASSE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[4/7] Reset mot de passe...${NC}"

rm -f $SPLUNK_HOME/etc/passwd 2>/dev/null

cat > $SPLUNK_HOME/etc/system/local/user-seed.conf <<'EOF'
[user_info]
USERNAME = admin
PASSWORD = Admin123!
EOF

echo -e "${GREEN}âœ“ Password: Admin123!\n${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. CONFIGURATION PORTS (FORCE)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[5/7] Configuration FORCÃ‰E des ports...${NC}"

# inputs.conf - TRÃˆS SIMPLE
cat > $SPLUNK_HOME/etc/system/local/inputs.conf <<EOF
[splunktcp://9997]
disabled = false
EOF

# web.conf - TRÃˆS SIMPLE
cat > $SPLUNK_HOME/etc/system/local/web.conf <<'EOF'
[settings]
httpport = 8000
enableSplunkWebSSL = false
startwebserver = 1
EOF

# server.conf - MINIMAL
cat > $SPLUNK_HOME/etc/system/local/server.conf <<'EOF'
[httpServer]
port = 8089
EOF

echo -e "${GREEN}âœ“ Ports configurÃ©s (8000, 8089, 9997)\n${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. PERMISSIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[6/7] Permissions...${NC}"
chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME
echo -e "${GREEN}âœ“ OK\n${NC}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 7. DÃ‰MARRAGE EN SAFE-MODE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[7/7] DÃ©marrage en SAFE-MODE (sans apps)...${NC}\n"

# DÃ©marrer en safe-mode pour Ã©viter les apps bugguÃ©es
sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk start --safe-mode --accept-license --answer-yes --no-prompt

echo -e "\n${YELLOW}Attente 40 secondes (safe-mode prend plus de temps)...${NC}"
sleep 40

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VÃ‰RIFICATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "\n${CYAN}VÃ‰RIFICATIONS:${NC}\n"

# Processus
if pgrep -f "splunkd" > /dev/null; then
    echo -e "${GREEN}âœ“ Splunkd actif${NC}"
else
    echo -e "${RED}âœ— Splunkd non actif${NC}"
fi

# Ports
PORT_8000=$(netstat -tuln 2>/dev/null | grep ":8000" || echo "")
PORT_8089=$(netstat -tuln 2>/dev/null | grep ":8089" || echo "")
PORT_9997=$(netstat -tuln 2>/dev/null | grep ":9997" || echo "")

SUCCESS=0

if [ -n "$PORT_8000" ]; then
    echo -e "${GREEN}âœ“ Port 8000 OUVERT${NC}"
    SUCCESS=$((SUCCESS+1))
else
    echo -e "${RED}âœ— Port 8000 FERMÃ‰${NC}"
fi

if [ -n "$PORT_8089" ]; then
    echo -e "${GREEN}âœ“ Port 8089 OUVERT${NC}"
    SUCCESS=$((SUCCESS+1))
else
    echo -e "${RED}âœ— Port 8089 FERMÃ‰${NC}"
fi

if [ -n "$PORT_9997" ]; then
    echo -e "${GREEN}âœ“ Port 9997 OUVERT${NC}"
    SUCCESS=$((SUCCESS+1))
else
    echo -e "${RED}âœ— Port 9997 FERMÃ‰${NC}"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰SULTAT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo ""
if [ $SUCCESS -eq 3 ]; then
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘  âœ“âœ“âœ“ SUCCÃˆS - Tous les ports sont ouverts         â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    echo -e "\n${YELLOW}Note: Splunk tourne en SAFE-MODE (sans apps)${NC}"
    echo -e "${YELLOW}Les apps bugguÃ©es ont Ã©tÃ© dÃ©sactivÃ©es${NC}"
    
elif [ $SUCCESS -gt 0 ]; then
    echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${YELLOW}â•‘  âš  Partiel - $SUCCESS/3 ports ouverts                      â•‘${NC}"
    echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
else
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘  âœ— Ã‰CHEC - Voir logs                               â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    echo -e "\n${RED}DerniÃ¨res erreurs:${NC}"
    tail -30 $SPLUNK_HOME/var/log/splunk/splunkd.log | grep -i "ERROR\|FATAL" | tail -10
fi

# Infos
SERVER_IP=$(hostname -I | awk '{print $1}')
echo -e "\n${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}ğŸŒ URL: http://$SERVER_IP:8000${NC}"
echo -e "${GREEN}ğŸ‘¤ Username: admin${NC}"
echo -e "${GREEN}ğŸ”‘ Password: Admin123!${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

if [ $SUCCESS -eq 3 ]; then
    echo -e "${YELLOW}Prochaines Ã©tapes:${NC}"
    echo -e "  1. Connecte-toi Ã  l'interface Web"
    echo -e "  2. Splunk fonctionne en SAFE-MODE (minimal)"
    echo -e "  3. Pour sortir du safe-mode:"
    echo -e "     ${BLUE}sudo -u splunk /opt/splunk/bin/splunk restart${NC}"
    echo -e "  4. Les apps problÃ©matiques resteront dÃ©sactivÃ©es\n"
else
    echo -e "${YELLOW}Pour dÃ©boguer:${NC}"
    echo -e "  â€¢ Logs: ${BLUE}tail -100 /opt/splunk/var/log/splunk/splunkd.log${NC}"
    echo -e "  â€¢ Relancer: ${BLUE}sudo bash $0${NC}\n"
fi

echo -e "${YELLOW}Apps dÃ©sactivÃ©es (cause erreurs):${NC}"
echo -e "  â€¢ splunk_monitoring_console"
echo -e "  â€¢ splunk_assist"
echo -e "  â€¢ search (app interne qui bugue)"
echo -e "  â€¢ splunk_secure_gateway"
echo -e "  â€¢ introspection_generator_addon"
echo -e "  â€¢ alert_logevent"
echo -e "  â€¢ alert_webhook\n"
