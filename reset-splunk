#!/bin/bash

# ═══════════════════════════════════════════════════════════════════
# SCRIPT ULTIME SPLUNK - FAIT TOUT AUTOMATIQUEMENT
# Sauvegarde → Désinstallation → Téléchargement → Installation → Config
# Une seule commande, zéro question, tout automatique
# ═══════════════════════════════════════════════════════════════════

SPLUNK_HOME="/opt/splunk"
SPLUNK_USER="splunk"
BACKUP_DIR="/root/splunk_backup_$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/tmp/splunk_ultimate_$(date +%Y%m%d_%H%M%S).log"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

log() {
    echo -e "$1" | tee -a "$LOG_FILE"
}

clear
log "${MAGENTA}╔══════════════════════════════════════════════════════════╗${NC}"
log "${MAGENTA}║  SCRIPT ULTIME SPLUNK - 100% AUTOMATIQUE                ║${NC}"
log "${MAGENTA}║  Lab Iron4Software - Philippe                           ║${NC}"
log "${MAGENTA}╚══════════════════════════════════════════════════════════╝${NC}\n"

if [ "$EUID" -ne 0 ]; then 
   log "${RED}[ERREUR] Lance avec: sudo bash $0${NC}"
   exit 1
fi

log "${YELLOW}Backup: $BACKUP_DIR${NC}"
log "${YELLOW}Logs: $LOG_FILE${NC}\n"

# ═══════════════════════════════════════════════════════════════════
# PHASE 1 : SAUVEGARDE (si Splunk existe)
# ═══════════════════════════════════════════════════════════════════

log "${CYAN}[1/6] SAUVEGARDE...${NC}\n"

if [ -d "$SPLUNK_HOME" ]; then
    mkdir -p "$BACKUP_DIR"
    
    # Arrêt
    pkill -9 splunkd 2>/dev/null
    pkill -9 mongod 2>/dev/null
    
    # Backup configs
    if [ -d "$SPLUNK_HOME/etc/system/local" ]; then
        cp -rp $SPLUNK_HOME/etc/system/local "$BACKUP_DIR/" 2>/dev/null
        log "${GREEN}✓ Configs système${NC}"
    fi
    
    # Backup apps (pas splunk_assist)
    if [ -d "$SPLUNK_HOME/etc/apps" ]; then
        mkdir -p "$BACKUP_DIR/apps"
        for app in $SPLUNK_HOME/etc/apps/*; do
            app_name=$(basename "$app")
            if [[ ! "$app_name" =~ ^(splunk_|launcher|learned|legacy|sample|search|gettingstarted|introspection|alert_) ]]; then
                cp -rp "$app" "$BACKUP_DIR/apps/" 2>/dev/null
                log "${GREEN}✓ App: $app_name${NC}"
            fi
        done
    fi
    
    # Backup users
    [ -f "$SPLUNK_HOME/etc/passwd" ] && cp -p $SPLUNK_HOME/etc/passwd "$BACKUP_DIR/" 2>/dev/null
    [ -f "$SPLUNK_HOME/etc/auth/splunk.secret" ] && mkdir -p "$BACKUP_DIR/auth" && cp -p $SPLUNK_HOME/etc/auth/splunk.secret "$BACKUP_DIR/auth/" 2>/dev/null
    
    log "${GREEN}✓ Backup terminé\n${NC}"
else
    log "${YELLOW}⚠ Pas de Splunk existant - Installation propre\n${NC}"
fi

# ═══════════════════════════════════════════════════════════════════
# PHASE 2 : DÉSINSTALLATION COMPLÈTE
# ═══════════════════════════════════════════════════════════════════

log "${CYAN}[2/6] DÉSINSTALLATION...${NC}\n"

pkill -9 splunkd 2>/dev/null
pkill -9 mongod 2>/dev/null

# Désinstaller paquet
dpkg --purge splunk 2>/dev/null || rpm -e splunk 2>/dev/null || true

# Supprimer répertoire
rm -rf $SPLUNK_HOME

log "${GREEN}✓ Désinstallation complète\n${NC}"

# ═══════════════════════════════════════════════════════════════════
# PHASE 3 : TÉLÉCHARGEMENT AUTOMATIQUE
# ═══════════════════════════════════════════════════════════════════

log "${CYAN}[3/6] TÉLÉCHARGEMENT SPLUNK...${NC}\n"

# Détecter OS
if [ -f /etc/debian_version ]; then
    SPLUNK_VERSION="9.3.2"
    SPLUNK_BUILD="d8bb32809498"
    SPLUNK_PKG="splunk-${SPLUNK_VERSION}-${SPLUNK_BUILD}-linux-2.6-amd64.deb"
    SPLUNK_URL="https://download.splunk.com/products/splunk/releases/${SPLUNK_VERSION}/linux/${SPLUNK_PKG}"
    PKG_TYPE="deb"
    log "${GREEN}✓ OS: Debian/Ubuntu${NC}"
elif [ -f /etc/redhat-release ]; then
    SPLUNK_VERSION="9.3.2"
    SPLUNK_BUILD="d8bb32809498"
    SPLUNK_PKG="splunk-${SPLUNK_VERSION}-${SPLUNK_BUILD}.x86_64.rpm"
    SPLUNK_URL="https://download.splunk.com/products/splunk/releases/${SPLUNK_VERSION}/linux/${SPLUNK_PKG}"
    PKG_TYPE="rpm"
    log "${GREEN}✓ OS: RedHat/CentOS${NC}"
else
    log "${RED}✗ OS non supporté${NC}"
    exit 1
fi

SPLUNK_PKG_PATH="/tmp/$SPLUNK_PKG"

# Télécharger
if [ ! -f "$SPLUNK_PKG_PATH" ]; then
    log "${YELLOW}Téléchargement: $SPLUNK_VERSION...${NC}"
    
    if command -v wget &> /dev/null; then
        wget -q --show-progress -O "$SPLUNK_PKG_PATH" "$SPLUNK_URL" 2>&1 | tee -a "$LOG_FILE"
    elif command -v curl &> /dev/null; then
        curl -# -o "$SPLUNK_PKG_PATH" "$SPLUNK_URL" 2>&1 | tee -a "$LOG_FILE"
    else
        log "${RED}✗ wget/curl manquant${NC}"
        exit 1
    fi
fi

if [ -f "$SPLUNK_PKG_PATH" ]; then
    PKG_SIZE=$(du -h "$SPLUNK_PKG_PATH" | cut -f1)
    log "${GREEN}✓ Téléchargé: ${PKG_SIZE}\n${NC}"
else
    log "${RED}✗ Échec téléchargement${NC}"
    exit 1
fi

# ═══════════════════════════════════════════════════════════════════
# PHASE 4 : INSTALLATION AUTOMATIQUE
# ═══════════════════════════════════════════════════════════════════

log "${CYAN}[4/6] INSTALLATION SPLUNK...${NC}\n"

if [ "$PKG_TYPE" = "deb" ]; then
    dpkg -i "$SPLUNK_PKG_PATH" 2>&1 | tee -a "$LOG_FILE"
    apt-get install -f -y 2>&1 | tee -a "$LOG_FILE"
else
    rpm -ivh "$SPLUNK_PKG_PATH" 2>&1 | tee -a "$LOG_FILE"
fi

if [ -d "$SPLUNK_HOME" ]; then
    log "${GREEN}✓ Splunk ${SPLUNK_VERSION} installé\n${NC}"
else
    log "${RED}✗ Installation échouée${NC}"
    exit 1
fi

# ═══════════════════════════════════════════════════════════════════
# PHASE 5 : CONFIGURATION AUTOMATIQUE
# ═══════════════════════════════════════════════════════════════════

log "${CYAN}[5/6] CONFIGURATION...${NC}\n"

mkdir -p $SPLUNK_HOME/etc/system/local

# MOT DE PASSE ADMIN
cat > $SPLUNK_HOME/etc/system/local/user-seed.conf <<'EOF'
[user_info]
USERNAME = admin
PASSWORD = Admin123!
EOF

log "${GREEN}✓ Password: Admin123!${NC}"

# PORT 9997 (Forwarders)
cat > $SPLUNK_HOME/etc/system/local/inputs.conf <<EOF
[default]
host = $(hostname)

[splunktcp://9997]
disabled = false
connection_host = ip
EOF

log "${GREEN}✓ Port 9997 (Forwarders)${NC}"

# PORT 8000 (Web)
cat > $SPLUNK_HOME/etc/system/local/web.conf <<'EOF'
[settings]
httpport = 8000
enableSplunkWebSSL = false
startwebserver = 1
appServerPorts = 8065
EOF

log "${GREEN}✓ Port 8000 (Web)${NC}"

# PORT 8089 (Management)
cat > $SPLUNK_HOME/etc/system/local/server.conf <<EOF
[general]
serverName = $(hostname)

[httpServer]
port = 8089

[sslConfig]
enableSplunkdSSL = true
EOF

log "${GREEN}✓ Port 8089 (Management)${NC}"

# Restaurer backup si existe
if [ -d "$BACKUP_DIR/apps" ]; then
    log "${YELLOW}Restauration apps...${NC}"
    cp -rp $BACKUP_DIR/apps/* $SPLUNK_HOME/etc/apps/ 2>/dev/null || true
    log "${GREEN}✓ Apps restaurées${NC}"
fi

if [ -d "$BACKUP_DIR/local" ]; then
    log "${YELLOW}Restauration configs avancées...${NC}"
    cp -rp $BACKUP_DIR/local/* $SPLUNK_HOME/etc/system/local/ 2>/dev/null || true
    log "${GREEN}✓ Configs restaurées${NC}"
fi

# Permissions
chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME
log "${GREEN}✓ Permissions OK\n${NC}"

# ═══════════════════════════════════════════════════════════════════
# PHASE 6 : DÉMARRAGE ET VÉRIFICATION
# ═══════════════════════════════════════════════════════════════════

log "${CYAN}[6/6] DÉMARRAGE...${NC}\n"

sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk start --accept-license --answer-yes --no-prompt 2>&1 | tee -a "$LOG_FILE"

log "\n${YELLOW}Attente 30 secondes...${NC}\n"
sleep 30

# ═══════════════════════════════════════════════════════════════════
# VÉRIFICATIONS FINALES
# ═══════════════════════════════════════════════════════════════════

log "${CYAN}VÉRIFICATIONS:${NC}\n"

# Processus
if pgrep -f "splunkd" > /dev/null; then
    log "${GREEN}✓ Splunk actif${NC}"
else
    log "${RED}✗ Splunk non démarré${NC}"
fi

# Ports
PORT_8000=$(netstat -tuln 2>/dev/null | grep ":8000")
PORT_8089=$(netstat -tuln 2>/dev/null | grep ":8089")
PORT_9997=$(netstat -tuln 2>/dev/null | grep ":9997")

SUCCESS=0
[ -n "$PORT_8000" ] && log "${GREEN}✓ Port 8000 OUVERT${NC}" && SUCCESS=$((SUCCESS+1)) || log "${RED}✗ Port 8000 FERMÉ${NC}"
[ -n "$PORT_8089" ] && log "${GREEN}✓ Port 8089 OUVERT${NC}" && SUCCESS=$((SUCCESS+1)) || log "${RED}✗ Port 8089 FERMÉ${NC}"
[ -n "$PORT_9997" ] && log "${GREEN}✓ Port 9997 OUVERT${NC}" && SUCCESS=$((SUCCESS+1)) || log "${RED}✗ Port 9997 FERMÉ${NC}"

# ═══════════════════════════════════════════════════════════════════
# RÉSULTAT FINAL
# ═══════════════════════════════════════════════════════════════════

log ""
if [ $SUCCESS -eq 3 ]; then
    log "${GREEN}╔═════════════════════════════════════════════════════╗${NC}"
    log "${GREEN}║  ✓✓✓ SUCCÈS TOTAL - Splunk 100% opérationnel       ║${NC}"
    log "${GREEN}╚═════════════════════════════════════════════════════╝${NC}"
elif [ $SUCCESS -gt 0 ]; then
    log "${YELLOW}╔═════════════════════════════════════════════════════╗${NC}"
    log "${YELLOW}║  ⚠ Partiel - $SUCCESS/3 ports ouverts                        ║${NC}"
    log "${YELLOW}╚═════════════════════════════════════════════════════╝${NC}"
else
    log "${RED}╔═════════════════════════════════════════════════════╗${NC}"
    log "${RED}║  ✗ ÉCHEC - Voir logs                                 ║${NC}"
    log "${RED}╚═════════════════════════════════════════════════════╝${NC}"
    
    log "\n${RED}Dernières erreurs:${NC}"
    tail -20 $SPLUNK_HOME/var/log/splunk/splunkd.log | grep -i "ERROR\|FATAL" | tail -5
fi

# Infos connexion
SERVER_IP=$(hostname -I | awk '{print $1}')
log "\n${CYAN}═══════════════════════════════════════════════════${NC}"
log "${GREEN}🌐 URL: http://$SERVER_IP:8000${NC}"
log "${GREEN}👤 Username: admin${NC}"
log "${GREEN}🔑 Password: Admin123!${NC}"
log "${CYAN}═══════════════════════════════════════════════════${NC}\n"

if [ $SUCCESS -eq 3 ]; then
    log "${YELLOW}Prochaines étapes:${NC}"
    log "  1. Ouvre http://$SERVER_IP:8000"
    log "  2. Login: admin / Admin123!"
    log "  3. Configure forwarders: server = $SERVER_IP:9997"
    log "  4. Installe licence Free pour usage permanent\n"
else
    log "${YELLOW}Diagnostic:${NC}"
    log "  • Logs: tail -50 /opt/splunk/var/log/splunk/splunkd.log"
    log "  • Relancer: sudo bash $0\n"
fi

log "${YELLOW}Fichiers:${NC}"
log "  • Backup: $BACKUP_DIR"
log "  • Logs: $LOG_FILE\n"
