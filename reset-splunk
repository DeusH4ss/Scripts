#!/bin/bash

# Script de r√©initialisation de licence Splunk - Version CORRIG√âE
# Lab Iron4Software - Auteur: Philippe

SPLUNK_HOME="/opt/splunk"
BACKUP_DIR="/tmp/splunk_license_backup_$(date +%Y%m%d_%H%M%S)"
SPLUNK_USER="splunk"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë  Script de Reset Licence Splunk - Lab Cybers√©cu ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"

# V√©rification sudo
if [ "$EUID" -ne 0 ]; then 
   echo -e "${RED}[ERREUR] Ex√©cute ce script avec sudo:${NC}"
   echo -e "${YELLOW}sudo bash $0${NC}"
   exit 1
fi

# V√©rification Splunk install√©
if [ ! -d "$SPLUNK_HOME" ]; then
    echo -e "${RED}[ERREUR] Splunk n'est pas install√© dans $SPLUNK_HOME${NC}"
    exit 1
fi

# Cr√©ation du r√©pertoire de backup dans /tmp pour √©viter les probl√®mes de permissions
echo -e "\n${YELLOW}[INFO] Backup dans: $BACKUP_DIR${NC}"
if ! mkdir -p "$BACKUP_DIR"; then
    echo -e "${RED}[ERREUR] Impossible de cr√©er le r√©pertoire de backup${NC}"
    exit 1
fi

# Test d'√©criture
if ! touch "$BACKUP_DIR/test" 2>/dev/null; then
    echo -e "${RED}[ERREUR] Pas de permissions d'√©criture dans $BACKUP_DIR${NC}"
    exit 1
fi
rm -f "$BACKUP_DIR/test"

# Arr√™t de Splunk
echo -e "${YELLOW}[1/6] Arr√™t de Splunk...${NC}"
if pgrep -f "splunkd" > /dev/null; then
    sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk stop 2>/dev/null || {
        echo -e "  ${YELLOW}‚ö†${NC} Arr√™t forc√© de Splunk..."
        pkill -9 splunkd
    }
    sleep 3
else
    echo -e "  ${YELLOW}‚ö†${NC} Splunk d√©j√† arr√™t√©"
fi

# Sauvegarde des configurations critiques
echo -e "${GREEN}[2/6] Sauvegarde des configurations...${NC}"

# Fonction de backup s√©curis√©e
backup_file() {
    local src="$1"
    local dest_dir="$2"
    
    if [ -f "$src" ]; then
        mkdir -p "$dest_dir"
        if cp -p "$src" "$dest_dir/" 2>/dev/null; then
            echo -e "  ${GREEN}‚úì${NC} $(basename "$src")"
            return 0
        else
            echo -e "  ${YELLOW}‚ö†${NC} √âchec copie $(basename "$src")"
            return 1
        fi
    fi
    return 1
}

backup_dir() {
    local src="$1"
    local dest="$2"
    
    if [ -d "$src" ]; then
        mkdir -p "$(dirname "$dest")"
        if cp -rp "$src" "$dest" 2>/dev/null; then
            echo -e "  ${GREEN}‚úì${NC} $(basename "$src")"
            return 0
        else
            echo -e "  ${YELLOW}‚ö†${NC} √âchec copie $(basename "$src")"
            return 1
        fi
    fi
    return 1
}

# Sauvegarde des fichiers de configuration syst√®me
echo -e "${BLUE}Configurations syst√®me:${NC}"
mkdir -p "$BACKUP_DIR/system/local"
backup_file "$SPLUNK_HOME/etc/system/local/outputs.conf" "$BACKUP_DIR/system/local"
backup_file "$SPLUNK_HOME/etc/system/local/inputs.conf" "$BACKUP_DIR/system/local"
backup_file "$SPLUNK_HOME/etc/system/local/web.conf" "$BACKUP_DIR/system/local"
backup_file "$SPLUNK_HOME/etc/system/local/server.conf" "$BACKUP_DIR/system/local"
backup_file "$SPLUNK_HOME/etc/system/local/indexes.conf" "$BACKUP_DIR/system/local"
backup_file "$SPLUNK_HOME/etc/system/local/user-seed.conf" "$BACKUP_DIR/system/local"
backup_file "$SPLUNK_HOME/etc/system/local/savedsearches.conf" "$BACKUP_DIR/system/local"
backup_file "$SPLUNK_HOME/etc/system/local/authentication.conf" "$BACKUP_DIR/system/local"

# Sauvegarde des apps et dashboards
echo -e "\n${BLUE}Applications et dashboards:${NC}"
if [ -d "$SPLUNK_HOME/etc/apps" ]; then
    mkdir -p "$BACKUP_DIR/apps"
    for app in "$SPLUNK_HOME/etc/apps"/*; do
        if [ -d "$app" ]; then
            app_name=$(basename "$app")
            # Exclure les apps syst√®me
            if [[ ! "$app_name" =~ ^(splunk_|launcher|learned|legacy|sample_app|search|gettingstarted|introspection) ]]; then
                backup_dir "$app" "$BACKUP_DIR/apps/$app_name"
            fi
        fi
    done
fi

# Sauvegarde deployment apps
echo -e "\n${BLUE}Deployment apps:${NC}"
backup_dir "$SPLUNK_HOME/etc/deployment-apps" "$BACKUP_DIR/deployment-apps"

# Sauvegarde auth
echo -e "\n${BLUE}Authentification:${NC}"
mkdir -p "$BACKUP_DIR/auth"
backup_file "$SPLUNK_HOME/etc/auth/splunk.secret" "$BACKUP_DIR/auth"
backup_file "$SPLUNK_HOME/etc/passwd" "$BACKUP_DIR"

# Cr√©ation inventaire
cat > "$BACKUP_DIR/INVENTORY.txt" <<EOF
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BACKUP SPLUNK - Lab Iron4Software
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Date: $(date '+%Y-%m-%d %H:%M:%S')
Hostname: $(hostname)
Splunk Home: $SPLUNK_HOME
Backup Dir: $BACKUP_DIR
EOF

find "$BACKUP_DIR" -type f >> "$BACKUP_DIR/INVENTORY.txt"
echo -e "  ${GREEN}‚úì${NC} Inventaire cr√©√©"

# Afficher taille du backup
BACKUP_SIZE=$(du -sh "$BACKUP_DIR" 2>/dev/null | cut -f1)
echo -e "\n${GREEN}Backup cr√©√©: $BACKUP_SIZE${NC}"

# Reset de la licence
echo -e "\n${GREEN}[3/6] Nettoyage de la licence expir√©e...${NC}"

# Suppression des fichiers de licence
find "$SPLUNK_HOME/etc/licenses" -name "*.lic" -delete 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} Fichiers .lic supprim√©s"
find "$SPLUNK_HOME/etc/licenses" -name "*.license" -delete 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} Fichiers .license supprim√©s"

# Suppression du GUID
if [ -f "$SPLUNK_HOME/etc/instance.cfg" ]; then
    rm -f "$SPLUNK_HOME/etc/instance.cfg"
    echo -e "  ${GREEN}‚úì${NC} GUID supprim√© (nouvelle √©valuation forc√©e)"
fi

# Nettoyage kvstore
if [ -d "$SPLUNK_HOME/var/lib/splunk/kvstore" ]; then
    rm -rf "$SPLUNK_HOME/var/lib/splunk/kvstore"/*
    echo -e "  ${GREEN}‚úì${NC} KVStore nettoy√©"
fi

# Nettoyage license pools
rm -rf "$SPLUNK_HOME/var/lib/splunk"/license* 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} License pools nettoy√©s"

# Restauration des configurations
echo -e "\n${GREEN}[4/6] Restauration des configurations...${NC}"

# Restauration system/local
if [ -d "$BACKUP_DIR/system/local" ]; then
    cp -rp "$BACKUP_DIR/system/local"/* "$SPLUNK_HOME/etc/system/local/" 2>/dev/null && \
        echo -e "  ${GREEN}‚úì${NC} Configurations syst√®me restaur√©es"
fi

# Restauration apps
if [ -d "$BACKUP_DIR/apps" ]; then
    for app in "$BACKUP_DIR/apps"/*; do
        if [ -d "$app" ]; then
            app_name=$(basename "$app")
            cp -rp "$app" "$SPLUNK_HOME/etc/apps/" 2>/dev/null && \
                echo -e "  ${GREEN}‚úì${NC} App restaur√©e: $app_name"
        fi
    done
fi

# Restauration deployment-apps
if [ -d "$BACKUP_DIR/deployment-apps" ]; then
    cp -rp "$BACKUP_DIR/deployment-apps" "$SPLUNK_HOME/etc/" 2>/dev/null && \
        echo -e "  ${GREEN}‚úì${NC} Deployment apps restaur√©es"
fi

# Restauration auth
if [ -d "$BACKUP_DIR/auth" ]; then
    cp -rp "$BACKUP_DIR/auth"/* "$SPLUNK_HOME/etc/auth/" 2>/dev/null && \
        echo -e "  ${GREEN}‚úì${NC} Authentification restaur√©e"
fi

# Restauration passwd
if [ -f "$BACKUP_DIR/passwd" ]; then
    cp -p "$BACKUP_DIR/passwd" "$SPLUNK_HOME/etc/" 2>/dev/null && \
        echo -e "  ${GREEN}‚úì${NC} Utilisateurs restaur√©s"
fi

# Permissions
echo -e "\n${GREEN}[5/6] Correction des permissions...${NC}"
chown -R $SPLUNK_USER:$SPLUNK_USER "$SPLUNK_HOME"
echo -e "  ${GREEN}‚úì${NC} Permissions corrig√©es"

# D√©marrage
echo -e "\n${GREEN}[6/6] D√©marrage de Splunk...${NC}"
echo -e "${YELLOW}Activation de la nouvelle licence d'√©valuation (60 jours)...${NC}\n"

# D√©marrage avec timeout
sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk start --accept-license --answer-yes --no-prompt &
SPLUNK_PID=$!

# Attendre max 30 secondes
echo -n "D√©marrage en cours"
for i in {1..30}; do
    if pgrep -f "splunkd" > /dev/null; then
        echo -e " ${GREEN}‚úì${NC}"
        break
    fi
    echo -n "."
    sleep 1
done

if ! pgrep -f "splunkd" > /dev/null; then
    echo -e " ${RED}‚úó${NC}"
    echo -e "${RED}√âchec du d√©marrage. V√©rifier les logs:${NC}"
    echo -e "${YELLOW}tail -f $SPLUNK_HOME/var/log/splunk/splunkd.log${NC}"
else
    echo -e "\n${GREEN}Splunk d√©marr√© avec succ√®s${NC}"
    
    # Attendre l'initialisation compl√®te
    sleep 10
    
    # V√©rification licence
    echo -e "\n${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${GREEN}Statut de la licence:${NC}"
    sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk list licenser-messages 2>/dev/null || \
        echo "Licence en cours d'initialisation (attendre 1-2 minutes)"
fi

echo -e "\n${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë         Reset Licence TERMIN√â !                 ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"

echo -e "\n${GREEN}‚úÖ Configuration pr√©serv√©e:${NC}"
echo -e "  ‚úì Forwarders (outputs.conf, inputs.conf)"
echo -e "  ‚úì Dashboards et apps"
echo -e "  ‚úì Utilisateurs et passwords"
echo -e "  ‚úì Recherches sauvegard√©es"

echo -e "\n${YELLOW}üìÅ Backup: $BACKUP_DIR${NC}"
echo -e "${YELLOW}üìä Taille: $BACKUP_SIZE${NC}"

# R√©cup√©rer l'IP
SERVER_IP=$(hostname -I | awk '{print $1}')
if [ -z "$SERVER_IP" ]; then
    SERVER_IP="localhost"
fi
echo -e "${YELLOW}üåê Interface: http://$SERVER_IP:8000${NC}"

# V√©rifications finales
echo -e "\n${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}V√©rifications:${NC}"

if pgrep -f "splunkd" > /dev/null; then
    echo -e "  ${GREEN}‚úì${NC} Splunkd actif"
else
    echo -e "  ${RED}‚úó${NC} Splunkd non d√©marr√©"
fi

if [ -f "$SPLUNK_HOME/etc/system/local/outputs.conf" ]; then
    echo -e "  ${GREEN}‚úì${NC} Configuration forwarders OK"
fi

if netstat -tuln 2>/dev/null | grep -q ":8000\|:9997"; then
    echo -e "  ${GREEN}‚úì${NC} Ports Splunk ouverts"
fi

echo -e "\n${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}üí° Solution permanente (recommand√©):${NC}"
echo -e "  1. T√©l√©charge licence Free: https://www.splunk.com/download"
echo -e "  2. Installe: sudo -u splunk $SPLUNK_HOME/bin/splunk add licenses /chemin/splunk.license"
echo -e "  3. Limite: 500 MB/jour (suffisant pour un lab)"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}\n"

echo -e "${GREEN}üéØ Next steps:${NC}"
echo -e "  1. Ouvre http://$SERVER_IP:8000 dans un navigateur"
echo -e "  2. V√©rifie les forwarders: Settings > Forwarding and receiving"
echo -e "  3. Teste une recherche: index=* | stats count"
echo -e ""
echo -e "${YELLOW}Note: Le backup peut √™tre supprim√© apr√®s v√©rification${NC}"
echo -e "${YELLOW}      rm -rf $BACKUP_DIR${NC}"
echo ""
