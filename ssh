#!/bin/bash

##############################################
# SSH VOLONTAIREMENT VULNÃ‰RABLE - VERSION 2
# Lab Iron4Software - Mail Server
# âš ï¸ ENVIRONNEMENT DE TEST UNIQUEMENT âš ï¸
##############################################

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  SSH VULNÃ‰RABLE - Lab Iron4Software V2"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âš ï¸  Configuration NON SÃ‰CURISÃ‰E - Lab uniquement"
echo ""

# VÃ©rifier root
if [ "$EUID" -ne 0 ]; then 
    echo "âŒ ExÃ©cuter en root: sudo bash $0"
    exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. INSTALLATION SSH
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[1/5] Installation SSH..."

apt update -qq
apt install -y openssh-server

systemctl enable ssh
systemctl start ssh

echo "âœ“ SSH installÃ©"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. CONFIGURATION VULNÃ‰RABLE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[2/5] Configuration volontairement vulnÃ©rable..."

# Backup
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%s)

# Config ultra-permissive
cat > /etc/ssh/sshd_config <<'EOF'
# SSH VULNÃ‰RABLE - Lab Iron4Software

Port 22
Protocol 2

# Authentification VULNÃ‰RABLE
PermitRootLogin yes
PasswordAuthentication yes
PermitEmptyPasswords no
PubkeyAuthentication yes
ChallengeResponseAuthentication no
UsePAM yes

# Aucune limite d'essais (brute-force possible)
MaxAuthTries 999
MaxSessions 50
LoginGraceTime 120

# Logs verbeux (pour analyse aprÃ¨s attaque)
SyslogFacility AUTH
LogLevel VERBOSE

# Forwarding activÃ©
X11Forwarding yes
AllowTcpForwarding yes
AllowAgentForwarding yes

# Pas de keepalive timeout (connexions longues possibles)
ClientAliveInterval 0
ClientAliveCountMax 3

# Banner lab
Banner /etc/ssh/banner-lab

# Accepter tous les environnements
AcceptEnv LANG LC_*

# SubsystÃ¨mes
Subsystem sftp /usr/lib/openssh/sftp-server
EOF

# Banner lab
cat > /etc/ssh/banner-lab <<'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAB IRON4SOFTWARE - MAIL SERVER
   
   âš ï¸  Configuration de test
   âš ï¸  Environnement vulnÃ©rable
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

chmod 644 /etc/ssh/banner-lab

echo "âœ“ Config SSH vulnÃ©rable appliquÃ©e"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. GESTION UTILISATEURS INTELLIGENTE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[3/5] Gestion des utilisateurs..."

# DÃ©finir utilisateurs et mots de passe
declare -A USERS
USERS[root]="toor"
USERS[pierre]="pierre123"
USERS[guillaume]="123"
USERS[admin]="admin"

echo ""
echo "â†’ DÃ©tection des utilisateurs existants"

# Traiter chaque utilisateur
for user in "${!USERS[@]}"; do
    password="${USERS[$user]}"
    
    if [ "$user" = "root" ]; then
        echo "  [root] Utilisateur systÃ¨me"
    else
        if id "$user" &>/dev/null 2>&1; then
            echo "  [âœ“] $user existe dÃ©jÃ "
        else
            echo "  [+] CrÃ©ation de $user..."
            useradd -m -s /bin/bash "$user" 2>/dev/null
            if [ $? -eq 0 ]; then
                echo "      â†’ Utilisateur crÃ©Ã©"
            else
                echo "      â†’ ERREUR crÃ©ation"
                continue
            fi
        fi
        
        # VÃ©rifier le home directory
        if [ ! -d "/home/$user" ]; then
            echo "      â†’ CrÃ©ation home directory"
            mkdir -p "/home/$user"
            chown "$user":"$user" "/home/$user"
            chmod 755 "/home/$user"
        fi
    fi
done

echo ""
echo "â†’ Configuration des mots de passe (PAM)"

# Configurer tous les mots de passe
for user in "${!USERS[@]}"; do
    password="${USERS[$user]}"
    
    # Chpasswd utilise PAM automatiquement
    echo "$user:$password" | chpasswd 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "  [âœ“] $user â†’ '$password'"
    else
        echo "  [âœ—] $user â†’ Ã‰CHEC"
    fi
done

echo ""
echo "â†’ VÃ©rification finale des utilisateurs"

for user in "${!USERS[@]}"; do
    if [ "$user" = "root" ]; then
        echo "  [âœ“] root â†’ actif"
    elif id "$user" &>/dev/null 2>&1; then
        HOME_DIR=$(eval echo ~$user)
        if [ -d "$HOME_DIR" ]; then
            echo "  [âœ“] $user â†’ actif (home: $HOME_DIR)"
        else
            echo "  [âš ] $user â†’ actif (MAIS home manquant)"
        fi
    else
        echo "  [âœ—] $user â†’ MANQUANT!"
    fi
done

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. CONFIGURATION PAM
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[4/5] Configuration PAM..."

# VÃ©rifier /etc/pam.d/sshd
if [ -f /etc/pam.d/sshd ]; then
    echo "  [âœ“] /etc/pam.d/sshd existe"
    
    # S'assurer que common-auth est inclus
    if ! grep -q "^@include common-auth" /etc/pam.d/sshd; then
        echo "  [+] Ajout @include common-auth"
        sed -i '1i @include common-auth' /etc/pam.d/sshd
    else
        echo "  [âœ“] common-auth dÃ©jÃ  inclus"
    fi
else
    echo "  [âš ] /etc/pam.d/sshd manquant (crÃ©ation)"
    cat > /etc/pam.d/sshd <<'PAMEOF'
@include common-auth
@include common-account
@include common-session
@include common-password
PAMEOF
fi

# VÃ©rifier common-auth
if [ -f /etc/pam.d/common-auth ]; then
    if grep -q "pam_unix.so" /etc/pam.d/common-auth; then
        echo "  [âœ“] pam_unix.so actif"
    else
        echo "  [+] Configuration pam_unix.so"
        echo "auth    required    pam_unix.so nullok_secure" >> /etc/pam.d/common-auth
    fi
else
    echo "  [!] /etc/pam.d/common-auth manquant - systÃ¨me non-standard"
fi

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. DÃ‰SACTIVATION PROTECTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[5/5] DÃ©sactivation protections..."

# Fail2Ban
if systemctl is-active --quiet fail2ban 2>/dev/null; then
    systemctl stop fail2ban
    systemctl disable fail2ban
    echo "  [âœ“] Fail2Ban dÃ©sactivÃ©"
else
    echo "  [Â·] Fail2Ban non installÃ©"
fi

# Firewall UFW
if command -v ufw &> /dev/null; then
    ufw disable 2>/dev/null
    echo "  [âœ“] UFW dÃ©sactivÃ©"
else
    echo "  [Â·] UFW non installÃ©"
fi

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# REDÃ‰MARRAGE SSH
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "â†’ RedÃ©marrage SSH..."

systemctl restart ssh

sleep 2

if systemctl is-active --quiet ssh; then
    echo "  [âœ“] SSH actif"
    
    # VÃ©rifier le port
    if netstat -tuln 2>/dev/null | grep -q ":22 " || ss -tuln 2>/dev/null | grep -q ":22 "; then
        echo "  [âœ“] Port 22 en Ã©coute"
    else
        echo "  [âš ] Port 22 pas dÃ©tectÃ©"
    fi
else
    echo "  [âœ—] SSH INACTIF - Restauration backup"
    mv /etc/ssh/sshd_config.backup.* /etc/ssh/sshd_config 2>/dev/null
    systemctl restart ssh
    exit 1
fi

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEST AUTOMATIQUE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "â†’ Test automatique SSH local..."

# Tester avec pierre
TESTUSER="pierre"
TESTPASS="pierre123"

if id "$TESTUSER" &>/dev/null; then
    # Test avec sshpass si disponible
    if command -v sshpass &> /dev/null; then
        if sshpass -p "$TESTPASS" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$TESTUSER@localhost" "echo OK" 2>/dev/null | grep -q "OK"; then
            echo "  [âœ“] Test SSH pierre@localhost â†’ SUCCÃˆS"
        else
            echo "  [âš ] Test SSH pierre@localhost â†’ Ã‰CHEC"
        fi
    else
        echo "  [Â·] sshpass non installÃ© (test manuel requis)"
    fi
fi

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰SUMÃ‰ FINAL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IP=$(hostname -I | awk '{print $1}')
HOSTNAME=$(hostname -f 2>/dev/null || hostname)

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ“âœ“âœ“ CONFIGURATION TERMINÃ‰E"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“¡ INFORMATIONS SERVEUR"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Hostname: $HOSTNAME"
echo "IP:       $IP"
echo "Port SSH: 22"
echo ""
echo "ğŸ“ COMPTES CONFIGURÃ‰S"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
for user in "${!USERS[@]}"; do
    password="${USERS[$user]}"
    if [ "$user" = "root" ]; then
        printf "%-12s : %-15s [SYSTÃˆME]\n" "$user" "$password"
    elif id "$user" &>/dev/null 2>&1; then
        printf "%-12s : %-15s [OK]\n" "$user" "$password"
    else
        printf "%-12s : %-15s [ERREUR]\n" "$user" "$password"
    fi
done
echo ""
echo "âš ï¸  VULNÃ‰RABILITÃ‰S ACTIVES"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "âŒ Root login SSH activÃ©"
echo "âŒ Mots de passe ultra-faibles"
echo "âŒ 999 tentatives max (brute-force facile)"
echo "âŒ Fail2Ban dÃ©sactivÃ©"
echo "âŒ Forwarding activÃ©"
echo "âœ“ Logs verbeux â†’ /var/log/auth.log"
echo ""
echo "ğŸ”¨ TESTS D'ATTAQUE"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "1. Connexion directe depuis Kali:"
echo "   ssh pierre@$IP"
echo "   Password: pierre123"
echo ""
echo "   ssh guillaume@$IP"
echo "   Password: 123"
echo ""
echo "   ssh root@$IP"
echo "   Password: toor"
echo ""
echo "2. Brute-force avec Hydra:"
echo "   hydra -l pierre -P /usr/share/wordlists/rockyou.txt ssh://$IP"
echo "   hydra -l guillaume -p 123 ssh://$IP"
echo ""
echo "3. Metasploit:"
echo "   use auxiliary/scanner/ssh/ssh_login"
echo "   set RHOSTS $IP"
echo "   set USERNAME pierre"
echo "   set PASSWORD pierre123"
echo "   run"
echo ""
echo "ğŸ“Š MONITORING"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Tentatives en temps rÃ©el:"
echo "  tail -f /var/log/auth.log | grep sshd"
echo ""
echo "Ã‰checs:"
echo "  grep 'Failed password' /var/log/auth.log"
echo ""
echo "SuccÃ¨s:"
echo "  grep 'Accepted password' /var/log/auth.log"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âš ï¸  Configuration vulnÃ©rable pour LAB uniquement"
echo "    Ne JAMAIS utiliser en production!"
echo ""
