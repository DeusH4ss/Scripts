#!/bin/bash

##############################################
# SSH VOLONTAIREMENT VULNÃ‰RABLE
# Lab Iron4Software - Mail Server
# âš ï¸ ENVIRONNEMENT DE TEST UNIQUEMENT âš ï¸
##############################################

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  SSH VULNÃ‰RABLE - Lab Iron4Software"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âš ï¸  Configuration NON SÃ‰CURISÃ‰E - Lab uniquement"
echo ""

# VÃ©rifier root
if [ "$EUID" -ne 0 ]; then 
    echo "âŒ ExÃ©cuter en root"
    exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. INSTALLATION SSH
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[1/4] Installation SSH..."

apt update -qq
apt install -y openssh-server

systemctl enable ssh
systemctl start ssh

echo "âœ“ SSH installÃ©"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. CONFIGURATION VULNÃ‰RABLE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[2/4] Configuration volontairement vulnÃ©rable..."

# Backup
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup

# Config ultra-permissive
cat > /etc/ssh/sshd_config <<'EOF'
# SSH VULNÃ‰RABLE - Lab Iron4Software

Port 22
Protocol 2

# Authentification VULNÃ‰RABLE
PermitRootLogin yes
PasswordAuthentication yes
PermitEmptyPasswords no
PubkeyAuthentication yes

# Aucune limite d'essais (brute-force possible)
MaxAuthTries 999
MaxSessions 50
LoginGraceTime 120

# Logs verbeux (pour analyse aprÃ¨s attaque)
SyslogFacility AUTH
LogLevel VERBOSE

# Forwarding activÃ©
X11Forwarding yes
AllowTcpForwarding yes
AllowAgentForwarding yes

# Pas de keepalive timeout (connexions longues possibles)
ClientAliveInterval 0
ClientAliveCountMax 3

# Banner lab
Banner /etc/ssh/banner-lab
EOF

# Banner lab
cat > /etc/ssh/banner-lab <<'EOF'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAB IRON4SOFTWARE - MAIL SERVER
   
   âš ï¸  Configuration de test
   âš ï¸  Environnement vulnÃ©rable
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

chmod 644 /etc/ssh/banner-lab

echo "âœ“ Config vulnÃ©rable appliquÃ©e"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. MOTS DE PASSE FAIBLES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[3/4] Configuration utilisateurs avec mots de passe faibles..."

# CrÃ©er/modifier utilisateurs avec mots de passe simples
declare -A USERS
USERS[root]="toor"
USERS[pierre]="pierre123"
USERS[guillaume]="123"
USERS[admin]="admin"

for user in "${!USERS[@]}"; do
    password="${USERS[$user]}"
    
    if [ "$user" = "root" ]; then
        echo "root:$password" | chpasswd
        echo "  âœ“ root:$password"
    else
        # CrÃ©er user si existe pas
        if ! id "$user" &>/dev/null; then
            useradd -m -s /bin/bash "$user"
        fi
        echo "$user:$password" | chpasswd
        echo "  âœ“ $user:$password"
    fi
done

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. DÃ‰SACTIVER FAIL2BAN (si prÃ©sent)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo "[4/4] DÃ©sactivation protections..."

if systemctl is-active --quiet fail2ban; then
    systemctl stop fail2ban
    systemctl disable fail2ban
    echo "âœ“ Fail2Ban dÃ©sactivÃ©"
fi

# DÃ©sactiver firewall local si prÃ©sent
if command -v ufw &> /dev/null; then
    ufw disable 2>/dev/null
    echo "âœ“ UFW dÃ©sactivÃ©"
fi

echo ""

# RedÃ©marrer SSH
echo "RedÃ©marrage SSH..."
systemctl restart ssh

if systemctl is-active --quiet ssh; then
    echo "âœ“ SSH redÃ©marrÃ©"
else
    echo "âŒ Erreur SSH"
    exit 1
fi

echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰SUMÃ‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IP=$(hostname -I | awk '{print $1}')

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ“ CONFIGURATION VULNÃ‰RABLE ACTIVE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ¯ CIBLES SSH"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "IP: $IP"
echo "Port: 22"
echo ""
echo "ğŸ“ COMPTES VULNÃ‰RABLES"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
for user in "${!USERS[@]}"; do
    echo "  $user : ${USERS[$user]}"
done
echo ""
echo "âš ï¸  VULNÃ‰RABILITÃ‰S ACTIVES"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "âŒ Root login SSH activÃ©"
echo "âŒ Mots de passe faibles"
echo "âŒ Pas de limite de tentatives"
echo "âŒ Fail2Ban dÃ©sactivÃ©"
echo "âŒ Forwarding activÃ©"
echo "âœ“ Logs verbeux (pour analyse)"
echo ""
echo "ğŸ”¨ TESTS D'ATTAQUE POSSIBLES"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "1. Brute-force depuis Kali:"
echo "   hydra -l root -P /usr/share/wordlists/rockyou.txt ssh://$IP"
echo "   hydra -L users.txt -P pass.txt ssh://$IP"
echo ""
echo "2. Connexion directe root:"
echo "   ssh root@$IP"
echo "   Password: toor"
echo ""
echo "3. Connexion utilisateurs:"
echo "   ssh pierre@$IP (Password: pierre123)"
echo "   ssh admin@$IP (Password: admin)"
echo ""
echo "4. Test avec Metasploit:"
echo "   use auxiliary/scanner/ssh/ssh_login"
echo "   set RHOSTS $IP"
echo "   set USERNAME root"
echo "   set PASS_FILE /usr/share/wordlists/metasploit/common_passwords.txt"
echo "   run"
echo ""
echo "ğŸ“Š MONITORING DES ATTAQUES"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "Voir tentatives en temps rÃ©el:"
echo "  sudo tail -f /var/log/auth.log | grep sshd"
echo ""
echo "Voir Ã©checs:"
echo "  sudo grep 'Failed password' /var/log/auth.log"
echo ""
echo "Voir connexions rÃ©ussies:"
echo "  sudo grep 'Accepted password' /var/log/auth.log"
echo ""
echo "Compter tentatives:"
echo "  sudo grep 'Failed password' /var/log/auth.log | wc -l"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âš ï¸  RAPPEL: Configuration de TEST uniquement"
echo "    RÃ©seau isolÃ© Iron4Software"
echo ""
