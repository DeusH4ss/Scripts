#!/bin/bash

# Script de d√©pannage Splunk - Force le d√©marrage
# Lab Iron4Software

SPLUNK_HOME="/opt/splunk"
SPLUNK_USER="splunk"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë  D√©pannage D√©marrage Splunk            ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"

# V√©rification sudo
if [ "$EUID" -ne 0 ]; then 
   echo -e "${RED}Ex√©cute avec sudo: sudo bash $0${NC}"
   exit 1
fi

echo -e "${YELLOW}[1/5] Arr√™t forc√© de tous les processus Splunk...${NC}"

# Kill tous les processus splunk
pkill -9 splunkd 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} splunkd arr√™t√©"
pkill -9 mongod 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} mongod arr√™t√©"
pkill -9 splunk-optimize 2>/dev/null
pkill -9 splunk 2>/dev/null

# Attendre que tout soit bien arr√™t√©
sleep 3

# V√©rifier qu'il ne reste rien
if pgrep -f splunk > /dev/null; then
    echo -e "  ${RED}‚úó${NC} Certains processus r√©sistent, second passage..."
    pkill -9 -f splunk
    sleep 2
fi

if ! pgrep -f splunk > /dev/null; then
    echo -e "  ${GREEN}‚úì${NC} Tous les processus Splunk sont arr√™t√©s"
else
    echo -e "  ${RED}‚úó${NC} Processus restants:"
    ps aux | grep splunk | grep -v grep
fi

echo -e "\n${YELLOW}[2/5] Nettoyage des fichiers PID et locks...${NC}"

# Supprimer les fichiers PID
rm -f $SPLUNK_HOME/var/run/splunk/*.pid 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} Fichiers .pid supprim√©s"
rm -f $SPLUNK_HOME/var/run/splunk/*.lock 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} Fichiers .lock supprim√©s"

# Nettoyer les sockets
rm -f $SPLUNK_HOME/var/run/splunk/*.sock 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} Sockets nettoy√©s"

# Nettoyer cache MongoDB
rm -rf $SPLUNK_HOME/var/lib/splunk/kvstore/mongo/*.lock 2>/dev/null && echo -e "  ${GREEN}‚úì${NC} Locks MongoDB nettoy√©s"

echo -e "\n${YELLOW}[3/5] V√©rification et correction des permissions...${NC}"

# Permissions Splunk
chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME
echo -e "  ${GREEN}‚úì${NC} Propri√©taire corrig√©"

# Permissions sp√©cifiques
chmod -R u+rwX,go+rX $SPLUNK_HOME
chmod +x $SPLUNK_HOME/bin/splunk
echo -e "  ${GREEN}‚úì${NC} Permissions des ex√©cutables OK"

# R√©pertoires critiques
mkdir -p $SPLUNK_HOME/var/run/splunk
mkdir -p $SPLUNK_HOME/var/lib/splunk
chown -R $SPLUNK_USER:$SPLUNK_USER $SPLUNK_HOME/var
echo -e "  ${GREEN}‚úì${NC} R√©pertoires runtime cr√©√©s"

echo -e "\n${YELLOW}[4/5] V√©rification de la configuration...${NC}"

# V√©rifier que les fichiers de config essentiels existent
if [ -f "$SPLUNK_HOME/etc/system/local/outputs.conf" ]; then
    echo -e "  ${GREEN}‚úì${NC} outputs.conf pr√©sent"
else
    echo -e "  ${YELLOW}‚ö†${NC} outputs.conf absent"
fi

if [ -f "$SPLUNK_HOME/etc/splunk-launch.conf" ]; then
    echo -e "  ${GREEN}‚úì${NC} splunk-launch.conf pr√©sent"
else
    echo -e "  ${RED}‚úó${NC} splunk-launch.conf manquant (critique)"
fi

echo -e "\n${YELLOW}[5/5] D√©marrage de Splunk...${NC}"

# D√©marrage avec l'utilisateur splunk
echo -e "${BLUE}Lancement en cours...${NC}\n"

sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk start --accept-license --answer-yes --no-prompt 2>&1 | tee /tmp/splunk_start.log

# Attendre le d√©marrage
echo -e "\n${YELLOW}Attente du d√©marrage complet...${NC}"
sleep 5

# V√©rification
echo -e "\n${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${GREEN}V√©rification du statut:${NC}\n"

if pgrep -f "splunkd" > /dev/null; then
    echo -e "  ${GREEN}‚úì Splunkd est d√©marr√©${NC}"
    
    # V√©rifier les ports
    if netstat -tuln 2>/dev/null | grep -q ":8000"; then
        echo -e "  ${GREEN}‚úì Port Web (8000) ouvert${NC}"
    else
        echo -e "  ${YELLOW}‚ö† Port 8000 pas encore ouvert (d√©marrage en cours)${NC}"
    fi
    
    if netstat -tuln 2>/dev/null | grep -q ":8089"; then
        echo -e "  ${GREEN}‚úì Port Management (8089) ouvert${NC}"
    fi
    
    if netstat -tuln 2>/dev/null | grep -q ":9997"; then
        echo -e "  ${GREEN}‚úì Port Forwarder (9997) ouvert${NC}"
    else
        echo -e "  ${YELLOW}‚ö† Port 9997 pas ouvert (normal si pas configur√© comme receiver)${NC}"
    fi
    
    echo -e "\n${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë    Splunk d√©marr√© avec SUCC√àS !        ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    
    SERVER_IP=$(hostname -I | awk '{print $1}')
    echo -e "\n${YELLOW}üåê Interface Web: ${GREEN}http://$SERVER_IP:8000${NC}"
    echo -e "${YELLOW}üìä Statut: ${GREEN}sudo -u splunk $SPLUNK_HOME/bin/splunk status${NC}"
    
    # Afficher la licence
    echo -e "\n${BLUE}V√©rification de la licence dans 10 secondes...${NC}"
    sleep 10
    sudo -u $SPLUNK_USER $SPLUNK_HOME/bin/splunk list licenser-messages 2>/dev/null || echo "Licence en cours d'initialisation"
    
else
    echo -e "  ${RED}‚úó Splunkd n'est pas d√©marr√©${NC}\n"
    echo -e "${RED}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${RED}‚ïë    √âCHEC du d√©marrage                  ‚ïë${NC}"
    echo -e "${RED}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
    
    echo -e "${YELLOW}üìã Derni√®res lignes du log:${NC}"
    tail -30 $SPLUNK_HOME/var/log/splunk/splunkd.log 2>/dev/null || echo "Log non accessible"
    
    echo -e "\n${YELLOW}üí° Actions de d√©pannage:${NC}"
    echo -e "  1. V√©rifier les logs complets:"
    echo -e "     ${BLUE}tail -f $SPLUNK_HOME/var/log/splunk/splunkd.log${NC}"
    echo -e "  2. Essayer de d√©marrer en debug:"
    echo -e "     ${BLUE}sudo -u splunk $SPLUNK_HOME/bin/splunk start --debug${NC}"
    echo -e "  3. V√©rifier l'espace disque:"
    echo -e "     ${BLUE}df -h${NC}"
    echo -e "  4. Si √ßa persiste, r√©installation propre n√©cessaire"
fi

echo ""
